<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MathApp - Êï∞Â≠¶Â≠¶Áøí</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a26;
            --bg-card-hover: #22222f;
            --accent: #6c63ff;
            --accent-glow: rgba(108, 99, 255, 0.3);
            --accent-soft: rgba(108, 99, 255, 0.12);
            --success: #2dd4a8;
            --success-soft: rgba(45, 212, 168, 0.12);
            --error: #ff6b6b;
            --error-soft: rgba(255, 107, 107, 0.12);
            --warning: #ffc857;
            --warning-soft: rgba(255, 200, 87, 0.12);
            --text-primary: #e8e6f0;
            --text-secondary: #8a879a;
            --text-muted: #5a576b;
            --border: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(108, 99, 255, 0.3);
            --radius: 16px;
            --radius-sm: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: ''; position: fixed; inset: 0;
            background: linear-gradient(rgba(108,99,255,0.03) 1px,transparent 1px),
                        linear-gradient(90deg,rgba(108,99,255,0.03) 1px,transparent 1px);
            background-size: 60px 60px; pointer-events: none; z-index: 0;
        }
        .header {
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(20px); background: rgba(10,10,15,0.8);
            border-bottom: 1px solid var(--border); padding: 16px 24px;
        }
        .header-inner {
            max-width: 800px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            border-radius: 10px; display: flex; align-items: center;
            justify-content: center; font-size: 18px; font-weight: 900; color: white;
        }
        .logo-text { font-weight: 700; font-size: 18px; letter-spacing: -0.5px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .badge {
            font-size: 11px; font-weight: 500; color: var(--accent);
            background: var(--accent-soft); padding: 4px 10px;
            border-radius: 20px; border: 1px solid var(--border-accent);
        }
        .settings-btn {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
            background: transparent; color: var(--text-secondary); cursor: pointer;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .settings-btn:hover { background: var(--bg-card); color: var(--text-primary); }
        .main {
            position: relative; z-index: 1;
            max-width: 800px; margin: 0 auto; padding: 32px 24px 100px;
        }

        /* API Key - collapsible */
        .api-key-section {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 24px; overflow: hidden;
        }
        .api-key-header {
            padding: 14px 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            font-size: 13px; font-weight: 500; color: var(--text-secondary);
        }
        .api-key-header:hover { color: var(--text-primary); }
        .api-key-arrow { transition: transform 0.3s; }
        .api-key-section.open .api-key-arrow { transform: rotate(180deg); }
        .api-key-body { display: none; padding: 0 20px 16px; }
        .api-key-section.open .api-key-body { display: block; }
        .api-key-row { display: flex; gap: 8px; }
        .api-key-input {
            flex: 1; padding: 10px 14px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
            font-size: 13px; outline: none;
        }
        .api-key-input:focus { border-color: var(--accent); }
        .api-key-save {
            padding: 10px 18px; border-radius: var(--radius-sm);
            border: 1px solid var(--border-accent); background: var(--accent-soft);
            color: var(--accent); font-family: inherit; font-size: 13px;
            font-weight: 600; cursor: pointer;
        }
        .api-key-save:hover { background: var(--accent); color: white; }
        .api-key-status { font-size: 12px; margin-top: 8px; color: var(--text-muted); }
        .api-key-status.saved { color: var(--success); }

        /* Upload */
        .upload-area {
            border: 2px dashed var(--border); border-radius: var(--radius);
            padding: 48px 24px; text-align: center; cursor: pointer;
            transition: all 0.3s; background: var(--bg-secondary); position: relative;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent); background: rgba(108,99,255,0.05);
        }
        .upload-area.has-image { padding: 16px; border-style: solid; border-color: var(--border-accent); }
        .upload-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
        .upload-title { font-size: 16px; font-weight: 500; margin-bottom: 8px; }
        .upload-subtitle { font-size: 13px; color: var(--text-secondary); }
        .upload-actions { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
        .upload-btn {
            padding: 10px 20px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-primary); font-family: inherit; font-size: 13px;
            font-weight: 500; cursor: pointer; display: flex; align-items: center;
            gap: 6px; transition: all 0.2s;
        }
        .upload-btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }
        .preview-container { position: relative; display: none; }
        .preview-container.visible { display: block; }
        .preview-img { max-width: 100%; max-height: 400px; border-radius: var(--radius-sm); display: block; margin: 0 auto; }
        .preview-remove {
            position: absolute; top: 8px; right: 8px;
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: rgba(0,0,0,0.7); color: white; cursor: pointer;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
        }
        #fileInput, #cameraInput { display: none; }

        /* Analyze button */
        .analyze-section { margin-top: 24px; }
        .analyze-btn {
            width: 100%; padding: 16px 32px; border: none; border-radius: var(--radius);
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white; font-family: inherit; font-size: 16px; font-weight: 700;
            cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;
        }
        .analyze-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
        .analyze-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .analyze-btn.loading { pointer-events: none; }
        .analyze-btn.loading .btn-text { opacity: 0; }
        .spinner { display: none; position: absolute; inset: 0; align-items: center; justify-content: center; }
        .loading .spinner { display: flex; }
        .spinner-dot {
            width: 8px; height: 8px; border-radius: 50%; background: white;
            margin: 0 4px; animation: bounce 1.4s infinite ease-in-out both;
        }
        .spinner-dot:nth-child(1) { animation-delay: -0.32s; }
        .spinner-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%,80%,100%{transform:scale(0)} 40%{transform:scale(1)} }

        /* ‚îÄ‚îÄ Score Display ‚îÄ‚îÄ */
        .score-display {
            text-align: center; padding: 32px 24px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 16px;
            animation: fadeInUp 0.4s ease;
        }
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 16px; position: relative;
        }
        .score-circle::before {
            content: ''; position: absolute; inset: 0;
            border-radius: 50%; border: 6px solid var(--border);
        }
        .score-circle::after {
            content: ''; position: absolute; inset: 0;
            border-radius: 50%; border: 6px solid transparent;
            border-top-color: var(--accent);
            animation: spin-in 0.6s ease-out;
        }
        .score-circle.perfect::after { border-color: var(--success); }
        .score-circle.good::after { border-top-color: var(--success); border-right-color: var(--success); }
        .score-circle.mid::after { border-top-color: var(--warning); border-right-color: var(--warning); }
        .score-circle.low::after { border-top-color: var(--error); }
        @keyframes spin-in { from { transform: rotate(-90deg); opacity: 0; } to { transform: rotate(0); opacity: 1; } }

        .score-number { font-size: 36px; font-weight: 900; line-height: 1; }
        .score-max { font-size: 14px; color: var(--text-secondary); font-weight: 400; }
        .score-message { font-size: 15px; font-weight: 500; margin-top: 4px; }
        .score-message.perfect { color: var(--success); }
        .score-message.good { color: var(--success); }
        .score-message.mid { color: var(--warning); }
        .score-message.low { color: var(--error); }

        /* Results cards */
        .results-section { margin-top: 32px; display: none; }
        .results-section.visible { display: block; }
        .result-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; margin-bottom: 16px;
            animation: fadeInUp 0.4s ease;
        }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
        .result-title {
            font-size: 13px; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .math-block {
            background: rgba(0,0,0,0.3); border-radius: var(--radius-sm);
            padding: 16px; margin: 8px 0; text-align: center;
            border: 1px solid var(--border); overflow-x: auto; font-size: 1.2em;
        }
        .math-block .katex-display { margin: 0; }
        .mixed-text { line-height: 1.9; font-size: 14px; }
        .mixed-text .katex { font-size: 1.1em; }

        /* Formula box */
        .formula-box {
            background: rgba(108,99,255,0.06); border: 1px solid var(--border-accent);
            border-radius: var(--radius-sm); padding: 16px; margin-top: 12px;
        }
        .formula-box-title {
            font-size: 12px; font-weight: 600; color: var(--accent);
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
        }
        .formula-item {
            padding: 8px 0; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 4px;
        }
        .formula-item:last-child { border-bottom: none; }
        .formula-name { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .formula-expr { font-size: 1.1em; padding: 6px 0; }

        /* ‚îÄ‚îÄ Unit Tags ‚îÄ‚îÄ */
        .unit-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; margin-bottom: 16px;
            animation: fadeInUp 0.5s ease;
        }
        .unit-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 4px; }
        .unit-tag {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: 1px solid;
        }
        .unit-tag.math1a { background: rgba(99,179,237,0.1); color: #63b3ed; border-color: rgba(99,179,237,0.3); }
        .unit-tag.math1a:hover { background: rgba(99,179,237,0.2); transform: translateY(-1px); }
        .unit-tag.math2b { background: rgba(129,230,217,0.1); color: #81e6d9; border-color: rgba(129,230,217,0.3); }
        .unit-tag.math2b:hover { background: rgba(129,230,217,0.2); transform: translateY(-1px); }
        .unit-tag.math3c { background: rgba(183,148,244,0.1); color: #b794f4; border-color: rgba(183,148,244,0.3); }
        .unit-tag.math3c:hover { background: rgba(183,148,244,0.2); transform: translateY(-1px); }
        .unit-tag-arrow { font-size: 11px; opacity: 0.6; }

        /* ‚îÄ‚îÄ Learning Panel ‚îÄ‚îÄ */
        .learning-overlay {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease;
        }
        .learning-overlay.visible { display: flex; align-items: flex-end; justify-content: center; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        .learning-panel {
            width: 100%; max-width: 800px; max-height: 85vh;
            background: var(--bg-primary); border-radius: var(--radius) var(--radius) 0 0;
            overflow-y: auto; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

        .learning-header {
            position: sticky; top: 0; z-index: 10;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;
        }
        .learning-title { font-size: 16px; font-weight: 700; }
        .learning-close {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
            background: transparent; color: var(--text-secondary); cursor: pointer;
            font-size: 18px; display: flex; align-items: center; justify-content: center;
        }
        .learning-close:hover { background: var(--bg-card); color: var(--text-primary); }
        .learning-body { padding: 24px; }
        .learning-loading { text-align: center; padding: 60px 0; color: var(--text-secondary); }

        .hint-card {
            background: var(--warning-soft); border: 1px solid rgba(255,200,87,0.2);
            border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
        }
        .error-card {
            background: var(--error-soft); border: 1px solid rgba(255,107,107,0.2);
            border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
        }
        .error-card .result-title { color: var(--error); }

        .step-list { list-style: none; margin-top: 12px; }
        .step-item {
            padding: 16px; border-left: 3px solid var(--accent);
            margin-bottom: 12px; background: rgba(108,99,255,0.04);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .step-number {
            font-size: 11px; font-weight: 700; color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
        }
        .step-desc { font-size: 14px; line-height: 1.8; margin-bottom: 8px; }
        .step-math {
            font-size: 1.1em; color: var(--accent); background: rgba(0,0,0,0.2);
            padding: 10px 14px; border-radius: 6px; display: inline-block; margin-top: 4px;
        }

        .meta-bar {
            display: flex; gap: 20px; margin-top: 16px;
            padding-top: 16px; border-top: 1px solid var(--border);
        }
        .meta-item { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .meta-label { color: var(--text-secondary); }


        /* ‚ïê‚ïê‚ïê Screen Navigation (Global) ‚ïê‚ïê‚ïê */
        .screen { display: none; }
        .screen.active { display: block; }
        .nav-bar {
            display: flex; align-items: center; gap: 12px; padding: 12px 20px;
            border-bottom: 1px solid var(--border);
        }
        .nav-back {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
            color: var(--text-primary); padding: 8px 14px; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; font-family: inherit;
        }
        .nav-back:hover { background: var(--bg-card-hover); }
        .nav-title { font-size: 16px; font-weight: 700; }
        .nav-subtitle { font-size: 12px; color: var(--text-secondary); }
        /* Subject Tabs */
        .subject-tabs {
            display: flex; gap: 8px; padding: 16px 20px 8px; overflow-x: auto;
            -webkit-overflow-scrolling: touch; max-width: 800px; margin: 0 auto;
        }
        .subject-tab {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary);
            cursor: pointer; white-space: nowrap; transition: 0.2s; font-family: inherit;
        }
        .subject-tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .subject-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        /* Unit Grid */
        .unit-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            padding: 12px 20px 100px; max-width: 800px; margin: 0 auto;
        }
        .unit-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .unit-card:hover { border-color: var(--border-accent); transform: translateY(-2px); }
        .unit-card-subject { font-size: 11px; font-weight: 600; opacity: 0.7; margin-bottom: 6px; }
        .unit-card-name { font-size: 14px; font-weight: 700; margin-bottom: 8px; line-height: 1.4; }
        .unit-card-meta { font-size: 11px; color: var(--text-muted); }
        .unit-card.math1a { border-left: 3px solid #6c63ff; }
        .unit-card.math2b { border-left: 3px solid #2dd4a8; }
        .unit-card.math3c { border-left: 3px solid #ff6b9d; }
        .unit-card-subject.math1a { color: #6c63ff; }
        .unit-card-subject.math2b { color: #2dd4a8; }
        .unit-card-subject.math3c { color: #ff6b9d; }
        /* Sub-unit List */
        .subunit-section { padding: 0 20px 16px; max-width: 800px; margin: 0 auto; }
        .subunit-group { margin-bottom: 20px; }
        .subunit-group-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px; }
        .subunit-item {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
            padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .subunit-item:hover { border-color: var(--border-accent); }
        .subunit-name { font-size: 14px; font-weight: 500; }
        .subunit-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .subunit-arrow { color: var(--text-muted); font-size: 18px; }
        /* Problem List */
        .problem-list { padding: 0 20px 20px; }
        .problem-item {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
            padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .problem-item:hover { border-color: var(--border-accent); }
        .problem-title { font-size: 14px; font-weight: 500; }
        .diff-badge {
            font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px;
        }
        .diff-badge.basic { background: var(--success-soft); color: var(--success); }
        .diff-badge.standard { background: var(--warning-soft); color: var(--warning); }
        .diff-badge.advanced { background: var(--error-soft); color: var(--error); }
        /* Problem Display */
        .problem-display {
            background: var(--bg-card); border: 1px solid var(--border-accent); border-radius: var(--radius);
            padding: 24px; margin: 16px 20px; max-width: 800px;
        }
        .problem-display-title { font-size: 13px; color: var(--accent); font-weight: 600; margin-bottom: 12px; }
        .problem-display-text { font-size: 16px; line-height: 1.8; }
        .problem-display-hint {
            margin-top: 16px; padding: 12px; background: var(--warning-soft);
            border-radius: var(--radius-sm); font-size: 13px; color: var(--warning);
            cursor: pointer;
        }
        .problem-display-hint.revealed { cursor: default; }
        .free-mode-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin: 0 20px 16px; padding: 14px; border-radius: var(--radius);
            background: var(--bg-card); border: 1px dashed var(--border);
            color: var(--text-secondary); font-size: 14px; cursor: pointer; transition: 0.2s;
            max-width: 800px;
        }
        .free-mode-btn:hover { border-color: var(--accent); color: var(--accent); }
        .overview-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px 20px; margin: 12px 20px; max-width: 800px;
        }
        .overview-card p { font-size: 14px; line-height: 1.7; color: var(--text-secondary); }
        .empty-state {
            text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px;
        }

        /* ‚ïê‚ïê‚ïê Answer Area (SELECTÁ≥ª UI) ‚ïê‚ïê‚ïê */
        .answer-area {
            max-width: 800px; margin: 0 auto; padding: 0 20px 24px;
        }
        .choice-list { display: flex; flex-direction: column; gap: 10px; }
        .choice-item {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; border-radius: var(--radius-sm);
            border: 2px solid var(--border); background: var(--bg-card);
            cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .choice-item:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }
        .choice-item.selected { border-color: var(--accent); background: var(--accent-soft); }
        .choice-item.correct { border-color: var(--success); background: var(--success-soft); }
        .choice-item.wrong { border-color: var(--error); background: var(--error-soft); }
        .choice-item.missed { border-color: var(--success); background: var(--success-soft); opacity: 0.7; }
        .choice-item.disabled { pointer-events: none; opacity: 0.7; }
        .choice-label {
            font-weight: 700; color: var(--text-secondary); font-size: 13px;
            min-width: 24px; flex-shrink: 0;
        }
        .choice-expr { flex: 1; }
        .choice-mark { font-size: 16px; font-weight: 700; margin-left: auto; flex-shrink: 0; }
        .choice-mark.ok { color: var(--success); }
        .choice-mark.ng { color: var(--error); }
        .choice-radio, .choice-check {
            width: 18px; height: 18px; accent-color: var(--accent); flex-shrink: 0;
        }
        .answer-submit-btn {
            width: 100%; padding: 14px; margin-top: 16px;
            border: none; border-radius: var(--radius);
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white; font-family: inherit; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
        }
        .answer-submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
        .answer-submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .answer-result {
            margin-top: 16px; padding: 14px 16px; border-radius: var(--radius-sm);
            font-size: 14px; font-weight: 600;
        }
        .answer-result.ok { background: var(--success-soft); color: var(--success); border: 1px solid rgba(45,212,168,0.3); }
        .answer-result.partial { background: var(--warning-soft); color: var(--warning); border: 1px solid rgba(255,200,87,0.3); }
        .answer-result.ng { background: var(--error-soft); color: var(--error); border: 1px solid rgba(255,107,107,0.3); }
        .answer-explanation {
            margin-top: 16px; padding: 16px; border-radius: var(--radius-sm);
            background: var(--bg-card); border: 1px solid var(--border);
        }
        .answer-explanation-title {
            font-size: 12px; font-weight: 600; color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
        }
        .answer-next-btn {
            width: 100%; padding: 14px; margin-top: 16px;
            border: none; border-radius: var(--radius);
            background: var(--bg-card); border: 1px solid var(--border-accent);
            color: var(--accent); font-family: inherit; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
        }
        .answer-next-btn:hover { background: var(--accent-soft); }
        .template-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 11px; font-weight: 600; padding: 3px 10px;
            border-radius: 12px; margin-left: 8px;
        }
        .template-badge.select { background: rgba(99,179,237,0.15); color: #63b3ed; }
        .template-badge.image { background: rgba(255,200,87,0.15); color: var(--warning); }

        @media (max-width: 600px) {
            .main { padding: 20px 16px 80px; }
            .upload-area { padding: 32px 16px; }
            .upload-actions { flex-direction: column; align-items: stretch; }
            .api-key-row { flex-direction: column; }
            .meta-bar { flex-wrap: wrap; gap: 12px; }
            .learning-panel { max-height: 90vh; }
            .unit-grid { grid-template-columns: 1fr 1fr; }
            .score-circle { width: 100px; height: 100px; }
            .score-number { font-size: 30px; }
        }

    </style>
</head>
<body>

<header class="header">
    <div class="header-inner">
        <div class="logo" onclick="navigateTo('home')" style="cursor:pointer">
            <div class="logo-icon">‚àë</div>
            <span class="logo-text">MathApp</span>
        </div>
        <div class="header-right">
            <span class="badge">PoC v0.4</span>
            <button class="settings-btn" onclick="toggleApiKey()" title="APIË®≠ÂÆö">‚öô</button>
        </div>
    </div>
</header>

<!-- ‚ïê‚ïê‚ïê API Key (shared across screens) ‚ïê‚ïê‚ïê -->
<div class="api-key-section" id="apiKeySection" style="margin:0 auto;max-width:520px;">
    <div class="api-key-header" onclick="toggleApiKey()">
        <span>üîë APIË®≠ÂÆö</span>
        <span class="api-key-arrow">‚ñº</span>
    </div>
    <div class="api-key-body">
        <div class="api-key-row">
            <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-...">
            <button class="api-key-save" onclick="saveApiKey()">‰øùÂ≠ò</button>
        </div>
        <div class="api-key-status" id="apiKeyStatus">API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Supabase Êé•Á∂öÔºàÊºîÁøíÂïèÈ°å„ÅÆÂèñÂæóÔºâ</div>
            <div class="api-key-row" style="margin-bottom:6px">
                <input type="text" class="api-key-input" id="supabaseUrlInput" placeholder="https://xxxxx.supabase.co">
            </div>
            <div class="api-key-row">
                <input type="text" class="api-key-input" id="supabaseKeyInput" placeholder="anon key">
                <button class="api-key-save" onclick="saveSupabaseConfig()">‰øùÂ≠ò</button>
            </div>
            <div class="api-key-status" id="supabaseStatus">Supabase URL„Å®Anon Key„ÇíÂÖ•Âäõ</div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê Screen: Home (ÂçòÂÖÉ‰∏ÄË¶ß) ‚ïê‚ïê‚ïê -->
<div id="screen-home" class="screen active">
    <div class="subject-tabs" id="subjectTabs"></div>
    <div class="free-mode-btn" onclick="navigateTo('free')">üì∑ „Éï„É™„ÉºÊé°ÁÇπ„É¢„Éº„ÉâÔºàÂçòÂÖÉ„ÇíÊåáÂÆö„Åõ„ÅöËá™Áî±„Å´Êé°ÁÇπÔºâ</div>
    <div class="unit-grid" id="unitGrid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê Screen: Unit Detail (ÂçòÂÖÉË©≥Á¥∞ ‚Üí Â∞èÂçòÂÖÉ„ÉªÂïèÈ°å‰∏ÄË¶ß) ‚ïê‚ïê‚ïê -->
<div id="screen-unit" class="screen">
    <div class="nav-bar">
        <button class="nav-back" onclick="navigateTo('home')">‚Üê Êàª„Çã</button>
        <div>
            <div class="nav-title" id="unitDetailTitle"></div>
            <div class="nav-subtitle" id="unitDetailSubject"></div>
        </div>
    </div>
    <div class="overview-card" id="unitOverview"></div>
    <div class="subunit-section" id="subunitList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê Screen: Problem (ÂïèÈ°åË°®Á§∫ + Á≠îÊ°à„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ + Êé°ÁÇπ) ‚ïê‚ïê‚ïê -->
<div id="screen-problem" class="screen">
    <div class="nav-bar">
        <button class="nav-back" id="problemBackBtn" onclick="navigateBack()">‚Üê Êàª„Çã</button>
        <div>
            <div class="nav-title" id="problemScreenTitle"></div>
            <div class="nav-subtitle" id="problemScreenSub"></div>
        </div>
    </div>

    <!-- Problem display (hidden in free mode) -->
    <div class="problem-display" id="problemDisplay" style="display:none">
        <div class="problem-display-title" id="problemDifficulty"></div>
        <div class="problem-display-text mixed-text" id="problemText"></div>
        <div class="problem-display-hint" id="problemHint" style="display:none" onclick="revealHint(this)">
            üí° „Éí„É≥„Éà„ÇíË¶ã„Çã
        </div>
    </div>

    <!-- Answer area for SELECT exercises (radio/checkbox) -->
    <div class="answer-area" id="answerArea" style="display:none"></div>

    <main class="main" id="uploadMain">
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div id="uploadPrompt">
                <div class="upload-icon">üì∑</div>
                <div class="upload-title">Ëß£„ÅÑ„ÅüÁ≠îÊ°à„ÇíÊíÆÂΩ±„Éª„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                <div class="upload-subtitle">AI„ÅåÊé°ÁÇπ„Åó„Å¶„ÄÅ„Å§„Åæ„Åö„Åç„Éù„Ç§„É≥„Éà„ÇíÊïô„Åà„Å¶„Åè„Çå„Åæ„Åô</div>
                <div class="upload-actions">
                    <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">üìÅ „Éï„Ç°„Ç§„É´ÈÅ∏Êäû</button>
                    <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('cameraInput').click()">üì∏ „Ç´„É°„É©„ÅßÊíÆÂΩ±</button>
                </div>
            </div>
            <div class="preview-container" id="previewContainer">
                <img id="previewImg" class="preview-img" alt="„Éó„É¨„Éì„É•„Éº">
                <button class="preview-remove" onclick="event.stopPropagation(); removeImage()" title="ÂâäÈô§">‚úï</button>
            </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)">

        <div class="analyze-section">
            <button class="analyze-btn" id="analyzeBtn" disabled onclick="analyze()">
                <span class="btn-text" id="btnText">Á≠îÊ°à„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                <div class="spinner"><div class="spinner-dot"></div><div class="spinner-dot"></div><div class="spinner-dot"></div></div>
            </button>
        </div>

        <div class="results-section" id="resultsSection"></div>
    </main>
</div>

<!-- ‚ïê‚ïê‚ïê Screen: Free Mode („Éï„É™„ÉºÊé°ÁÇπ) ‚ïê‚ïê‚ïê -->
<div id="screen-free" class="screen">
    <!-- Redirects to screen-problem with free mode context -->
</div>

<!-- Learning Panel Overlay -->
<div class="learning-overlay" id="learningOverlay" onclick="closeLearning(event)">
    <div class="learning-panel" onclick="event.stopPropagation()">
        <div class="learning-header">
            <span class="learning-title" id="learningTitle">ÂçòÂÖÉÂ≠¶Áøí</span>
            <button class="learning-close" onclick="closeLearning()">‚úï</button>
        </div>
        <div class="learning-body" id="learningBody"></div>
    </div>
</div>

<script>
let selectedFile = null;
let base64Image = null;
let apiKey = '';
let serverHasOpenAI = false;

// ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê
(function init() {
    const saved = localStorage.getItem('openai_api_key');
    if (saved) {
        apiKey = saved;
        document.getElementById('apiKeyInput').value = saved;
        document.getElementById('apiKeyStatus').textContent = '‚úì „É≠„Éº„Ç´„É´Ë®≠ÂÆöÊ∏à„Åø';
        document.getElementById('apiKeyStatus').className = 'api-key-status saved';
    }
})();

// „Çµ„Éº„Éê„Éº„Åã„ÇâË®≠ÂÆö„ÇíËá™ÂãïÂèñÂæóÔºà/api/configÔºâ
(async function autoConfig() {
    try {
        const res = await fetch('/api/config');
        if (!res.ok) return;
        const config = await res.json();

        // Supabase Ëá™ÂãïË®≠ÂÆö
        if (config.supabaseUrl && config.supabaseAnonKey && !supabaseClient) {
            supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
            document.getElementById('supabaseUrlInput').value = config.supabaseUrl;
            document.getElementById('supabaseKeyInput').value = '(Ëá™ÂãïË®≠ÂÆöÊ∏à„Åø)';
            document.getElementById('supabaseStatus').textContent = '‚úì „Çµ„Éº„Éê„Éº„Åã„ÇâËá™ÂãïË®≠ÂÆö';
            document.getElementById('supabaseStatus').className = 'api-key-status saved';
        }

        // OpenAI „Çµ„Éº„Éê„ÉºÂÅ¥Ë®≠ÂÆö
        if (config.hasOpenAI) {
            serverHasOpenAI = true;
            if (!apiKey) {
                document.getElementById('apiKeyStatus').textContent = '‚úì „Çµ„Éº„Éê„ÉºÂÅ¥„ÅßË®≠ÂÆöÊ∏à„ÅøÔºàÂÖ•Âäõ‰∏çË¶ÅÔºâ';
                document.getElementById('apiKeyStatus').className = 'api-key-status saved';
            }
        }

        // ÂÖ®„Å¶Ë®≠ÂÆöÊ∏à„Åø„Å™„Çâ APIË®≠ÂÆö„ÇíÈñâ„Åò„Åü„Åæ„Åæ
        if ((config.supabaseUrl || supabaseClient) && (config.hasOpenAI || apiKey)) {
            document.getElementById('apiKeySection').classList.remove('open');
        } else {
            document.getElementById('apiKeySection').classList.add('open');
        }
    } catch (e) {
        // /api/config „Åå„Å™„ÅÑÂ†¥ÂêàÔºà„É≠„Éº„Ç´„É´Á≠âÔºâ„ÅØ localStorage „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if (!apiKey && !localStorage.getItem('supabase_url')) {
            document.getElementById('apiKeySection').classList.add('open');
        }
    }
})();

function toggleApiKey() {
    document.getElementById('apiKeySection').classList.toggle('open');
}

function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) return;
    apiKey = key;
    localStorage.setItem('openai_api_key', key);
    document.getElementById('apiKeyStatus').textContent = '‚úì ‰øùÂ≠òÊ∏à„Åø';
    document.getElementById('apiKeyStatus').className = 'api-key-status saved';
    setTimeout(() => toggleApiKey(), 500);
}

// ‚ïê‚ïê‚ïê Supabase Config ‚ïê‚ïê‚ïê
let supabaseClient = null;

function initSupabase() {
    const url = localStorage.getItem('supabase_url');
    const key = localStorage.getItem('supabase_anon_key');
    if (url && key) {
        supabaseClient = window.supabase.createClient(url, key);
        document.getElementById('supabaseUrlInput').value = url;
        document.getElementById('supabaseKeyInput').value = key;
        document.getElementById('supabaseStatus').textContent = '‚úì Êé•Á∂öË®≠ÂÆöÊ∏à„Åø';
        document.getElementById('supabaseStatus').className = 'api-key-status saved';
    }
}
initSupabase();

function saveSupabaseConfig() {
    const url = document.getElementById('supabaseUrlInput').value.trim();
    const key = document.getElementById('supabaseKeyInput').value.trim();
    if (!url || !key) return;
    localStorage.setItem('supabase_url', url);
    localStorage.setItem('supabase_anon_key', key);
    supabaseClient = window.supabase.createClient(url, key);
    document.getElementById('supabaseStatus').textContent = '‚úì ‰øùÂ≠òÊ∏à„Åø';
    document.getElementById('supabaseStatus').className = 'api-key-status saved';
    setTimeout(() => toggleApiKey(), 500);
}

// ‚ïê‚ïê‚ïê Sub-unit ‚Üí Supabase Skills Mapping ‚ïê‚ïê‚ïê
const SUB_UNIT_TO_SKILLS = {
    "exp_expand":    ["poly_expand"],
    "exp_factor":    ["factoring"],
    "exp_real_ineq": ["real_numbers", "linear_ineq"],
    "qf_graph":      ["quad_func_graph"],
    "qf_maxmin":     ["quad_func_max_min"],
    "qf_eq_ineq":    ["quad_equation", "quad_inequality"],
    "tr_ratio":      ["trig_ratio_basic", "trig_ratio_special", "trig_identity", "trig_obtuse"],
    "tr_law":        ["trig_sine_rule", "trig_cosine_rule"],
    "tr_area":       ["trig_area"],
};

// „Ç≠„É£„ÉÉ„Ç∑„É•: subUnitKey ‚Üí exercises[]
const exerciseCache = {};

async function fetchExercisesForSubUnit(subUnitKey) {
    if (exerciseCache[subUnitKey]) return exerciseCache[subUnitKey];
    if (!supabaseClient) return null;

    const skillIds = SUB_UNIT_TO_SKILLS[subUnitKey];
    if (!skillIds || skillIds.length === 0) return null;

    try {
        // „Éë„Çø„Éº„É≥IDÂèñÂæó
        const { data: patterns, error: pErr } = await supabaseClient
            .from('patterns').select('id').in('skill_id', skillIds);
        if (pErr || !patterns || patterns.length === 0) return null;

        const patternIds = patterns.map(p => p.id);

        // ÊºîÁøíÂèñÂæó
        const { data: exercises, error: eErr } = await supabaseClient
            .from('exercises')
            .select('id, pattern_id, sort_order, input_template, difficulty, question_text, question_expr, explanation, grading_cost')
            .in('pattern_id', patternIds)
            .order('sort_order');
        if (eErr || !exercises || exercises.length === 0) return null;

        const exerciseIds = exercises.map(e => e.id);

        // ÈÅ∏ÊäûËÇ¢„Çí‰∏¶ÂàóÂèñÂæó
        const { data: choices } = await supabaseClient
            .from('exercise_choices')
            .select('id, exercise_id, choice_label, choice_expr, is_correct, distractor_note, sort_order')
            .in('exercise_id', exerciseIds)
            .order('sort_order');

        // Ê≠£Ëß£„Çí‰∏¶ÂàóÂèñÂæó
        const { data: answers } = await supabaseClient
            .from('exercise_answers')
            .select('id, exercise_id, answer_expr, normalized_form, is_primary')
            .in('exercise_id', exerciseIds);

        // ÈÅ∏ÊäûËÇ¢„ÉªÊ≠£Ëß£„Çí„Éû„ÉÉ„Éî„É≥„Ç∞
        const choicesMap = {};
        (choices || []).forEach(c => {
            if (!choicesMap[c.exercise_id]) choicesMap[c.exercise_id] = [];
            choicesMap[c.exercise_id].push(c);
        });
        const answersMap = {};
        (answers || []).forEach(a => {
            if (!answersMap[a.exercise_id]) answersMap[a.exercise_id] = [];
            answersMap[a.exercise_id].push(a);
        });

        const result = exercises.map(ex => ({
            ...ex,
            choices: (choicesMap[ex.id] || []).sort((a, b) => a.sort_order - b.sort_order),
            answers: answersMap[ex.id] || [],
            _source: 'supabase',
        }));

        exerciseCache[subUnitKey] = result;
        return result;
    } catch (err) {
        console.error('Supabase fetch error:', err);
        return null;
    }
}

// ‚ïê‚ïê‚ïê SELECT_BASIC UI ‚ïê‚ïê‚ïê
function renderSelectBasic(exercise, answerArea, onDone) {
    let selected = -1;
    let submitted = false;
    const choices = exercise.choices;

    let html = '<div class="choice-list">';
    choices.forEach((ch, i) => {
        html += '<div class="choice-item" data-idx="' + i + '">';
        html += '<input type="radio" name="select_' + exercise.id + '" class="choice-radio" data-idx="' + i + '">';
        html += '<span class="choice-label">' + escHtml(ch.choice_label) + '.</span>';
        html += '<span class="choice-expr">' + renderMixedText('$' + ch.choice_expr + '$') + '</span>';
        html += '<span class="choice-mark" data-idx="' + i + '"></span>';
        html += '</div>';
    });
    html += '</div>';
    html += '<button class="answer-submit-btn" id="selectSubmitBtn" disabled>Ëß£Á≠î„Åô„Çã</button>';
    html += '<div id="selectResult"></div>';

    answerArea.innerHTML = html;

    // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    answerArea.querySelectorAll('.choice-item').forEach(el => {
        el.addEventListener('click', () => {
            if (submitted) return;
            selected = parseInt(el.dataset.idx);
            answerArea.querySelectorAll('.choice-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('.choice-radio').checked = true;
            document.getElementById('selectSubmitBtn').disabled = false;
        });
    });

    // Ëß£Á≠î„Éú„Çø„É≥
    document.getElementById('selectSubmitBtn').addEventListener('click', () => {
        if (submitted || selected < 0) return;
        submitted = true;
        const isCorrect = choices[selected].is_correct;

        answerArea.querySelectorAll('.choice-item').forEach((el, i) => {
            el.classList.add('disabled');
            el.classList.remove('selected');
            if (choices[i].is_correct) {
                el.classList.add('correct');
                el.querySelector('.choice-mark').innerHTML = '‚úì';
                el.querySelector('.choice-mark').classList.add('ok');
            } else if (i === selected) {
                el.classList.add('wrong');
                el.querySelector('.choice-mark').innerHTML = '‚úó';
                el.querySelector('.choice-mark').classList.add('ng');
            }
        });

        const resultEl = document.getElementById('selectResult');
        let resultHtml = '<div class="answer-result ' + (isCorrect ? 'ok' : 'ng') + '">';
        resultHtml += isCorrect ? '‚≠ï Ê≠£Ëß£ÔºÅ' : '‚ùå ‰∏çÊ≠£Ëß£';
        resultHtml += '</div>';

        if (exercise.explanation) {
            resultHtml += '<div class="answer-explanation">';
            resultHtml += '<div class="answer-explanation-title">üìù Ëß£Ë™¨</div>';
            resultHtml += '<div class="mixed-text">' + renderMixedText(exercise.explanation) + '</div>';
            resultHtml += '</div>';
        }

        resultEl.innerHTML = resultHtml;
        document.getElementById('selectSubmitBtn').style.display = 'none';
        onDone(isCorrect);
    });
}

// ‚ïê‚ïê‚ïê SELECT_MULTI UI ‚ïê‚ïê‚ïê
function renderSelectMulti(exercise, answerArea, onDone) {
    let checked = new Set();
    let submitted = false;
    const choices = exercise.choices;
    const correctSet = new Set(choices.map((c, i) => c.is_correct ? i : -1).filter(i => i >= 0));

    let html = '<div class="choice-list">';
    choices.forEach((ch, i) => {
        html += '<div class="choice-item" data-idx="' + i + '">';
        html += '<input type="checkbox" class="choice-check" data-idx="' + i + '">';
        html += '<span class="choice-label">' + escHtml(ch.choice_label) + '.</span>';
        html += '<span class="choice-expr">' + renderMixedText('$' + ch.choice_expr + '$') + '</span>';
        html += '<span class="choice-mark" data-idx="' + i + '"></span>';
        html += '</div>';
    });
    html += '</div>';
    html += '<div style="font-size:12px;color:var(--text-muted);margin-top:8px">‚Äª Ê≠£Ëß£„ÅØË§áÊï∞„ÅÇ„Çä„Åæ„Åô</div>';
    html += '<button class="answer-submit-btn" id="multiSubmitBtn">Ëß£Á≠î„Åô„Çã</button>';
    html += '<div id="multiResult"></div>';

    answerArea.innerHTML = html;

    answerArea.querySelectorAll('.choice-item').forEach(el => {
        el.addEventListener('click', () => {
            if (submitted) return;
            const idx = parseInt(el.dataset.idx);
            const cb = el.querySelector('.choice-check');
            if (checked.has(idx)) {
                checked.delete(idx);
                el.classList.remove('selected');
                cb.checked = false;
            } else {
                checked.add(idx);
                el.classList.add('selected');
                cb.checked = true;
            }
        });
    });

    document.getElementById('multiSubmitBtn').addEventListener('click', () => {
        if (submitted) return;
        submitted = true;

        const perfect = checked.size === correctSet.size && [...checked].every(i => correctSet.has(i));
        const anyCorrect = [...checked].some(i => correctSet.has(i));
        const resultType = perfect ? 'ok' : anyCorrect ? 'partial' : 'ng';

        answerArea.querySelectorAll('.choice-item').forEach((el, i) => {
            el.classList.add('disabled');
            el.classList.remove('selected');
            if (correctSet.has(i) && checked.has(i)) {
                el.classList.add('correct');
                el.querySelector('.choice-mark').innerHTML = '‚úì';
                el.querySelector('.choice-mark').classList.add('ok');
            } else if (correctSet.has(i) && !checked.has(i)) {
                el.classList.add('missed');
                el.querySelector('.choice-mark').innerHTML = '‚úì';
                el.querySelector('.choice-mark').classList.add('ok');
            } else if (!correctSet.has(i) && checked.has(i)) {
                el.classList.add('wrong');
                el.querySelector('.choice-mark').innerHTML = '‚úó';
                el.querySelector('.choice-mark').classList.add('ng');
            }
        });

        const resultEl = document.getElementById('multiResult');
        const labels = { ok: '‚≠ï Ê≠£Ëß£ÔºÅ', partial: '‚ñ≥ ÈÉ®ÂàÜÊ≠£Ëß£', ng: '‚ùå ‰∏çÊ≠£Ëß£' };
        let resultHtml = '<div class="answer-result ' + resultType + '">' + labels[resultType] + '</div>';

        if (exercise.explanation) {
            resultHtml += '<div class="answer-explanation">';
            resultHtml += '<div class="answer-explanation-title">üìù Ëß£Ë™¨</div>';
            resultHtml += '<div class="mixed-text">' + renderMixedText(exercise.explanation) + '</div>';
            resultHtml += '</div>';
        }

        resultEl.innerHTML = resultHtml;
        document.getElementById('multiSubmitBtn').style.display = 'none';
        onDone(perfect);
    });
}

// ‚ïê‚ïê‚ïê SupabaseÊºîÁøí„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ ‚ïê‚ïê‚ïê
let currentSubUnitExercises = null; // Supabase„Åã„ÇâÂèñÂæó„Åó„ÅüÊºîÁøíÈÖçÂàó
let currentExerciseIndex = 0;

// ‚ïê‚ïê‚ïê File Handling ‚ïê‚ïê‚ïê
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        base64Image = e.target.result;
        document.getElementById('previewImg').src = base64Image;
        document.getElementById('previewContainer').classList.add('visible');
        document.getElementById('uploadPrompt').style.display = 'none';
        document.getElementById('uploadArea').classList.add('has-image');
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('btnText').textContent = 'Êé°ÁÇπ„Åô„Çã';
    };
    reader.readAsDataURL(file);
}

function removeImage() {
    selectedFile = null; base64Image = null;
    document.getElementById('previewContainer').classList.remove('visible');
    document.getElementById('uploadPrompt').style.display = 'block';
    document.getElementById('uploadArea').classList.remove('has-image');
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('fileInput').value = '';
    document.getElementById('cameraInput').value = '';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('btnText').textContent = 'Á≠îÊ°à„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
}

const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        const dt = new DataTransfer(); dt.items.add(file);
        document.getElementById('fileInput').files = dt.files;
        handleFileSelect({ target: { files: [file] } });
    }
});

// ‚ïê‚ïê‚ïê Math Rendering ‚ïê‚ïê‚ïê
function renderMathBlock(latex) {
    if (!latex || latex === '‚Äî') return escHtml(latex || '');
    let expr = latex.trim();
    if (expr.startsWith('$$') && expr.endsWith('$$')) expr = expr.slice(2,-2).trim();
    else if (expr.startsWith('$') && expr.endsWith('$')) expr = expr.slice(1,-1).trim();
    else if (expr.startsWith('\\[') && expr.endsWith('\\]')) expr = expr.slice(2,-2).trim();
    else if (expr.startsWith('\\(') && expr.endsWith('\\)')) expr = expr.slice(2,-2).trim();
    try { return katex.renderToString(expr, { displayMode: true, throwOnError: false }); }
    catch (e) { return '<code>' + escHtml(latex) + '</code>'; }
}

function renderMixedText(text) {
    if (!text) return '';
    const result = [];
    let i = 0;
    while (i < text.length) {
        if (text[i] === '$' && text[i+1] === '$') {
            const end = text.indexOf('$$', i+2);
            if (end !== -1) {
                try { result.push(katex.renderToString(text.slice(i+2,end).trim(), {displayMode:true,throwOnError:false})); }
                catch(e) { result.push('<code>'+escHtml(text.slice(i+2,end))+'</code>'); }
                i = end+2; continue;
            }
        }
        if (text[i] === '$') {
            const end = text.indexOf('$', i+1);
            if (end !== -1 && end > i+1) {
                const expr = text.slice(i+1, end);
                if (expr.trim()) {
                    try { result.push(katex.renderToString(expr.trim(), {displayMode:false,throwOnError:false})); }
                    catch(e) { result.push('<code>'+escHtml(expr)+'</code>'); }
                    i = end+1; continue;
                }
            }
        }
        if (text[i] === '\\' && text[i+1] === '(') {
            const end = text.indexOf('\\)', i+2);
            if (end !== -1) {
                try { result.push(katex.renderToString(text.slice(i+2,end).trim(), {displayMode:false,throwOnError:false})); }
                catch(e) { result.push('<code>'+escHtml(text.slice(i+2,end))+'</code>'); }
                i = end+2; continue;
            }
        }
        if (text[i] === '\\' && text[i+1] === '[') {
            const end = text.indexOf('\\]', i+2);
            if (end !== -1) {
                try { result.push(katex.renderToString(text.slice(i+2,end).trim(), {displayMode:true,throwOnError:false})); }
                catch(e) { result.push('<code>'+escHtml(text.slice(i+2,end))+'</code>'); }
                i = end+2; continue;
            }
        }
        if (text[i] === '\n') { result.push('<br>'); i++; continue; }
        let j = i;
        while (j < text.length && text[j] !== '$' && text[j] !== '\n' &&
               !(text[j]==='\\' && (text[j+1]==='(' || text[j+1]==='['))) j++;
        result.push(escHtml(text.slice(i,j)));
        i = j;
    }
    return result.join('');
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê Unit & Formula Database (from Notion) ‚ïê‚ïê‚ïê
const UNIT_DB = {
    "expressions": { name: "Êï∞„Å®Âºè", subject: "Êï∞Â≠¶‚Ö†", category: "math1a", order: 1, summary: "Â±ïÈñã„ÉªÂõ†Êï∞ÂàÜËß£„ÄÅÂÆüÊï∞„ÅÆÂàÜÈ°û„ÄÅ1Ê¨°‰∏çÁ≠âÂºè„Å™„Å©„ÄÅÊï∞Â≠¶„ÅÆÂü∫Á§é„Å®„Å™„ÇãË®àÁÆóÂäõ„ÇíË∫´„Å´„Å§„Åë„ÇãÂçòÂÖÉ", tips: "Âõ†Êï∞ÂàÜËß£„ÅØÂ±ïÈñã„ÅÆÈÄÜÊìç‰Ωú„ÄÇ‰πóÊ≥ïÂÖ¨Âºè„ÇíÈÄÜÂêë„Åç„Å´‰Ωø„ÅÜÁ∑¥Áøí„ÅåÈáçË¶Å\nÁµ∂ÂØæÂÄ§„ÅÆÂïèÈ°å„ÅØ‰∏≠Ë∫´„ÅÆÊ≠£Ë≤†„ÅßÂ†¥ÂêàÂàÜ„Åë\n‰∏çÁ≠âÂºè„Åß„ÅØ‰∏°Ëæ∫„Å´Ë≤†„ÅÆÊï∞„Çí„Åã„Åë„Çã„Å®‰∏çÁ≠âÂè∑„ÅåÈÄÜËª¢", formulas: ["square_of_sum","square_of_diff","diff_of_squares"] },
    "sets_logic": { name: "ÈõÜÂêà„Å®ÂëΩÈ°å", subject: "Êï∞Â≠¶‚Ö†", category: "math1a", order: 2, summary: "ÈõÜÂêà„ÅÆË°®„ÅóÊñπ„ÄÅÂÖ±ÈÄöÈÉ®ÂàÜ„ÉªÂíåÈõÜÂêà„ÄÅÂëΩÈ°å„ÅÆÁúüÂÅΩ„ÄÅÂøÖË¶ÅÊù°‰ª∂„ÉªÂçÅÂàÜÊù°‰ª∂„Å´„Å§„ÅÑ„Å¶Â≠¶„Å∂", tips: "„Éô„É≥Âõ≥„ÇíÊèè„ÅÑ„Å¶ÈõÜÂêà„ÅÆÈñ¢‰øÇ„ÇíË¶ñË¶öÁöÑ„Å´ÁêÜËß£„Åô„Çã\n„Äåp‚áíq„Äç„ÅåÁúü„ÅÆ„Å®„Åç„ÄÅp„ÅØq„ÅÆÂçÅÂàÜÊù°‰ª∂„ÄÅq„ÅØp„ÅÆÂøÖË¶ÅÊù°‰ª∂\nÂèç‰æã„Çí1„Å§Ë¶ã„Å§„Åë„Çå„Å∞ÂëΩÈ°å„ÅØÂÅΩ", formulas: [] },
    "quadratic_function": { name: "‰∫åÊ¨°Èñ¢Êï∞", subject: "Êï∞Â≠¶‚Ö†", category: "math1a", order: 3, summary: "‰∫åÊ¨°Èñ¢Êï∞„ÅÆ„Ç∞„É©„Éï„ÄÅÂπ≥ÊñπÂÆåÊàê„ÄÅÊúÄÂ§ßÂÄ§„ÉªÊúÄÂ∞èÂÄ§„ÄÅ‰∫åÊ¨°ÊñπÁ®ãÂºè„Éª‰∫åÊ¨°‰∏çÁ≠âÂºè„ÇíÊâ±„ÅÜÈáçË¶ÅÂçòÂÖÉ", tips: "Âπ≥ÊñπÂÆåÊàê„ÅßÊ®ôÊ∫ñÂΩ¢ y=a(x-p)¬≤+q „Å´„Åô„Çã„Å®È†ÇÁÇπ„ÉªËª∏„Åå„Åô„Åê„Çè„Åã„Çã\nÂÆöÁæ©Âüü„ÅåÈôê„Çâ„Çå„Çã„Å®„Åç„ÅØËª∏„Å®ÂÆöÁæ©Âüü„ÅÆ‰ΩçÁΩÆÈñ¢‰øÇ„ÅßÂ†¥ÂêàÂàÜ„Åë\n‰∫åÊ¨°‰∏çÁ≠âÂºè„ÅØ„Ç∞„É©„Éï„ÇíÊèè„ÅÑ„Å¶xËª∏„Å®„ÅÆ‰ΩçÁΩÆÈñ¢‰øÇ„ÅßËß£„Åè", formulas: ["quadratic_formula","quadratic_standard","discriminant"] },
    "trigonometric_ratio": { name: "Âõ≥ÂΩ¢„Å®Ë®àÈáè", subject: "Êï∞Â≠¶‚Ö†", category: "math1a", order: 4, summary: "‰∏âËßíÊØîÔºàsin, cos, tanÔºâ„ÅÆÂÆöÁæ©„ÄÅÁõ∏‰∫íÈñ¢‰øÇ„ÄÅÊ≠£Âº¶ÂÆöÁêÜ„Éª‰ΩôÂº¶ÂÆöÁêÜ„ÇíÁî®„ÅÑ„ÅüÂõ≥ÂΩ¢„ÅÆË®àÈáè", tips: "sin, cos, tan„ÅØÁõ¥Ëßí‰∏âËßíÂΩ¢„ÅÆËæ∫„ÅÆÊØî„ÄÇÂçò‰ΩçÂÜÜ„Åß„ÇÇ„Ç§„É°„Éº„Ç∏„Åß„Åç„Çã\nÊ≠£Âº¶ÂÆöÁêÜ„ÅØ„ÄåËßí„Å®Âêë„Åã„ÅÑÂêà„ÅÜËæ∫„Äç„ÄÅ‰ΩôÂº¶ÂÆöÁêÜ„ÅØ„Äå3Ëæ∫„Å®1Ëßí„Äç„ÅÆÈñ¢‰øÇ\n‰∏âËßíÊØî„ÅÆÁõ∏‰∫íÈñ¢‰øÇ sin¬≤Œ∏+cos¬≤Œ∏=1 „ÅØÊúÄÈáçË¶Å", formulas: ["sine_rule","cosine_rule","trig_identity","triangle_area_sin"] },
    "data_analysis": { name: "„Éá„Éº„Çø„ÅÆÂàÜÊûê", subject: "Êï∞Â≠¶‚Ö†", category: "math1a", order: 5, summary: "Âπ≥ÂùáÂÄ§„ÄÅ‰∏≠Â§ÆÂÄ§„ÄÅÂàÜÊï£„ÄÅÊ®ôÊ∫ñÂÅèÂ∑Æ„ÄÅÁõ∏Èñ¢‰øÇÊï∞„Å™„Å©Áµ±Ë®àÁöÑ„Å™ÊåáÊ®ô„ÅÆÊÑèÂë≥„Å®Ë®àÁÆóÊñπÊ≥ï", tips: "ÂàÜÊï£„ÅØ„Äå‰∫å‰πó„ÅÆÂπ≥Âùá‚àíÂπ≥Âùá„ÅÆ‰∫å‰πó„Äç„ÅÆÂÖ¨Âºè„ÅåË®àÁÆó„Åó„ÇÑ„Åô„ÅÑ\nÁõ∏Èñ¢‰øÇÊï∞„ÅØÁõ¥Á∑öÁöÑ„Å™Èñ¢‰øÇ„ÅÆÂº∑„Åï„ÇíÁ§∫„Åó„ÄÅÂõ†ÊûúÈñ¢‰øÇ„Å®„ÅØÁï∞„Å™„Çã\nÁÆ±„Å≤„ÅíÂõ≥„ÅØÂõõÂàÜ‰ΩçÊï∞„ÅÆÁêÜËß£„ÅåÂøÖË¶Å", formulas: ["variance","correlation"] },
    "probability": { name: "Â†¥Âêà„ÅÆÊï∞„Å®Á¢∫Áéá", subject: "Êï∞Â≠¶A", category: "math1a", order: 6, summary: "È†ÜÂàó„ÉªÁµÑÂêà„Åõ„ÅÆË®àÁÆó„ÄÅÁ¢∫Áéá„ÅÆÂü∫Êú¨„ÄÅÊù°‰ª∂‰ªò„ÅçÁ¢∫Áéá„ÄÅÊúüÂæÖÂÄ§„Å´„Å§„ÅÑ„Å¶Â≠¶„Å∂", tips: "„Äå‰∏¶„Åπ„Çã„Äç„Å™„ÇâÈ†ÜÂàóP„ÄÅ„ÄåÈÅ∏„Å∂„Å†„Åë„Äç„Å™„ÇâÁµÑÂêà„ÅõC„Å®‰Ωø„ÅÑÂàÜ„Åë„Çã\n„ÄåÂ∞ë„Å™„Åè„Å®„ÇÇ1„Å§„Äç„ÅØ‰Ωô‰∫ãË±°Ôºà1„Å§„ÇÇ„Å™„ÅÑÁ¢∫ÁéáÔºâ„ÇíÂºï„Åè\nÊù°‰ª∂‰ªò„ÅçÁ¢∫Áéá„ÅØÂàÜÊØç„ÅåÊù°‰ª∂„ÅÆ‰∫ãË±°„Å´„Å™„Çã", formulas: ["permutation","combination","prob_addition","complementary_prob"] },
    "geometry_properties": { name: "Âõ≥ÂΩ¢„ÅÆÊÄßË≥™", subject: "Êï∞Â≠¶A", category: "math1a", order: 7, summary: "‰∏âËßíÂΩ¢„ÅÆ‰∫îÂøÉ„ÄÅÂÜÜ„ÅÆÊÄßË≥™„ÄÅ„É°„Éç„É©„Ç¶„Çπ„Éª„ÉÅ„Çß„Éê„ÅÆÂÆöÁêÜ„ÄÅ‰ΩúÂõ≥„Å´„Å§„ÅÑ„Å¶Â≠¶„Å∂", tips: "„É°„Éç„É©„Ç¶„Çπ„ÅÆÂÆöÁêÜ„ÅØ„Äå‰∏âËßíÂΩ¢„ÅÆËæ∫„ÅÆÂª∂Èï∑‰∏ä„ÅÆ3ÁÇπ„Åå‰∏ÄÁõ¥Á∑ö‰∏ä„Äç„ÅÆÊù°‰ª∂\nÂÜÜ„Å´ÂÜÖÊé•„Åô„ÇãÂõõËßíÂΩ¢„ÅÆÂØæËßí„ÅÆÂíå„ÅØ180¬∞\nÊé•Á∑ö„ÅÆÈï∑„Åï„ÅÆÊÄßË≥™ÔºàÂÜÜÂ§ñ„ÅÆÁÇπ„Åã„Çâ„ÅÆ2Êé•Á∑ö„ÅØÁ≠â„Åó„ÅÑÔºâ", formulas: ["menelaus","ceva"] },
    "integer_properties": { name: "Êï¥Êï∞„ÅÆÊÄßË≥™", subject: "Êï∞Â≠¶A", category: "math1a", order: 8, summary: "Á¥ÑÊï∞„ÉªÂÄçÊï∞„ÄÅ„É¶„Éº„ÇØ„É™„ÉÉ„Éâ„ÅÆ‰∫íÈô§Ê≥ï„ÄÅ‰∏çÂÆöÊñπÁ®ãÂºè„ÄÅÂêàÂêåÂºè„ÅÆÂü∫Á§é", tips: "„É¶„Éº„ÇØ„É™„ÉÉ„Éâ„ÅÆ‰∫íÈô§Ê≥ï„ÅØ„ÄåÂâ≤„ÇäÁÆó„ÇíÁπ∞„ÇäËøî„Åó„Å¶‰Ωô„Çä„Åå0„Å´„Å™„Çã„Åæ„Åß„Äç\n‰∏çÂÆöÊñπÁ®ãÂºè ax+by=gcd(a,b) „Å´„ÅØÂøÖ„ÅöÊï¥Êï∞Ëß£„ÅåÂ≠òÂú®\n‰Ωô„Çä„ÅßÂ†¥ÂêàÂàÜ„ÅëÔºàÂÅ∂Â•á„ÄÅ3„ÅÆÂÄçÊï∞„Å™„Å©Ôºâ„ÅåÊúâÂäπ„Å™ÊâãÊ≥ï", formulas: ["euclidean_algorithm"] },
    "equations_proof": { name: "Âºè„Å®Ë®ºÊòé", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 9, summary: "ÊÅíÁ≠âÂºè„ÅÆË®ºÊòé„ÄÅÁ≠âÂºè„Éª‰∏çÁ≠âÂºè„ÅÆË®ºÊòé„ÄÅ‰∫åÈ†ÖÂÆöÁêÜ„ÄÅÂâ∞‰Ωô„ÅÆÂÆöÁêÜ„Å™„Å©", tips: "ÊÅíÁ≠âÂºè„ÅÆË®ºÊòé„ÅØ„ÄåÂ∑¶Ëæ∫‚àíÂè≥Ëæ∫Ôºù0„Äç„ÇíÁ§∫„ÅôÊñπÊ≥ï„ÅåÂü∫Êú¨\n‰∫åÈ†ÖÂÆöÁêÜ„ÅÆ‰∏ÄËà¨È†Ö„ÅØC(n,r)¬∑a^(n-r)¬∑b^r\nÂâ∞‰Ωô„ÅÆÂÆöÁêÜÔºöP(x)„Çí(x-a)„ÅßÂâ≤„Å£„Åü‰Ωô„Çä„ÅØP(a)", formulas: ["binomial_theorem","remainder_theorem"] },
    "complex_equations": { name: "Ë§áÁ¥†Êï∞„Å®ÊñπÁ®ãÂºè", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 10, summary: "Ë§áÁ¥†Êï∞„ÅÆË®àÁÆó„ÄÅËß£„Å®‰øÇÊï∞„ÅÆÈñ¢‰øÇ„ÄÅÂâ∞‰Ωô„ÅÆÂÆöÁêÜ„ÄÅÈ´òÊ¨°ÊñπÁ®ãÂºè„ÅÆËß£Ê≥ï", tips: "ËôöÊï∞Âçò‰Ωç i¬≤=-1 „Åï„ÅàÊäë„Åà„Çå„Å∞Ë®àÁÆó„ÅØÂÆüÊï∞„Å®Âêå„Åò\nËß£„Å®‰øÇÊï∞„ÅÆÈñ¢‰øÇÔºöÂíå„Å®Á©ç„Åå‰øÇÊï∞„Åã„ÇâÊ±Ç„Åæ„Çã\nÈ´òÊ¨°ÊñπÁ®ãÂºè„ÅØÂõ†Êï∞ÂÆöÁêÜ„ÅßËß£„ÇíÊé¢„Åó„Å¶Ê¨°Êï∞„Çí‰∏ã„Åí„Çã", formulas: ["vieta_formulas","remainder_theorem"] },
    "coordinate_geometry": { name: "Âõ≥ÂΩ¢„Å®ÊñπÁ®ãÂºè", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 11, summary: "ÁÇπ„ÅÆÂ∫ßÊ®ô„ÄÅÁõ¥Á∑ö„ÅÆÊñπÁ®ãÂºè„ÄÅÂÜÜ„ÅÆÊñπÁ®ãÂºè„ÄÅËªåË∑°„ÄÅÈ†òÂüü„ÅÆÂõ≥Á§∫", tips: "ÁÇπ„Å®Áõ¥Á∑ö„ÅÆË∑ùÈõ¢„ÅÆÂÖ¨Âºè |ax‚ÇÄ+by‚ÇÄ+c|/‚àö(a¬≤+b¬≤) „ÅØÈ†ªÂá∫\nÂÜÜ„ÅÆÊñπÁ®ãÂºè„ÅØ„Äå‰∏≠ÂøÉ„Å®ÂçäÂæÑ„Äç„ÇíË™≠„ÅøÂèñ„Çã\n‰∏çÁ≠âÂºè„ÅÆË°®„ÅôÈ†òÂüü„ÅØ„ÄåÂ¢ÉÁïåÁ∑ö„Äç„Å®„ÄåÂêë„ÅçÔºà‰∏ä‰∏ãÔºâ„Äç„ÅßÂà§Êñ≠", formulas: ["point_line_distance","circle_equation"] },
    "trigonometric_function": { name: "‰∏âËßíÈñ¢Êï∞", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 12, summary: "ÂºßÂ∫¶Ê≥ï„ÄÅ‰∏âËßíÈñ¢Êï∞„ÅÆ„Ç∞„É©„Éï„ÄÅÂä†Ê≥ïÂÆöÁêÜ„ÄÅÂêàÊàê„ÄÅ‰∏âËßíÊñπÁ®ãÂºè", tips: "ÂºßÂ∫¶Ê≥ï„ÅÆÂ§âÊèõÔºö180¬∞=œÄ „ÇíÂü∫Êú¨„Å´ËßíÂ∫¶„Å®ÂºßÂ∫¶„ÇíË°å„ÅçÊù•„Åô„Çã\nÂä†Ê≥ïÂÆöÁêÜ„Åã„ÇâÂÄçËßí„ÉªÂçäËßí„ÅÆÂÖ¨Âºè„ÅåÂ∞éÂá∫„Åß„Åç„Çã\nÂêàÊàê a¬∑sinŒ∏+b¬∑cosŒ∏=r¬∑sin(Œ∏+Œ±) „ÅØÊúÄÂ§ßÊúÄÂ∞èÂïèÈ°å„ÅßÂøÖÈ†à", formulas: ["sin_addition","cos_addition","trig_synthesis","double_angle_sin","double_angle_cos"] },
    "exponential_logarithm": { name: "ÊåáÊï∞Èñ¢Êï∞„ÉªÂØæÊï∞Èñ¢Êï∞", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 13, summary: "ÊåáÊï∞Ê≥ïÂâá„ÄÅÊåáÊï∞Èñ¢Êï∞„ÉªÂØæÊï∞Èñ¢Êï∞„ÅÆ„Ç∞„É©„Éï„ÄÅÂØæÊï∞„ÅÆÊÄßË≥™„Å®Ë®àÁÆó", tips: "ÊåáÊï∞„Å®ÂØæÊï∞„ÅØÈÄÜÊºîÁÆó„ÅÆÈñ¢‰øÇÔºöa^x=M ‚áî x=log_a(M)\nÂØæÊï∞„ÅÆË®àÁÆó„ÅØ3Ê≥ïÂâáÔºàÂíå‚ÜíÁ©ç„ÄÅÂ∑Æ‚ÜíÂïÜ„ÄÅÂÆöÊï∞ÂÄç‚Üí„Åπ„Åç‰πóÔºâ\nÂ∫ï„ÅÆÂ§âÊèõÂÖ¨Âºè log_a(b)=log_c(b)/log_c(a) „ÅßÂ∫ï„ÇíÊèÉ„Åà„Çã", formulas: ["log_properties","log_base_change"] },
    "differentiation_2": { name: "ÂæÆÂàÜÊ≥ï", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 14, summary: "ÂæÆÂàÜ‰øÇÊï∞„ÄÅÂ∞éÈñ¢Êï∞„ÅÆË®àÁÆó„ÄÅÊé•Á∑ö„ÅÆÊñπÁ®ãÂºè„ÄÅÈñ¢Êï∞„ÅÆÂ¢óÊ∏õ„ÉªÊ•µÂÄ§", tips: "ÂæÆÂàÜ„ÅØ„ÄåÂ§âÂåñ„ÅÆÂâ≤Âêà„Äç„ÇíÊ±Ç„ÇÅ„ÇãÊìç‰Ωú„ÄÇ„Ç∞„É©„Éï„ÅÆÂÇæ„Åç\n(x^n)'=nx^(n-1) „ÅåÂü∫Êú¨„ÄÇÂÆöÊï∞„ÅÆÂæÆÂàÜ„ÅØ0\nf'(x)=0 „Å®„Å™„ÇãÁÇπ„ÅßÊ•µÂÄ§„Çí„Å®„ÇãÂèØËÉΩÊÄß‚ÜíÂ¢óÊ∏õË°®„ÅßÁ¢∫Ë™ç", formulas: ["power_derivative","tangent_line"] },
    "integration_2": { name: "Á©çÂàÜÊ≥ï", subject: "Êï∞Â≠¶‚Ö°", category: "math2b", order: 15, summary: "‰∏çÂÆöÁ©çÂàÜ„ÄÅÂÆöÁ©çÂàÜ„ÄÅÈù¢Á©ç„ÅÆË®àÁÆó", tips: "Á©çÂàÜ„ÅØÂæÆÂàÜ„ÅÆÈÄÜÊìç‰Ωú„ÄÇ„ÄåÂæÆÂàÜ„Åó„Åü„ÇâÂÖÉ„Å´Êàª„Çã„ÄçÈñ¢Êï∞„ÇíÊé¢„Åô\nÂÆöÁ©çÂàÜ„ÅØ„ÄåÈù¢Á©ç„Äç„ÅÆ„Ç§„É°„Éº„Ç∏„ÄÇxËª∏„ÅÆ‰∏ã„ÅØË≤†„Å´„Å™„Çã\nÈù¢Á©ç„ÅÆ„Äå1/6ÂÖ¨Âºè„Äç„Äå1/12ÂÖ¨Âºè„Äç„ÅØÊîæÁâ©Á∑ö„Å®Áõ¥Á∑ö„ÅßÈ†ªÂá∫", formulas: ["area_one_sixth"] },
    "sequences": { name: "Êï∞Âàó", subject: "Êï∞Â≠¶B", category: "math2b", order: 16, summary: "Á≠âÂ∑ÆÊï∞Âàó„ÉªÁ≠âÊØîÊï∞Âàó„ÄÅ„ÅÑ„Çç„ÅÑ„Çç„Å™Êï∞Âàó„ÅÆÂíå„ÄÅÊº∏ÂåñÂºè„ÄÅÊï∞Â≠¶ÁöÑÂ∏∞Á¥çÊ≥ï", tips: "Á≠âÂ∑ÆÊï∞Âàó„ÅØ„ÄåÂ∑Æ„Åå‰∏ÄÂÆö„Äç„ÄÅÁ≠âÊØîÊï∞Âàó„ÅØ„ÄåÊØî„Åå‰∏ÄÂÆö„Äç\nÊº∏ÂåñÂºè„ÅØ„ÄåÁâπÊÄßÊñπÁ®ãÂºè„Äç„ÅßËß£„Åè„ÅÆ„ÅåÂü∫Êú¨„Éë„Çø„Éº„É≥\nÊï∞Â≠¶ÁöÑÂ∏∞Á¥çÊ≥ï„ÅØn=1„ÅßÁ¢∫Ë™ç„ÄÅn=k‚Üín=k+1„ÇíÁ§∫„Åô", formulas: ["arithmetic_seq","arithmetic_sum","geometric_seq","geometric_sum"] },
    "statistical_inference": { name: "Áµ±Ë®àÁöÑ„Å™Êé®Ê∏¨", subject: "Êï∞Â≠¶B", category: "math2b", order: 17, summary: "Á¢∫ÁéáÂàÜÂ∏É„ÄÅÊ≠£Ë¶èÂàÜÂ∏É„ÄÅ‰ø°È†ºÂå∫Èñì„ÄÅ‰ªÆË™¨Ê§úÂÆö„ÅÆÂü∫Á§é", tips: "Ê≠£Ë¶èÂàÜÂ∏É N(Œº,œÉ¬≤) „ÅÆÊ®ôÊ∫ñÂåñÔºöZ=(X-Œº)/œÉ\n‰ø°È†ºÂå∫Èñì 95% „ÅØ Z=¬±1.96 „ÅåÁî®„ÅÑ„Çâ„Çå„Çã\n‰ªÆË™¨Ê§úÂÆö„ÅØ„ÄåÂ∏∞ÁÑ°‰ªÆË™¨„ÇíÁ´ã„Å¶„Å¶Ê£ÑÂç¥„Åß„Åç„Çã„Åã„Äç„ÇíÂà§Êñ≠", formulas: ["z_score","confidence_interval"] },
    "limits": { name: "Ê•µÈôê", subject: "Êï∞Â≠¶‚Ö¢", category: "math3c", order: 18, summary: "Êï∞Âàó„ÅÆÊ•µÈôê„ÄÅÁÑ°ÈôêÁ¥öÊï∞„ÄÅÈñ¢Êï∞„ÅÆÊ•µÈôê„ÄÅÈÄ£Á∂öÊÄß", tips: "Êï∞Âàó„ÅÆÊ•µÈôê„ÅØ„ÄåÊúÄÈ´òÊ¨°„ÅÆÈ†Ö„ÅßÂâ≤„Çã„Äç„ÅÆ„ÅåÂÆöÁü≥\nÁÑ°ÈôêÁ≠âÊØîÁ¥öÊï∞„ÅØ |r|<1 „ÅÆ„Å®„Åç a/(1-r) „Å´ÂèéÊùü\n„ÅØ„Åï„Åø„ÅÜ„Å°„ÅÆÂéüÁêÜ„ÅØÊ•µÈôê„ÅÆÂ≠òÂú®Ë®ºÊòé„Å´‰Ωø„ÅÜ", formulas: ["infinite_geometric_series","e_definition"] },
    "differentiation_3": { name: "ÂæÆÂàÜÊ≥ïÔºàÊï∞‚Ö¢Ôºâ", subject: "Êï∞Â≠¶‚Ö¢", category: "math3c", order: 19, summary: "ÂêàÊàêÈñ¢Êï∞„ÉªÈÄÜÈñ¢Êï∞„ÅÆÂæÆÂàÜ„ÄÅÂ™í‰ªãÂ§âÊï∞Ë°®Á§∫„ÅÆÂæÆÂàÜ„ÄÅÊé•Á∑ö„ÉªÊ≥ïÁ∑ö„ÄÅÈÄüÂ∫¶„ÉªÂä†ÈÄüÂ∫¶", tips: "ÂêàÊàêÈñ¢Êï∞„ÅÆÂæÆÂàÜ„ÅØ„ÄåÂ§ñÂÅ¥„ÅÆÂæÆÂàÜ√óÂÜÖÂÅ¥„ÅÆÂæÆÂàÜ„ÄçÔºàÈÄ£ÈéñÂæãÂâáÔºâ\ne^x, sin x, cos x, log x „ÅÆÂæÆÂàÜ„ÅØÂü∫Êú¨‰∏≠„ÅÆÂü∫Êú¨\nÂ™í‰ªãÂ§âÊï∞Ë°®Á§∫„ÅØ dy/dx = (dy/dt)/(dx/dt)", formulas: ["power_derivative","tangent_line","chain_rule","trig_derivatives","exp_log_derivatives"] },
    "integration_3": { name: "Á©çÂàÜÊ≥ïÔºàÊï∞‚Ö¢Ôºâ", subject: "Êï∞Â≠¶‚Ö¢", category: "math3c", order: 20, summary: "ÁΩÆÊèõÁ©çÂàÜ„ÄÅÈÉ®ÂàÜÁ©çÂàÜ„ÄÅÂêÑÁ®ÆÈñ¢Êï∞„ÅÆÁ©çÂàÜ„ÄÅÈù¢Á©ç„Éª‰ΩìÁ©ç„ÉªÂºßÈï∑", tips: "ÁΩÆÊèõÁ©çÂàÜ„ÅØ„Äå‰∏≠Ë∫´„Çít„Å®ÁΩÆ„Åè„Äç„ÅßË§áÈõë„Å™Á©çÂàÜ„ÇíÂçòÁ¥îÂåñ\nÈÉ®ÂàÜÁ©çÂàÜ„ÅØ„ÄåÁ©ç„ÅÆÂæÆÂàÜ„Äç„ÇíÈÄÜ„Å´‰Ωø„ÅÜ„ÄÇ‚à´fg'dx=fg-‚à´f'gdx\nÂõûËª¢‰Ωì„ÅÆ‰ΩìÁ©ç V=œÄ‚à´y¬≤dx „ÅØÈ†ªÂá∫„Éë„Çø„Éº„É≥", formulas: ["integration_by_parts","volume_rotation"] },
    "vectors": { name: "„Éô„ÇØ„Éà„É´", subject: "Êï∞Â≠¶C", category: "math3c", order: 21, summary: "Âπ≥Èù¢„Éô„ÇØ„Éà„É´„ÄÅÁ©∫Èñì„Éô„ÇØ„Éà„É´„ÄÅÂÜÖÁ©ç„ÄÅ‰ΩçÁΩÆ„Éô„ÇØ„Éà„É´„ÄÅ„Éô„ÇØ„Éà„É´ÊñπÁ®ãÂºè", tips: "„Éô„ÇØ„Éà„É´„ÅØ„ÄåÂêë„Åç„Å®Â§ß„Åç„Åï„Äç„ÇíÊåÅ„Å§Èáè„ÄÇÁü¢Âç∞„Åß„Ç§„É°„Éº„Ç∏\nÂÜÖÁ©ç a¬∑b = |a||b|cosŒ∏ „ÅØÂûÇÁõ¥Âà§ÂÆö„ÇÑËßíÂ∫¶Ë®àÁÆó„Å´‰Ωø„ÅÜ\n‰ΩçÁΩÆ„Éô„ÇØ„Éà„É´„Çí‰Ωø„ÅÜ„Å®ÂàÜÁÇπ„ÉªÈáçÂøÉ„ÅåÁ∞°Âçò„Å´Ê±Ç„Åæ„Çã", formulas: ["dot_product","dot_product_components"] },
    "plane_curves": { name: "Âπ≥Èù¢‰∏ä„ÅÆÊõ≤Á∑ö", subject: "Êï∞Â≠¶C", category: "math3c", order: 22, summary: "‰∫åÊ¨°Êõ≤Á∑öÔºàÊîæÁâ©Á∑ö„ÉªÊ•ïÂÜÜ„ÉªÂèåÊõ≤Á∑öÔºâ„ÄÅÂ™í‰ªãÂ§âÊï∞Ë°®Á§∫„ÄÅÊ•µÂ∫ßÊ®ô", tips: "‰∫åÊ¨°Êõ≤Á∑ö„ÅØÁÑ¶ÁÇπ„Å®Ê∫ñÁ∑ö„Åã„Çâ„ÅÆË∑ùÈõ¢„ÅÆÊØîÔºàÈõ¢ÂøÉÁéáÔºâ„ÅßÂàÜÈ°û\nÊ•ïÂÜÜ x¬≤/a¬≤+y¬≤/b¬≤=1„ÄÅÂèåÊõ≤Á∑ö x¬≤/a¬≤-y¬≤/b¬≤=1\nÊ•µÂ∫ßÊ®ô (r,Œ∏) „Å®Áõ¥‰∫§Â∫ßÊ®ô (x,y) „ÅÆÁõ∏‰∫íÂ§âÊèõ„ÅåÂü∫Êú¨", formulas: ["ellipse","hyperbola","polar_conversion"] },
    "complex_plane": { name: "Ë§áÁ¥†Êï∞Âπ≥Èù¢", subject: "Êï∞Â≠¶C", category: "math3c", order: 23, summary: "Ë§áÁ¥†Êï∞„ÅÆÂõ≥ÂΩ¢ÁöÑÊÑèÂë≥„ÄÅÊ•µÂΩ¢Âºè„ÄÅ„Éâ„Éª„É¢„Ç¢„Éñ„É´„ÅÆÂÆöÁêÜ„ÄÅÂõûËª¢„Å®Êã°Â§ß", tips: "Ë§áÁ¥†Êï∞„ÅÆÁ©ç„ÅØ„ÄåÁµ∂ÂØæÂÄ§„ÅÆÁ©ç„ÄÅÂÅèËßí„ÅÆÂíå„Äç\n„Éâ„Éª„É¢„Ç¢„Éñ„É´„ÅÆÂÆöÁêÜ (cosŒ∏+i¬∑sinŒ∏)^n = cos(nŒ∏)+i¬∑sin(nŒ∏)\nË§áÁ¥†Êï∞„ÅÆ„Åã„ÅëÁÆó„ÅØÂõûËª¢„Å®Êã°Â§ß„ÅÆÂêàÊàêÂ§âÊèõ", formulas: ["complex_polar","de_moivre"] },
};

const FORMULA_DB = {
    "square_of_sum": { name: "‰πóÊ≥ïÂÖ¨ÂºèÔºàÂíå„ÅÆ‰∫å‰πóÔºâ", latex: "(a+b)^2 = a^2 + 2ab + b^2", desc: "Â±ïÈñã„ÉªÂõ†Êï∞ÂàÜËß£„ÅÆÂü∫Êú¨„ÄÇÈÄÜÂêë„Åç„Å´‰Ωø„ÅÜ„Å®Âõ†Êï∞ÂàÜËß£„Å´„Å™„Çã" },
    "square_of_diff": { name: "‰πóÊ≥ïÂÖ¨ÂºèÔºàÂ∑Æ„ÅÆ‰∫å‰πóÔºâ", latex: "(a-b)^2 = a^2 - 2ab + b^2", desc: "Â±ïÈñã„ÉªÂõ†Êï∞ÂàÜËß£„ÅÆÂü∫Êú¨" },
    "diff_of_squares": { name: "‰πóÊ≥ïÂÖ¨ÂºèÔºàÂíå„Å®Â∑Æ„ÅÆÁ©çÔºâ", latex: "(a+b)(a-b) = a^2 - b^2", desc: "„Åü„Åô„ÅçÊéõ„Åë„ÅÆÂÖ¨Âºè„ÄÇÂõ†Êï∞ÂàÜËß£„Åß„ÇÇÊ¥ªÁî®" },
    "quadratic_formula": { name: "Ëß£„ÅÆÂÖ¨Âºè", latex: "x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}", desc: "‰∫åÊ¨°ÊñπÁ®ãÂºè ax¬≤+bx+c=0 „ÅÆËß£„ÄÇÂà§Âà•Âºè D=b¬≤-4ac „ÅßËß£„ÅÆÊï∞„Åå„Çè„Åã„Çã" },
    "quadratic_standard": { name: "‰∫åÊ¨°Èñ¢Êï∞„ÅÆÊ®ôÊ∫ñÂΩ¢", latex: "y = a(x-p)^2 + q", desc: "È†ÇÁÇπ(p,q)„ÄÅËª∏x=p„ÅÆ„Ç∞„É©„Éï„ÄÇÂπ≥ÊñπÂÆåÊàê„Åß„Åì„ÅÆÂΩ¢„Å´Â§âÂΩ¢„Åô„Çã" },
    "discriminant": { name: "Âà§Âà•Âºè", latex: "D = b^2 - 4ac", desc: "D>0:Áï∞„Å™„Çã2ÂÆüÊï∞Ëß£„ÄÅD=0:ÈáçËß£„ÄÅD<0:ÂÆüÊï∞Ëß£„Å™„Åó" },
    "sine_rule": { name: "Ê≠£Âº¶ÂÆöÁêÜ", latex: "\\frac{a}{\\sin A} = \\frac{b}{\\sin B} = \\frac{c}{\\sin C} = 2R", desc: "Â§ñÊé•ÂÜÜ„ÅÆÂçäÂæÑR„Å®Ëæ∫„ÉªËßí„ÅÆÈñ¢‰øÇ" },
    "cosine_rule": { name: "‰ΩôÂº¶ÂÆöÁêÜ", latex: "a^2 = b^2 + c^2 - 2bc\\cos A", desc: "3Ëæ∫„Å®1Ëßí„ÅÆÈñ¢‰øÇ„ÄÇ‰∏âÂπ≥Êñπ„ÅÆÂÆöÁêÜ„ÅÆ‰∏ÄËà¨Âåñ" },
    "trig_identity": { name: "‰∏âËßíÊØî„ÅÆÁõ∏‰∫íÈñ¢‰øÇ", latex: "\\sin^2\\theta + \\cos^2\\theta = 1", desc: "‰∏âËßíÊØî„ÅÆÊúÄ„ÇÇÂü∫Êú¨ÁöÑ„Å™Èñ¢‰øÇÂºè" },
    "triangle_area_sin": { name: "‰∏âËßíÂΩ¢„ÅÆÈù¢Á©ç", latex: "S = \\frac{1}{2}bc\\sin A", desc: "2Ëæ∫„Å®„Åù„ÅÆÈñì„ÅÆËßí„Åã„ÇâÈù¢Á©ç„ÇíÊ±Ç„ÇÅ„ÇãÂÖ¨Âºè" },
    "variance": { name: "ÂàÜÊï£„ÅÆÂÖ¨Âºè", latex: "s^2 = \\overline{x^2} - \\bar{x}^2", desc: "ÂàÜÊï£Ôºù‰∫å‰πó„ÅÆÂπ≥Âùá ‚àí Âπ≥Âùá„ÅÆ‰∫å‰πó" },
    "correlation": { name: "Áõ∏Èñ¢‰øÇÊï∞", latex: "r = \\frac{s_{xy}}{s_x \\cdot s_y}", desc: "ÂÖ±ÂàÜÊï£„Çí„Åù„Çå„Åû„Çå„ÅÆÊ®ôÊ∫ñÂÅèÂ∑Æ„ÅßÂâ≤„Å£„Åü„ÇÇ„ÅÆ„ÄÇ-1‚â§r‚â§1" },
    "permutation": { name: "È†ÜÂàó", latex: "{}_nP_r = \\frac{n!}{(n-r)!}", desc: "nÂÄã„Åã„ÇârÂÄã„ÇíÈÅ∏„Çì„Åß‰∏¶„Åπ„ÇãÂ†¥Âêà„ÅÆÊï∞" },
    "combination": { name: "ÁµÑÂêà„Åõ", latex: "{}_nC_r = \\frac{n!}{r!(n-r)!}", desc: "nÂÄã„Åã„ÇârÂÄã„ÇíÈÅ∏„Å∂Â†¥Âêà„ÅÆÊï∞" },
    "prob_addition": { name: "Á¢∫Áéá„ÅÆÂä†Ê≥ïÂÆöÁêÜ", latex: "P(A \\cup B) = P(A) + P(B) - P(A \\cap B)", desc: "„Äå„Åæ„Åü„ÅØ„Äç„ÅÆÁ¢∫Áéá„ÄÇÈáçË§á„ÇíÂºï„Åè" },
    "complementary_prob": { name: "‰Ωô‰∫ãË±°„ÅÆÁ¢∫Áéá", latex: "P(\\bar{A}) = 1 - P(A)", desc: "„ÄåÂ∞ë„Å™„Åè„Å®„ÇÇ1„Å§„Äç„ÅÆÂïèÈ°å„Åß‰Ωø„ÅÜ" },
    "menelaus": { name: "„É°„Éç„É©„Ç¶„Çπ„ÅÆÂÆöÁêÜ", latex: "\\frac{BD}{DC} \\cdot \\frac{CE}{EA} \\cdot \\frac{AF}{FB} = 1", desc: "‰∏âËßíÂΩ¢„ÅÆËæ∫„Åæ„Åü„ÅØ„Åù„ÅÆÂª∂Èï∑‰∏ä„ÅÆ3ÁÇπ„Åå‰∏ÄÁõ¥Á∑ö‰∏ä„Å´„ÅÇ„ÇãÊù°‰ª∂" },
    "ceva": { name: "„ÉÅ„Çß„Éê„ÅÆÂÆöÁêÜ", latex: "\\frac{BD}{DC} \\cdot \\frac{CE}{EA} \\cdot \\frac{AF}{FB} = 1", desc: "‰∏âËßíÂΩ¢„ÅÆÈ†ÇÁÇπ„Å®ÂØæËæ∫‰∏ä„ÅÆÁÇπ„ÇíÁµê„Å∂Á∑öÂàÜ„Åå1ÁÇπ„Åß‰∫§„Çè„ÇãÊù°‰ª∂" },
    "euclidean_algorithm": { name: "„É¶„Éº„ÇØ„É™„ÉÉ„Éâ„ÅÆ‰∫íÈô§Ê≥ï", latex: "\\gcd(a, b) = \\gcd(b, a \\bmod b)", desc: "Ââ≤„ÇäÁÆó„ÅÆ‰Ωô„Çä„Çí‰Ωø„Å£„Å¶ÊúÄÂ§ßÂÖ¨Á¥ÑÊï∞„ÇíÊ±Ç„ÇÅ„Çã„Ç¢„É´„Ç¥„É™„Ç∫„É†" },
    "binomial_theorem": { name: "‰∫åÈ†ÖÂÆöÁêÜ", latex: "(a+b)^n = \\sum_{r=0}^{n} {}_nC_r \\, a^{n-r} b^r", desc: "n‰πó„ÅÆÂ±ïÈñãÂÖ¨Âºè" },
    "remainder_theorem": { name: "Ââ∞‰Ωô„ÅÆÂÆöÁêÜ", latex: "P(a) = (P(x)\\text{„Çí}(x-a)\\text{„ÅßÂâ≤„Å£„Åü‰Ωô„Çä})", desc: "Â§öÈ†ÖÂºèP(x)„Çí(x-a)„ÅßÂâ≤„Å£„Åü‰Ωô„Çä„ÅØP(a)„Å´Á≠â„Åó„ÅÑ" },
    "vieta_formulas": { name: "Ëß£„Å®‰øÇÊï∞„ÅÆÈñ¢‰øÇ", latex: "\\alpha + \\beta = -\\frac{b}{a}, \\quad \\alpha\\beta = \\frac{c}{a}", desc: "‰∫åÊ¨°ÊñπÁ®ãÂºè„ÅÆ2Ëß£„ÅÆÂíå„Å®Á©ç" },
    "point_line_distance": { name: "ÁÇπ„Å®Áõ¥Á∑ö„ÅÆË∑ùÈõ¢", latex: "d = \\frac{|ax_0 + by_0 + c|}{\\sqrt{a^2 + b^2}}", desc: "ÁÇπ(x‚ÇÄ,y‚ÇÄ)„Å®Áõ¥Á∑ö ax+by+c=0 „ÅÆË∑ùÈõ¢" },
    "circle_equation": { name: "ÂÜÜ„ÅÆÊñπÁ®ãÂºè", latex: "(x-a)^2 + (y-b)^2 = r^2", desc: "‰∏≠ÂøÉ(a,b)„ÄÅÂçäÂæÑr„ÅÆÂÜÜ„ÅÆÊñπÁ®ãÂºè" },
    "sin_addition": { name: "Âä†Ê≥ïÂÆöÁêÜÔºàsinÔºâ", latex: "\\sin(\\alpha \\pm \\beta) = \\sin\\alpha\\cos\\beta \\pm \\cos\\alpha\\sin\\beta", desc: "‰∏âËßíÈñ¢Êï∞„ÅÆÂä†Ê≥ïÂÆöÁêÜ„ÄÇÂÄçËßí„ÉªÂçäËßíÂÖ¨Âºè„ÅÆÂÖÉ" },
    "cos_addition": { name: "Âä†Ê≥ïÂÆöÁêÜÔºàcosÔºâ", latex: "\\cos(\\alpha \\pm \\beta) = \\cos\\alpha\\cos\\beta \\mp \\sin\\alpha\\sin\\beta", desc: "‰∏âËßíÈñ¢Êï∞„ÅÆÂä†Ê≥ïÂÆöÁêÜ„ÄÇ¬±„ÅÆÁ¨¶Âè∑„ÅåÈÄÜ„Å´„Å™„Çã" },
    "trig_synthesis": { name: "‰∏âËßíÈñ¢Êï∞„ÅÆÂêàÊàê", latex: "a\\sin\\theta + b\\cos\\theta = \\sqrt{a^2+b^2}\\sin(\\theta + \\alpha)", desc: "ÊúÄÂ§ßÊúÄÂ∞èÂïèÈ°å„ÅÆÂøÖÈ†à„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ" },
    "double_angle_sin": { name: "ÂÄçËßí„ÅÆÂÖ¨ÂºèÔºàsinÔºâ", latex: "\\sin 2\\alpha = 2\\sin\\alpha\\cos\\alpha", desc: "Âä†Ê≥ïÂÆöÁêÜ„ÅßŒ±=Œ≤„Å®„Åó„Åü„ÇÇ„ÅÆ" },
    "double_angle_cos": { name: "ÂÄçËßí„ÅÆÂÖ¨ÂºèÔºàcosÔºâ", latex: "\\cos 2\\alpha = \\cos^2\\alpha - \\sin^2\\alpha", desc: "=2cos¬≤Œ±-1=1-2sin¬≤Œ±„ÅÆ3„Å§„ÅÆÂΩ¢„Çí‰Ωø„ÅÑÂàÜ„Åë„Çã" },
    "log_properties": { name: "ÂØæÊï∞„ÅÆÊÄßË≥™", latex: "\\log_a MN = \\log_a M + \\log_a N", desc: "ÂØæÊï∞„ÅÆÂíå‚ÜíÁ©ç„ÅÆÊ≥ïÂâá" },
    "log_base_change": { name: "Â∫ï„ÅÆÂ§âÊèõÂÖ¨Âºè", latex: "\\log_a b = \\frac{\\log_c b}{\\log_c a}", desc: "Â∫ï„ÇíÊèÉ„Åà„Åü„ÅÑ„Å®„Åç„Å´‰Ωø„ÅÜ" },
    "power_derivative": { name: "ÂæÆÂàÜ„ÅÆÂü∫Êú¨ÂÖ¨Âºè", latex: "(x^n)' = nx^{n-1}", desc: "„Åπ„Åç‰πóÈñ¢Êï∞„ÅÆÂæÆÂàÜ„ÄÇÊåáÊï∞„ÇíÂâç„Å´Âá∫„Åó„ÄÅ1‰∏ã„Åí„Çã" },
    "tangent_line": { name: "Êé•Á∑ö„ÅÆÊñπÁ®ãÂºè", latex: "y - f(a) = f'(a)(x - a)", desc: "Êõ≤Á∑ö‰∏ä„ÅÆÁÇπ„Å´„Åä„Åë„ÇãÊé•Á∑ö" },
    "area_one_sixth": { name: "Èù¢Á©ç„ÅÆ1/6ÂÖ¨Âºè", latex: "S = \\frac{|a|}{6}(\\beta - \\alpha)^3", desc: "ÊîæÁâ©Á∑ö„Å®xËª∏„ÅßÂõ≤„Åæ„Çå„ÅüÈù¢Á©ç" },
    "arithmetic_seq": { name: "Á≠âÂ∑ÆÊï∞Âàó„ÅÆ‰∏ÄËà¨È†Ö", latex: "a_n = a_1 + (n-1)d", desc: "ÂàùÈ†Öa‚ÇÅ„ÄÅÂÖ¨Â∑Æd„ÅÆÁ≠âÂ∑ÆÊï∞Âàó„ÅÆÁ¨¨nÈ†Ö" },
    "arithmetic_sum": { name: "Á≠âÂ∑ÆÊï∞Âàó„ÅÆÂíå", latex: "S_n = \\frac{n(a_1 + a_n)}{2}", desc: "ÂàùÈ†Ö„Å®Êú´È†Ö„ÅÆÂπ≥Âùá√óÈ†ÖÊï∞" },
    "geometric_seq": { name: "Á≠âÊØîÊï∞Âàó„ÅÆ‰∏ÄËà¨È†Ö", latex: "a_n = a_1 \\cdot r^{n-1}", desc: "ÂàùÈ†Öa‚ÇÅ„ÄÅÂÖ¨ÊØîr„ÅÆÁ≠âÊØîÊï∞Âàó„ÅÆÁ¨¨nÈ†Ö" },
    "geometric_sum": { name: "Á≠âÊØîÊï∞Âàó„ÅÆÂíå", latex: "S_n = \\frac{a_1(1 - r^n)}{1 - r}", desc: "ÂÖ¨ÊØîr‚â†1„ÅÆ„Å®„Åç„ÅÆÁ≠âÊØîÊï∞Âàó„ÅÆÂíå" },
    "z_score": { name: "Ê≠£Ë¶èÂàÜÂ∏É„ÅÆÊ®ôÊ∫ñÂåñ", latex: "Z = \\frac{X - \\mu}{\\sigma}", desc: "Ê≠£Ë¶èÂàÜÂ∏É„ÇíÊ®ôÊ∫ñÊ≠£Ë¶èÂàÜÂ∏ÉN(0,1)„Å´Â§âÊèõ" },
    "confidence_interval": { name: "‰ø°È†ºÂå∫ÈñìÔºà95%Ôºâ", latex: "\\bar{x} - 1.96\\frac{\\sigma}{\\sqrt{n}} \\leq \\mu \\leq \\bar{x} + 1.96\\frac{\\sigma}{\\sqrt{n}}", desc: "ÊØçÂπ≥ÂùáŒº„ÅÆ95%‰ø°È†ºÂå∫Èñì" },
    "infinite_geometric_series": { name: "ÁÑ°ÈôêÁ≠âÊØîÁ¥öÊï∞„ÅÆÂíå", latex: "\\sum_{n=1}^{\\infty} ar^{n-1} = \\frac{a}{1-r} \\quad (|r|<1)", desc: "ÂÖ¨ÊØî„ÅÆÁµ∂ÂØæÂÄ§„Åå1Êú™Ê∫Ä„ÅÆ„Å®„ÅçÂèéÊùü„Åô„Çã" },
    "e_definition": { name: "e„ÅÆÂÆöÁæ©", latex: "e = \\lim_{n \\to \\infty}\\left(1 + \\frac{1}{n}\\right)^n", desc: "Ëá™ÁÑ∂ÂØæÊï∞„ÅÆÂ∫ïe„ÅÆÂÆöÁæ©„ÄÇÁ¥Ñ 2.718" },
    "chain_rule": { name: "ÂêàÊàêÈñ¢Êï∞„ÅÆÂæÆÂàÜÔºàÈÄ£ÈéñÂæãÂâáÔºâ", latex: "\\{f(g(x))\\}' = f'(g(x)) \\cdot g'(x)", desc: "Â§ñÂÅ¥„ÅÆÂæÆÂàÜ√óÂÜÖÂÅ¥„ÅÆÂæÆÂàÜ" },
    "trig_derivatives": { name: "‰∏âËßíÈñ¢Êï∞„ÅÆÂæÆÂàÜ", latex: "(\\sin x)' = \\cos x, \\quad (\\cos x)' = -\\sin x", desc: "sin„ÅÆÂæÆÂàÜ„ÅØcos„ÄÅcos„ÅÆÂæÆÂàÜ„ÅØ-sin" },
    "exp_log_derivatives": { name: "ÊåáÊï∞„ÉªÂØæÊï∞Èñ¢Êï∞„ÅÆÂæÆÂàÜ", latex: "(e^x)' = e^x, \\quad (\\log x)' = \\frac{1}{x}", desc: "e^x„ÅØÂæÆÂàÜ„Åó„Å¶„ÇÇÂ§â„Çè„Çâ„Å™„ÅÑ" },
    "integration_by_parts": { name: "ÈÉ®ÂàÜÁ©çÂàÜ", latex: "\\int f(x)g'(x)dx = f(x)g(x) - \\int f'(x)g(x)dx", desc: "Á©ç„ÅÆÂæÆÂàÜ„ÇíÈÄÜ„Å´‰Ωø„ÅÜ„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ" },
    "volume_rotation": { name: "ÂõûËª¢‰Ωì„ÅÆ‰ΩìÁ©ç", latex: "V = \\pi\\int_a^b \\{f(x)\\}^2 dx", desc: "y=f(x)„ÇíxËª∏„ÅÆ„Åæ„Çè„Çä„Å´ÂõûËª¢„Åï„Åõ„Åü‰ΩìÁ©ç" },
    "dot_product": { name: "ÂÜÖÁ©ç", latex: "\\vec{a} \\cdot \\vec{b} = |\\vec{a}||\\vec{b}|\\cos\\theta", desc: "„Éô„ÇØ„Éà„É´„ÅÆÂÜÖÁ©ç„ÄÇÂûÇÁõ¥„ÅÆ„Å®„Åç0„Å´„Å™„Çã" },
    "dot_product_components": { name: "ÂÜÖÁ©çÔºàÊàêÂàÜË°®Á§∫Ôºâ", latex: "\\vec{a} \\cdot \\vec{b} = a_1b_1 + a_2b_2", desc: "ÊàêÂàÜ„Åß„ÅÆÂÜÖÁ©çË®àÁÆó" },
    "ellipse": { name: "Ê•ïÂÜÜ„ÅÆÊñπÁ®ãÂºè", latex: "\\frac{x^2}{a^2} + \\frac{y^2}{b^2} = 1", desc: "Èï∑Ëª∏a„ÄÅÁü≠Ëª∏b„ÅÆÊ•ïÂÜÜ" },
    "hyperbola": { name: "ÂèåÊõ≤Á∑ö„ÅÆÊñπÁ®ãÂºè", latex: "\\frac{x^2}{a^2} - \\frac{y^2}{b^2} = 1", desc: "Êº∏ËøëÁ∑ö y=¬±(b/a)x" },
    "polar_conversion": { name: "Ê•µÂ∫ßÊ®ô„Å®Áõ¥‰∫§Â∫ßÊ®ô„ÅÆÂ§âÊèõ", latex: "x = r\\cos\\theta, \\quad y = r\\sin\\theta", desc: "Ê•µÂ∫ßÊ®ô„Å®Áõ¥‰∫§Â∫ßÊ®ô„ÅÆÁõ∏‰∫íÂ§âÊèõ" },
    "complex_polar": { name: "Ë§áÁ¥†Êï∞„ÅÆÊ•µÂΩ¢Âºè", latex: "z = r(\\cos\\theta + i\\sin\\theta)", desc: "Áµ∂ÂØæÂÄ§r„ÄÅÂÅèËßíŒ∏„ÅßË§áÁ¥†Êï∞„ÇíË°®„ÅôÂΩ¢Âºè" },
    "de_moivre": { name: "„Éâ„Éª„É¢„Ç¢„Éñ„É´„ÅÆÂÆöÁêÜ", latex: "(\\cos\\theta + i\\sin\\theta)^n = \\cos n\\theta + i\\sin n\\theta", desc: "Ë§áÁ¥†Êï∞„ÅÆn‰πó„ÇíÊ•µÂΩ¢Âºè„ÅßÁ∞°Âçò„Å´Ë®àÁÆó„Åß„Åç„Çã" },
};

// unit_key list for GPT prompt
const UNIT_KEY_LIST = Object.entries(UNIT_DB).map(([k,v]) => k + ' (' + v.name + ')').join(', ');

// Legacy mapping: unit display name ‚Üí unit_key (for backward compat)
const UNIT_NAME_TO_KEY = {};
Object.entries(UNIT_DB).forEach(([key, unit]) => { UNIT_NAME_TO_KEY[unit.name] = key; });

const CATEGORY_LABELS = {
    "math1a": "Êï∞Â≠¶‚Ö†„ÉªA",
    "math2b": "Êï∞Â≠¶‚Ö°„ÉªB",
    "math3c": "Êï∞Â≠¶‚Ö¢„ÉªC",
};

function getUnitByKey(key) { return UNIT_DB[key] || null; }
function getFormulaByKey(key) { return FORMULA_DB[key] || null; }
function getFormulasForUnit(unitKey) {
    const unit = UNIT_DB[unitKey];
    if (!unit) return [];
    return unit.formulas.map(fk => FORMULA_DB[fk]).filter(Boolean);
}
function getCategoryForKey(unitKey) {
    const unit = UNIT_DB[unitKey];
    return unit ? unit.category : 'math1a';
}
function getCategoryLabel(unitKey) {
    return CATEGORY_LABELS[getCategoryForKey(unitKey)] || 'Êï∞Â≠¶';
}
// For legacy tag name ‚Üí category class
function getTagClass(tagName) {
    const key = UNIT_NAME_TO_KEY[tagName];
    return key ? UNIT_DB[key].category : 'math1a';
}

// ‚ïê‚ïê‚ïê Sub-unit Database ‚ïê‚ïê‚ïê
const SUB_UNIT_DB = {
    // Êï∞Â≠¶‚Ö† ‚Äî Êï∞„Å®Âºè
    "exp_expand":     { name: "Â±ïÈñã", unit_key: "expressions", order: 1, overview: "‰πóÊ≥ïÂÖ¨Âºè„Çí‰Ωø„Å£„ÅüÂºè„ÅÆÂ±ïÈñã" },
    "exp_factor":     { name: "Âõ†Êï∞ÂàÜËß£", unit_key: "expressions", order: 2, overview: "ÂÖ±ÈÄöÂõ†Êï∞„ÅÆ„Åè„Åè„ÇäÂá∫„Åó„ÄÅÂÖ¨Âºè„Çí‰Ωø„Å£„ÅüÂõ†Êï∞ÂàÜËß£" },
    "exp_real_ineq":  { name: "ÂÆüÊï∞„Å®1Ê¨°‰∏çÁ≠âÂºè", unit_key: "expressions", order: 3, overview: "ÂÆüÊï∞„ÅÆÂàÜÈ°û„Å®1Ê¨°‰∏çÁ≠âÂºè„ÅÆËß£Ê≥ï" },
    // Êï∞Â≠¶‚Ö† ‚Äî ÈõÜÂêà„Å®ÂëΩÈ°å
    "sets_set":       { name: "ÈõÜÂêà", unit_key: "sets_logic", order: 1, overview: "ÈõÜÂêà„ÅÆË°®„ÅóÊñπ„ÄÅÂÖ±ÈÄöÈÉ®ÂàÜ„ÉªÂíåÈõÜÂêà" },
    "sets_prop":      { name: "ÂëΩÈ°å„Å®Êù°‰ª∂", unit_key: "sets_logic", order: 2, overview: "ÂëΩÈ°å„ÅÆÁúüÂÅΩ„ÄÅÂøÖË¶ÅÊù°‰ª∂„ÉªÂçÅÂàÜÊù°‰ª∂" },
    // Êï∞Â≠¶‚Ö† ‚Äî ‰∫åÊ¨°Èñ¢Êï∞
    "qf_graph":       { name: "„Ç∞„É©„Éï„Å®Âπ≥ÊñπÂÆåÊàê", unit_key: "quadratic_function", order: 1, overview: "Âπ≥ÊñπÂÆåÊàê„Å´„Çà„ÇãÊ®ôÊ∫ñÂΩ¢„Å∏„ÅÆÂ§âÂΩ¢„Å®„Ç∞„É©„Éï„ÅÆÊèèÁîª" },
    "qf_maxmin":      { name: "ÊúÄÂ§ßÂÄ§„ÉªÊúÄÂ∞èÂÄ§", unit_key: "quadratic_function", order: 2, overview: "ÂÆöÁæ©Âüü‰ªò„Åç„ÅÆÊúÄÂ§ßÂÄ§„ÉªÊúÄÂ∞èÂÄ§ÂïèÈ°å" },
    "qf_eq_ineq":     { name: "‰∫åÊ¨°ÊñπÁ®ãÂºè„Éª‰∏çÁ≠âÂºè", unit_key: "quadratic_function", order: 3, overview: "Âà§Âà•Âºè„Çí‰Ωø„Å£„ÅüËß£„ÅÆÂàÜÊûê„ÄÅ‰∫åÊ¨°‰∏çÁ≠âÂºè„ÅÆËß£Ê≥ï" },
    // Êï∞Â≠¶‚Ö† ‚Äî Âõ≥ÂΩ¢„Å®Ë®àÈáè
    "tr_ratio":       { name: "‰∏âËßíÊØî„ÅÆÂÆöÁæ©", unit_key: "trigonometric_ratio", order: 1, overview: "sin, cos, tan„ÅÆÂÆöÁæ©„Å®Áõ∏‰∫íÈñ¢‰øÇ" },
    "tr_law":         { name: "Ê≠£Âº¶ÂÆöÁêÜ„Éª‰ΩôÂº¶ÂÆöÁêÜ", unit_key: "trigonometric_ratio", order: 2, overview: "Ê≠£Âº¶ÂÆöÁêÜ„Å®‰ΩôÂº¶ÂÆöÁêÜ„ÅÆ‰Ωø„ÅÑÂàÜ„Åë" },
    "tr_area":        { name: "Âõ≥ÂΩ¢„ÅÆË®àÈáè", unit_key: "trigonometric_ratio", order: 3, overview: "‰∏âËßíÊØî„Çí‰Ωø„Å£„ÅüÈù¢Á©ç„ÉªËæ∫„ÅÆÈï∑„Åï„ÅÆË®àÁÆó" },
    // Êï∞Â≠¶‚Ö† ‚Äî „Éá„Éº„Çø„ÅÆÂàÜÊûê
    "da_stats":       { name: "‰ª£Ë°®ÂÄ§„Å®Êï£Â∏ÉÂ∫¶", unit_key: "data_analysis", order: 1, overview: "Âπ≥ÂùáÂÄ§„ÄÅÂàÜÊï£„ÄÅÊ®ôÊ∫ñÂÅèÂ∑Æ„ÅÆË®àÁÆó" },
    "da_corr":        { name: "Áõ∏Èñ¢", unit_key: "data_analysis", order: 2, overview: "Êï£Â∏ÉÂõ≥„Å®Áõ∏Èñ¢‰øÇÊï∞„ÅÆË™≠„ÅøÂèñ„Çä" },
    // Êï∞Â≠¶A ‚Äî Â†¥Âêà„ÅÆÊï∞„Å®Á¢∫Áéá
    "prob_count":     { name: "Â†¥Âêà„ÅÆÊï∞", unit_key: "probability", order: 1, overview: "Ê®πÂΩ¢Âõ≥„ÄÅÂíå„ÅÆÊ≥ïÂâá„ÉªÁ©ç„ÅÆÊ≥ïÂâá" },
    "prob_perm_comb": { name: "È†ÜÂàó„ÉªÁµÑÂêà„Åõ", unit_key: "probability", order: 2, overview: "È†ÜÂàóP„ÄÅÁµÑÂêà„ÅõC„ÅÆË®àÁÆó„Å®‰Ωø„ÅÑÂàÜ„Åë" },
    "prob_basic":     { name: "Á¢∫Áéá„ÅÆÂü∫Êú¨", unit_key: "probability", order: 3, overview: "Á¢∫Áéá„ÅÆÂä†Ê≥ïÂÆöÁêÜ„ÄÅ‰Ωô‰∫ãË±°" },
    "prob_cond":      { name: "Êù°‰ª∂‰ªò„ÅçÁ¢∫Áéá", unit_key: "probability", order: 4, overview: "Êù°‰ª∂‰ªò„ÅçÁ¢∫Áéá„Å®Á¢∫Áéá„ÅÆ‰πóÊ≥ïÂÆöÁêÜ" },
    // Êï∞Â≠¶A ‚Äî Âõ≥ÂΩ¢„ÅÆÊÄßË≥™
    "geo_triangle":   { name: "‰∏âËßíÂΩ¢„ÅÆÊÄßË≥™", unit_key: "geometry_properties", order: 1, overview: "‰∫îÂøÉ„ÄÅËßí„ÅÆ‰∫åÁ≠âÂàÜÁ∑ö„ÅÆÊÄßË≥™" },
    "geo_circle":     { name: "ÂÜÜ„ÅÆÊÄßË≥™", unit_key: "geometry_properties", order: 2, overview: "ÂÜÜÂë®Ëßí„ÄÅÊé•Á∑ö„ÄÅÊñπ„Åπ„Åç„ÅÆÂÆöÁêÜ" },
    // Êï∞Â≠¶A ‚Äî Êï¥Êï∞„ÅÆÊÄßË≥™
    "int_divisor":    { name: "Á¥ÑÊï∞„Å®ÂÄçÊï∞", unit_key: "integer_properties", order: 1, overview: "Á¥†Âõ†Êï∞ÂàÜËß£„ÄÅÁ¥ÑÊï∞„ÅÆÂÄãÊï∞„Å®Á∑èÂíå" },
    "int_euclid":     { name: "‰∫íÈô§Ê≥ï„Å®‰∏çÂÆöÊñπÁ®ãÂºè", unit_key: "integer_properties", order: 2, overview: "„É¶„Éº„ÇØ„É™„ÉÉ„Éâ„ÅÆ‰∫íÈô§Ê≥ï„ÄÅ1Ê¨°‰∏çÂÆöÊñπÁ®ãÂºè" },
    // Êï∞Â≠¶‚Ö° ‚Äî Âºè„Å®Ë®ºÊòé
    "prf_binomial":   { name: "‰∫åÈ†ÖÂÆöÁêÜ", unit_key: "equations_proof", order: 1, overview: "‰∫åÈ†ÖÂÆöÁêÜ„Å®‰∏ÄËà¨È†Ö„ÅÆÂà©Áî®" },
    "prf_proof":      { name: "Á≠âÂºè„Éª‰∏çÁ≠âÂºè„ÅÆË®ºÊòé", unit_key: "equations_proof", order: 2, overview: "ÊÅíÁ≠âÂºè„ÅÆË®ºÊòé„ÄÅÁõ∏Âä†Áõ∏‰πóÂπ≥Âùá" },
    // Êï∞Â≠¶‚Ö° ‚Äî Ë§áÁ¥†Êï∞„Å®ÊñπÁ®ãÂºè
    "ceq_complex":    { name: "Ë§áÁ¥†Êï∞„ÅÆË®àÁÆó", unit_key: "complex_equations", order: 1, overview: "ËôöÊï∞Âçò‰Ωçi„Å®Ë§áÁ¥†Êï∞„ÅÆÂõõÂâáÊºîÁÆó" },
    "ceq_vieta":      { name: "Ëß£„Å®‰øÇÊï∞„ÅÆÈñ¢‰øÇ", unit_key: "complex_equations", order: 2, overview: "‰∫åÊ¨°ÊñπÁ®ãÂºè„ÅÆËß£„ÅÆÂíå„Å®Á©ç" },
    "ceq_higher":     { name: "È´òÊ¨°ÊñπÁ®ãÂºè", unit_key: "complex_equations", order: 3, overview: "Âõ†Êï∞ÂÆöÁêÜ„Çí‰Ωø„Å£„ÅüÈ´òÊ¨°ÊñπÁ®ãÂºè„ÅÆËß£Ê≥ï" },
    // Êï∞Â≠¶‚Ö° ‚Äî Âõ≥ÂΩ¢„Å®ÊñπÁ®ãÂºè
    "cg_line":        { name: "Áõ¥Á∑ö„ÅÆÊñπÁ®ãÂºè", unit_key: "coordinate_geometry", order: 1, overview: "2ÁÇπ„ÇíÈÄö„ÇãÁõ¥Á∑ö„ÄÅÁÇπ„Å®Áõ¥Á∑ö„ÅÆË∑ùÈõ¢" },
    "cg_circle":      { name: "ÂÜÜ„ÅÆÊñπÁ®ãÂºè", unit_key: "coordinate_geometry", order: 2, overview: "ÂÜÜ„ÅÆÊñπÁ®ãÂºè„Å®Áõ¥Á∑ö„Å®„ÅÆ‰ΩçÁΩÆÈñ¢‰øÇ" },
    "cg_region":      { name: "ËªåË∑°„Å®È†òÂüü", unit_key: "coordinate_geometry", order: 3, overview: "ËªåË∑°„ÅÆÊñπÁ®ãÂºè„ÄÅ‰∏çÁ≠âÂºè„ÅÆË°®„ÅôÈ†òÂüü" },
    // Êï∞Â≠¶‚Ö° ‚Äî ‰∏âËßíÈñ¢Êï∞
    "tf_graph":       { name: "‰∏âËßíÈñ¢Êï∞„ÅÆ„Ç∞„É©„Éï", unit_key: "trigonometric_function", order: 1, overview: "ÂºßÂ∫¶Ê≥ï„ÄÅÂë®Êúü„ÄÅÊåØÂπÖ" },
    "tf_addition":    { name: "Âä†Ê≥ïÂÆöÁêÜ", unit_key: "trigonometric_function", order: 2, overview: "sin, cos„ÅÆÂä†Ê≥ïÂÆöÁêÜ„Å®ÂÄçËßí„ÅÆÂÖ¨Âºè" },
    "tf_synthesis":   { name: "‰∏âËßíÈñ¢Êï∞„ÅÆÂêàÊàê", unit_key: "trigonometric_function", order: 3, overview: "a sinŒ∏ + b cosŒ∏„ÅÆÂêàÊàê„Å®ÊúÄÂ§ßÊúÄÂ∞è" },
    // Êï∞Â≠¶‚Ö° ‚Äî ÊåáÊï∞Èñ¢Êï∞„ÉªÂØæÊï∞Èñ¢Êï∞
    "el_exp":         { name: "ÊåáÊï∞Èñ¢Êï∞", unit_key: "exponential_logarithm", order: 1, overview: "ÊåáÊï∞Ê≥ïÂâá„Å®ÊåáÊï∞Èñ¢Êï∞„ÅÆ„Ç∞„É©„Éï" },
    "el_log":         { name: "ÂØæÊï∞Èñ¢Êï∞", unit_key: "exponential_logarithm", order: 2, overview: "ÂØæÊï∞„ÅÆÊÄßË≥™„ÄÅÂ∫ï„ÅÆÂ§âÊèõ" },
    // Êï∞Â≠¶‚Ö° ‚Äî ÂæÆÂàÜÊ≥ï
    "d2_deriv":       { name: "Â∞éÈñ¢Êï∞„Å®Êé•Á∑ö", unit_key: "differentiation_2", order: 1, overview: "„Åπ„Åç‰πó„ÅÆÂæÆÂàÜ„ÄÅÊé•Á∑ö„ÅÆÊñπÁ®ãÂºè" },
    "d2_app":         { name: "Èñ¢Êï∞„ÅÆÂ¢óÊ∏õ„ÉªÊ•µÂÄ§", unit_key: "differentiation_2", order: 2, overview: "Â¢óÊ∏õË°®„Å®Ê•µÂ§ßÊ•µÂ∞è„ÅÆÂà§ÂÆö" },
    // Êï∞Â≠¶‚Ö° ‚Äî Á©çÂàÜÊ≥ï
    "i2_basic":       { name: "‰∏çÂÆöÁ©çÂàÜ„ÉªÂÆöÁ©çÂàÜ", unit_key: "integration_2", order: 1, overview: "Â§öÈ†ÖÂºè„ÅÆÁ©çÂàÜË®àÁÆó" },
    "i2_area":        { name: "Èù¢Á©ç", unit_key: "integration_2", order: 2, overview: "ÂÆöÁ©çÂàÜ„Å´„Çà„ÇãÈù¢Á©ç„ÅÆË®àÁÆó" },
    // Êï∞Â≠¶B ‚Äî Êï∞Âàó
    "seq_arith_geo":  { name: "Á≠âÂ∑Æ„ÉªÁ≠âÊØîÊï∞Âàó", unit_key: "sequences", order: 1, overview: "‰∏ÄËà¨È†Ö„Å®Âíå„ÅÆÂÖ¨Âºè" },
    "seq_recurrence": { name: "Êº∏ÂåñÂºè", unit_key: "sequences", order: 2, overview: "ÁâπÊÄßÊñπÁ®ãÂºè„Å´„Çà„ÇãÊº∏ÂåñÂºè„ÅÆËß£Ê≥ï" },
    "seq_induction":  { name: "Êï∞Â≠¶ÁöÑÂ∏∞Á¥çÊ≥ï", unit_key: "sequences", order: 3, overview: "Êï∞Â≠¶ÁöÑÂ∏∞Á¥çÊ≥ï„Å´„Çà„ÇãË®ºÊòé" },
    // Êï∞Â≠¶B ‚Äî Áµ±Ë®àÁöÑ„Å™Êé®Ê∏¨
    "si_dist":        { name: "Á¢∫ÁéáÂàÜÂ∏É", unit_key: "statistical_inference", order: 1, overview: "Á¢∫ÁéáÂ§âÊï∞„ÅÆÊúüÂæÖÂÄ§„Å®ÂàÜÊï£" },
    "si_normal":      { name: "Ê≠£Ë¶èÂàÜÂ∏É„Å®Êé®ÂÆö", unit_key: "statistical_inference", order: 2, overview: "Ê≠£Ë¶èÂàÜÂ∏É„ÅÆÊ®ôÊ∫ñÂåñ„ÄÅ‰ø°È†ºÂå∫Èñì" },
    "si_test":        { name: "‰ªÆË™¨Ê§úÂÆö", unit_key: "statistical_inference", order: 3, overview: "Â∏∞ÁÑ°‰ªÆË™¨„Å®ÊúâÊÑèÊ∞¥Ê∫ñ" },
    // Êï∞Â≠¶‚Ö¢ ‚Äî Ê•µÈôê
    "lim_seq":        { name: "Êï∞Âàó„ÅÆÊ•µÈôê", unit_key: "limits", order: 1, overview: "ÂèéÊùü„ÉªÁô∫Êï£„ÅÆÂà§ÂÆö„ÄÅ„ÅØ„Åï„Åø„ÅÜ„Å°„ÅÆÂéüÁêÜ" },
    "lim_func":       { name: "Èñ¢Êï∞„ÅÆÊ•µÈôê", unit_key: "limits", order: 2, overview: "Èñ¢Êï∞„ÅÆÊ•µÈôê„Å®ÈÄ£Á∂öÊÄß" },
    // Êï∞Â≠¶‚Ö¢ ‚Äî ÂæÆÂàÜÊ≥ï
    "d3_comp":        { name: "ÂêàÊàêÈñ¢Êï∞„ÅÆÂæÆÂàÜ", unit_key: "differentiation_3", order: 1, overview: "ÈÄ£ÈéñÂæãÂâá„Å´„Çà„ÇãÂæÆÂàÜ" },
    "d3_trig_exp":    { name: "‰∏âËßí„ÉªÊåáÊï∞„ÉªÂØæÊï∞„ÅÆÂæÆÂàÜ", unit_key: "differentiation_3", order: 2, overview: "sin, cos, eÀ£, log x„ÅÆÂæÆÂàÜ" },
    "d3_param":       { name: "Â™í‰ªãÂ§âÊï∞Ë°®Á§∫", unit_key: "differentiation_3", order: 3, overview: "Â™í‰ªãÂ§âÊï∞Ë°®Á§∫„ÅÆÂæÆÂàÜ" },
    // Êï∞Â≠¶‚Ö¢ ‚Äî Á©çÂàÜÊ≥ï
    "i3_subst":       { name: "ÁΩÆÊèõÁ©çÂàÜ„ÉªÈÉ®ÂàÜÁ©çÂàÜ", unit_key: "integration_3", order: 1, overview: "ÁΩÆÊèõÁ©çÂàÜÊ≥ï„Å®ÈÉ®ÂàÜÁ©çÂàÜÊ≥ï" },
    "i3_vol":         { name: "Èù¢Á©ç„Éª‰ΩìÁ©ç", unit_key: "integration_3", order: 2, overview: "Èù¢Á©ç„ÄÅÂõûËª¢‰Ωì„ÅÆ‰ΩìÁ©ç„ÄÅÂºßÈï∑" },
    // Êï∞Â≠¶C ‚Äî „Éô„ÇØ„Éà„É´
    "vec_plane":      { name: "Âπ≥Èù¢„Éô„ÇØ„Éà„É´", unit_key: "vectors", order: 1, overview: "„Éô„ÇØ„Éà„É´„ÅÆÂä†Ê≥ï„ÉªÊ∏õÊ≥ï„ÄÅÂÆüÊï∞ÂÄç" },
    "vec_space":      { name: "Á©∫Èñì„Éô„ÇØ„Éà„É´", unit_key: "vectors", order: 2, overview: "Á©∫Èñì„Å´„Åä„Åë„Çã‰ΩçÁΩÆ„Éô„ÇØ„Éà„É´„Å®ÂÜÖÁ©ç" },
    // Êï∞Â≠¶C ‚Äî Âπ≥Èù¢‰∏ä„ÅÆÊõ≤Á∑ö
    "pc_conic":       { name: "‰∫åÊ¨°Êõ≤Á∑ö", unit_key: "plane_curves", order: 1, overview: "ÊîæÁâ©Á∑ö„ÉªÊ•ïÂÜÜ„ÉªÂèåÊõ≤Á∑ö" },
    "pc_param":       { name: "Â™í‰ªãÂ§âÊï∞Ë°®Á§∫", unit_key: "plane_curves", order: 2, overview: "Êõ≤Á∑ö„ÅÆÂ™í‰ªãÂ§âÊï∞Ë°®Á§∫" },
    "pc_polar":       { name: "Ê•µÂ∫ßÊ®ô", unit_key: "plane_curves", order: 3, overview: "Ê•µÂ∫ßÊ®ô„Å®Áõ¥‰∫§Â∫ßÊ®ô„ÅÆÂ§âÊèõ" },
    // Êï∞Â≠¶C ‚Äî Ë§áÁ¥†Êï∞Âπ≥Èù¢
    "cp_polar":       { name: "Ê•µÂΩ¢Âºè", unit_key: "complex_plane", order: 1, overview: "Ë§áÁ¥†Êï∞„ÅÆÊ•µÂΩ¢Âºè„Å®Âπæ‰ΩïÂ≠¶ÁöÑÊÑèÂë≥" },
    "cp_demoivre":    { name: "„Éâ„Éª„É¢„Ç¢„Éñ„É´„ÅÆÂÆöÁêÜ", unit_key: "complex_plane", order: 2, overview: "n‰πóÊ†π„Å®ÂõûËª¢" },
};

// Helper: get sub-units for a unit_key
function getSubUnitsForUnit(unitKey) {
    return Object.entries(SUB_UNIT_DB)
        .filter(([_, su]) => su.unit_key === unitKey)
        .sort((a, b) => a[1].order - b[1].order)
        .map(([key, su]) => ({ key, ...su }));
}

// ‚ïê‚ïê‚ïê Problem Database („Çµ„É≥„Éó„É´ÂïèÈ°å ‚Äî Notion„Åã„ÇâËøΩÂä†ÂèØËÉΩ) ‚ïê‚ïê‚ïê
const PROBLEM_DB = {
    // Êï∞„Å®Âºè ‚Äî Â±ïÈñã
    "exp_expand_01": {
        sub_unit_key: "exp_expand", order: 1, title: "‰πóÊ≥ïÂÖ¨Âºè„ÅÆÂü∫Êú¨",
        problem_text: "Ê¨°„ÅÆÂºè„ÇíÂ±ïÈñã„Åõ„Çà„ÄÇ\n$(x+3)^2$",
        difficulty: "Âü∫Êú¨", hint: "$(a+b)^2 = a^2 + 2ab + b^2$ „ÅÆÂÖ¨Âºè„Çí‰Ωø„Åä„ÅÜ"
    },
    "exp_expand_02": {
        sub_unit_key: "exp_expand", order: 2, title: "Âíå„Å®Â∑Æ„ÅÆÁ©ç",
        problem_text: "Ê¨°„ÅÆÂºè„ÇíÂ±ïÈñã„Åõ„Çà„ÄÇ\n$(2x+5)(2x-5)$",
        difficulty: "Âü∫Êú¨", hint: "$(a+b)(a-b) = a^2 - b^2$ „Çí‰Ωø„Åä„ÅÜ"
    },
    // Êï∞„Å®Âºè ‚Äî Âõ†Êï∞ÂàÜËß£
    "exp_factor_01": {
        sub_unit_key: "exp_factor", order: 1, title: "ÂÖ±ÈÄöÂõ†Êï∞„Å®ÂÖ¨Âºè",
        problem_text: "Ê¨°„ÅÆÂºè„ÇíÂõ†Êï∞ÂàÜËß£„Åõ„Çà„ÄÇ\n$x^2 + 6x + 9$",
        difficulty: "Âü∫Êú¨", hint: "Âíå„ÅÆ‰∫å‰πó„ÅÆÂΩ¢ $a^2 + 2ab + b^2$ „Å´„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Çà„ÅÜ"
    },
    "exp_factor_02": {
        sub_unit_key: "exp_factor", order: 2, title: "„Åü„Åô„ÅçÊéõ„Åë",
        problem_text: "Ê¨°„ÅÆÂºè„ÇíÂõ†Êï∞ÂàÜËß£„Åõ„Çà„ÄÇ\n$2x^2 + 5x + 3$",
        difficulty: "Ê®ôÊ∫ñ", hint: "„Åü„Åô„ÅçÊéõ„Åë„ÅßÂàÜËß£„Åß„Åç„ÇãÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÊé¢„Åù„ÅÜ"
    },
    // ‰∫åÊ¨°Èñ¢Êï∞ ‚Äî „Ç∞„É©„Éï„Å®Âπ≥ÊñπÂÆåÊàê
    "qf_graph_01": {
        sub_unit_key: "qf_graph", order: 1, title: "Âπ≥ÊñπÂÆåÊàê",
        problem_text: "Ê¨°„ÅÆ‰∫åÊ¨°Èñ¢Êï∞„ÅÆ„Ç∞„É©„Éï„ÅÆÈ†ÇÁÇπ„ÅÆÂ∫ßÊ®ô„ÇíÊ±Ç„ÇÅ„Çà„ÄÇ\n$y = x^2 - 4x + 7$",
        difficulty: "Âü∫Êú¨", hint: "Âπ≥ÊñπÂÆåÊàê„Åó„Å¶ $y = (x-p)^2 + q$ „ÅÆÂΩ¢„Å´„Åó„Çà„ÅÜ"
    },
    // ‰∫åÊ¨°Èñ¢Êï∞ ‚Äî ÊúÄÂ§ßÂÄ§„ÉªÊúÄÂ∞èÂÄ§
    "qf_maxmin_01": {
        sub_unit_key: "qf_maxmin", order: 1, title: "ÂÆöÁæ©Âüü„Å™„Åó„ÅÆÊúÄÂ∞èÂÄ§",
        problem_text: "‰∫åÊ¨°Èñ¢Êï∞ $y = x^2 - 6x + 11$ „ÅÆÊúÄÂ∞èÂÄ§„ÇíÊ±Ç„ÇÅ„Çà„ÄÇ",
        difficulty: "Âü∫Êú¨", hint: "Âπ≥ÊñπÂÆåÊàê„Åó„Å¶È†ÇÁÇπ„ÇíÊ±Ç„ÇÅ„Çà„ÅÜ"
    },
    // Âõ≥ÂΩ¢„Å®Ë®àÈáè ‚Äî Ê≠£Âº¶ÂÆöÁêÜ„Éª‰ΩôÂº¶ÂÆöÁêÜ
    "tr_law_01": {
        sub_unit_key: "tr_law", order: 1, title: "‰ΩôÂº¶ÂÆöÁêÜ",
        problem_text: "‰∏âËßíÂΩ¢ABC„Å´„Åä„ÅÑ„Å¶„ÄÅ$a=5$, $b=7$, $C=60¬∞$ „ÅÆ„Å®„Åç„ÄÅ$c$ „ÅÆÂÄ§„ÇíÊ±Ç„ÇÅ„Çà„ÄÇ",
        difficulty: "Ê®ôÊ∫ñ", hint: "$c^2 = a^2 + b^2 - 2ab\\cos C$ „Çí‰Ωø„Åä„ÅÜ"
    },
    // Á¢∫Áéá ‚Äî È†ÜÂàó„ÉªÁµÑÂêà„Åõ
    "prob_perm_comb_01": {
        sub_unit_key: "prob_perm_comb", order: 1, title: "ÁµÑÂêà„Åõ„ÅÆÂü∫Êú¨",
        problem_text: "10‰∫∫„ÅÆ‰∏≠„Åã„Çâ3‰∫∫„ÅÆÂßîÂì°„ÇíÈÅ∏„Å∂ÊñπÊ≥ï„ÅØ‰ΩïÈÄö„Çä„ÅÇ„Çã„Åã„ÄÇ",
        difficulty: "Âü∫Êú¨", hint: "È†ÜÁï™„ÇíËÄÉ„Åà„Å™„ÅÑ„ÅÆ„ÅßÁµÑÂêà„Åõ ${}_nC_r$ „Çí‰Ωø„Åä„ÅÜ"
    },
};

// Helper: get problems for a sub_unit_key
function getProblemsForSubUnit(subUnitKey) {
    return Object.entries(PROBLEM_DB)
        .filter(([_, p]) => p.sub_unit_key === subUnitKey)
        .sort((a, b) => a[1].order - b[1].order)
        .map(([key, p]) => ({ key, ...p }));
}

// ‚ïê‚ïê‚ïê System Prompt ‚ïê‚ïê‚ïê
const SYSTEM_PROMPT = `„ÅÇ„Å™„Åü„ÅØÈ´òÊ†°1„Äú2Âπ¥ÁîüÂêë„Åë„ÅÆ„ÄÅ„ÇÑ„Åï„Åó„ÅÑÊï∞Â≠¶„ÅÆÂÖàÁîüAI„Åß„Åô„ÄÇ
ÁîüÂæí„ÅåÊâãÊõ∏„Åç„ÅßËß£„ÅÑ„ÅüÊï∞Â≠¶„ÅÆÁ≠îÊ°à„ÅÆÁîªÂÉè„ÇíÂèó„ÅëÂèñ„Çä„ÄÅÊé°ÁÇπ„Åó„Åæ„Åô„ÄÇ

„ÄêÊï∞Âºè„É´„Éº„É´„Äë
- Ë™¨ÊòéÊñá‰∏≠„ÅÆÊï∞Âºè„ÅØÂøÖ„Åö $...$ „ÅßÂõ≤„ÇÄÔºà‰æã: $x = 3$Ôºâ
- score_explanation „ÅÆ‰∏≠„Åß„ÇÇÂêåÊßò

„ÄêÊé°ÁÇπÂü∫Ê∫ñ„Äë10ÁÇπÊ∫ÄÁÇπ
- 10ÁÇπ: ÂÆåÂÖ®Ê≠£Ëß£
- 7„Äú9ÁÇπ: ÊñπÈáù„ÅØÂêà„Å£„Å¶„ÅÑ„Çã„ÅåË®àÁÆó„Éü„Çπ„ÇÑË®òËø∞‰∏çË∂≥
- 4„Äú6ÁÇπ: ‰∏ÄÈÉ®Ê≠£„Åó„ÅÑ„ÅåÈáçË¶Å„Å™Ë™§„Çä„Åå„ÅÇ„Çã
- 1„Äú3ÁÇπ: ÊñπÈáù„Åã„ÇâÈñìÈÅï„Å£„Å¶„ÅÑ„Çã
- 0ÁÇπ: ÂÖ®„ÅèËß£„Åë„Å¶„ÅÑ„Å™„ÅÑ

„Äêunit_keys‰∏ÄË¶ß„Äë
${UNIT_KEY_LIST}

‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÖ¨Âºè„ÅØËøî„Åï„Å™„Åè„Å¶OKÔºà„Ç¢„Éó„É™ÂÅ¥„ÅßËá™ÂãïÂèñÂæó„Åó„Åæ„ÅôÔºâ„ÄÇ

{
  "score": 8,
  "score_message": "ÁÇπÊï∞„Å´Âøú„Åò„ÅüÁü≠„ÅÑ‰∏ÄË®ÄÔºà10ÁÇπ:„Åô„Å∞„Çâ„Åó„ÅÑÔºÅÂÆåÁíßÔºÅ/ 7-9ÁÇπ:„Åä„Åó„ÅÑÔºÅ„ÅÇ„Å®Â∞ë„ÅóÔºÅ/ 4-6ÁÇπ:„ÅÑ„ÅÑÁ∑ö„ÅÑ„Å£„Å¶„Çã„ÇàÔºÅ/ 0-3ÁÇπ:Âü∫Á§é„Åã„ÇâÁ¢∫Ë™ç„Åó„Çà„ÅÜÔºÅÔºâ",
  "unit_keys": ["„Åì„ÅÆÂïèÈ°å„ÅåÂ±û„Åô„ÇãÂçòÂÖÉkey„ÅÆ„É™„Çπ„Éà„ÄÇ‰∏ä„ÅÆunit_keys‰∏ÄË¶ß„Åã„ÇâÈÅ∏Êäû"],
  "score_explanation": "7ÁÇπ‰ª•‰∏ã„ÅÆÂ†¥Âêà„ÅÆ„ÅøË®òËºâ„ÄÇ„Å©„Åì„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Å¶„Å©„ÅÜ„Åô„Çå„Å∞Ê≠£Ëß£„Åß„Åç„Åü„Åã„ÄÇÊï∞Âºè„ÅØ $...$ „ÅßÂõ≤„ÇÄ„ÄÇ8ÁÇπ‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØ null",
  "hint": "7ÁÇπ‰ª•‰∏ã„ÅÆÂ†¥Âêà„ÄÅÊ¨°„Å´Ê∞ó„Çí„Å§„Åë„Çã„Éù„Ç§„É≥„Éà„ÄÇ8ÁÇπ‰ª•‰∏ä„Å™„Çâ null"
}`;

// ‚ïê‚ïê‚ïê API Call ‚ïê‚ïê‚ïê
async function analyze() {
    if (!selectedFile || !base64Image) return;
    if (!serverHasOpenAI && !apiKey) { renderError('APIË®≠ÂÆö„Åã„ÇâAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }

    const btn = document.getElementById('analyzeBtn');
    btn.classList.add('loading'); btn.disabled = true;
    document.getElementById('resultsSection').innerHTML = '';
    document.getElementById('resultsSection').style.display = 'none';

    const startTime = performance.now();

    try {
        let rawText = '';
        let processingTime = 0;
        let tokens = null;

        if (serverHasOpenAI) {
            // „Çµ„Éº„Éê„ÉºÂÅ¥„Éó„É≠„Ç≠„Ç∑ÁµåÁî±ÔºàAPI„Ç≠„Éº‰∏çË¶ÅÔºâ
            const response = await fetch('/api/grade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: base64Image,
                    systemPrompt: getSystemPrompt(),
                    userText: '„Åì„ÅÆÁ≠îÊ°à„ÇíÊé°ÁÇπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                }),
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => null);
                throw new Error(errData?.error || 'HTTP ' + response.status);
            }

            const data = await response.json();
            rawText = data.rawText || '';
            processingTime = data.processingTime || Math.round(performance.now() - startTime);
            tokens = data.tokens;
        } else {
            // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥Áõ¥Êé•Âëº„Å≥Âá∫„ÅóÔºà„É≠„Éº„Ç´„É´API„Ç≠„Éº‰ΩøÁî®Ôºâ
            const response = await fetch('https://api.openai.com/v1/responses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    input: [
                        { role: 'developer', content: getSystemPrompt() },
                        { role: 'user', content: [
                            { type: 'input_image', image_url: base64Image },
                            { type: 'input_text', text: '„Åì„ÅÆÁ≠îÊ°à„ÇíÊé°ÁÇπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' }
                        ]}
                    ],
                }),
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => null);
                throw new Error(errData?.error?.message || 'HTTP ' + response.status);
            }

            const data = await response.json();
            processingTime = Math.round(performance.now() - startTime);

            if (data.output) {
                for (const item of data.output) {
                    if (item.type === 'message' && item.content) {
                        for (const c of item.content) {
                            if (c.type === 'output_text') rawText += c.text;
                        }
                    }
                }
            }
            tokens = data.usage ? { input: data.usage.input_tokens, output: data.usage.output_tokens, total: data.usage.total_tokens } : null;
        }

        if (!rawText) throw new Error('API„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÁ©∫„Åß„Åô„ÄÇ');

        if (rawText.includes('```json')) rawText = rawText.split('```json')[1].split('```')[0].trim();
        else if (rawText.includes('```')) rawText = rawText.split('```')[1].split('```')[0].trim();

        const result = JSON.parse(rawText);
        renderResults(result, processingTime, tokens);
    } catch (err) {
        renderError(err.message);
    } finally {
        btn.classList.remove('loading'); btn.disabled = false;
    }
}

// ‚ïê‚ïê‚ïê Render Results ‚ïê‚ïê‚ïê
function renderResults(data, processingTime, tokens) {
    const section = document.getElementById('resultsSection');
    const score = data.score ?? 0;
    let html = '';

    // Resolve unit_keys (support both unit_keys and legacy unit_tags)
    const unitKeys = (data.unit_keys || []).map(k => {
        if (UNIT_DB[k]) return k;
        // Legacy: try to match by display name
        return UNIT_NAME_TO_KEY[k] || null;
    }).filter(Boolean);

    // Collect all formulas from matched units
    const allFormulas = [];
    const seenFormulas = new Set();
    unitKeys.forEach(uk => {
        getFormulasForUnit(uk).forEach(f => {
            const fKey = UNIT_DB[uk].formulas.find(fk => FORMULA_DB[fk] === f);
            if (fKey && !seenFormulas.has(fKey)) {
                seenFormulas.add(fKey);
                allFormulas.push(f);
            }
        });
    });

    // Score circle
    let level = 'low';
    if (score >= 10) level = 'perfect';
    else if (score >= 8) level = 'good';
    else if (score >= 5) level = 'mid';

    html += '<div class="score-display">';
    html += '<div class="score-circle ' + level + '">';
    html += '<span class="score-number">' + score + '</span>';
    html += '<span class="score-max">/ 10</span>';
    html += '</div>';
    html += '<div class="score-message ' + level + '">' + escHtml(data.score_message || '') + '</div>';
    html += '</div>';

    // Explanation (only for score <= 7)
    if (score <= 7 && data.score_explanation) {
        html += '<div class="result-card">';
        html += '<div class="result-title">üìù Ëß£Ë™¨</div>';
        html += '<div class="mixed-text">' + renderMixedText(data.score_explanation) + '</div>';

        // Formulas from DB
        if (allFormulas.length > 0) {
            html += '<div class="formula-box">';
            html += '<div class="formula-box-title">üìê Èñ¢ÈÄ£„Åô„ÇãÂÖ¨Âºè„ÉªÂÆöÁêÜ</div>';
            allFormulas.forEach(f => {
                html += '<div class="formula-item">';
                html += '<span class="formula-name">' + escHtml(f.name) + '</span>';
                if (f.latex) html += '<div class="formula-expr">' + renderMathBlock(f.latex) + '</div>';
                if (f.desc) html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">' + escHtml(f.desc) + '</div>';
                html += '</div>';
            });
            html += '</div>';
        }
        html += '</div>';

        // Hint
        if (data.hint) {
            html += '<div class="hint-card">';
            html += '<div class="result-title" style="color:var(--warning)">üí° Ê¨°„Å´Ê∞ó„Çí„Å§„Åë„Çã„Éù„Ç§„É≥„Éà</div>';
            html += '<div class="mixed-text">' + renderMixedText(data.hint) + '</div>';
            html += '</div>';
        }
    }

    // Formulas for high score too
    if (score >= 8 && allFormulas.length > 0) {
        html += '<div class="result-card">';
        html += '<div class="formula-box" style="margin-top:0">';
        html += '<div class="formula-box-title">üìê „Åì„ÅÆÂïèÈ°å„Åß‰Ωø„Å£„ÅüÂÖ¨Âºè</div>';
        allFormulas.forEach(f => {
            html += '<div class="formula-item">';
            html += '<span class="formula-name">' + escHtml(f.name) + '</span>';
            if (f.latex) html += '<div class="formula-expr">' + renderMathBlock(f.latex) + '</div>';
            html += '</div>';
        });
        html += '</div></div>';
    }

    // Unit tags (always shown) ‚Äî now using unit_keys
    if (unitKeys.length > 0) {
        html += '<div class="unit-section">';
        html += '<div class="result-title">üìö Èñ¢ÈÄ£„Åô„ÇãÂçòÂÖÉ</div>';
        html += '<div class="unit-tags">';
        unitKeys.forEach(uk => {
            const unit = UNIT_DB[uk];
            if (!unit) return;
            const cls = unit.category;
            const cat = CATEGORY_LABELS[unit.category] || 'Êï∞Â≠¶';
            html += '<button class="unit-tag ' + cls + '" onclick="navigateTo(\'unit\', {unitKey:\'' + uk + '\'})">';
            html += '<span style="font-size:11px;opacity:0.7">' + escHtml(cat) + '</span> ';
            html += escHtml(unit.name);
            html += ' <span class="unit-tag-arrow">‚Üí</span>';
            html += '</button>';
        });
        html += '</div></div>';
    }

    // Meta
    html += '<div class="meta-bar">';
    html += '<span class="meta-item"><span class="meta-label">Âá¶ÁêÜÊôÇÈñì:</span> ' + processingTime + 'ms</span>';
    if (tokens) html += '<span class="meta-item"><span class="meta-label">„Éà„Éº„ÇØ„É≥:</span> ' + tokens.total + '</span>';
    html += '<span class="meta-item"><span class="meta-label">„É¢„Éá„É´:</span> GPT-5 Nano</span>';
    html += '</div>';

    section.innerHTML = html;
    section.style.display = 'block';
    section.classList.add('visible');
}

function renderError(message) {
    const section = document.getElementById('resultsSection');
    section.innerHTML = '<div class="error-card"><div class="result-title">‚ùå „Ç®„É©„Éº</div>' +
        '<p style="margin-top:8px;font-size:14px;color:var(--error)">' + escHtml(message) + '</p></div>';
    section.style.display = 'block';
    section.classList.add('visible');
}

// ‚ïê‚ïê‚ïê Learning Panel (DB-based, instant, no API call) ‚ïê‚ïê‚ïê
function openLearning(unitKey) {
    const overlay = document.getElementById('learningOverlay');
    const title = document.getElementById('learningTitle');
    const body = document.getElementById('learningBody');

    const unit = UNIT_DB[unitKey];
    if (!unit) {
        body.innerHTML = '<div class="error-card"><p style="color:var(--error)">ÂçòÂÖÉ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</p></div>';
        overlay.classList.add('visible');
        document.body.style.overflow = 'hidden';
        return;
    }

    title.textContent = unit.name + ' ‚Äî ÂçòÂÖÉÂ≠¶Áøí';
    const formulas = getFormulasForUnit(unitKey);
    const cat = CATEGORY_LABELS[unit.category] || 'Êï∞Â≠¶';

    let html = '';

    // Subject badge + Overview
    html += '<div class="result-card" style="border-color:var(--border-accent)">';
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">';
    html += '<span class="unit-tag ' + unit.category + '" style="cursor:default;font-size:12px;padding:4px 10px">' + escHtml(cat) + '</span>';
    html += '</div>';
    html += '<div class="result-title">üìñ Ê¶ÇË¶Å</div>';
    html += '<div class="mixed-text">' + escHtml(unit.summary) + '</div>';
    html += '</div>';

    // Key Formulas from DB
    if (formulas.length > 0) {
        html += '<div class="result-card">';
        html += '<div class="result-title">üìê ÈáçË¶ÅÂÖ¨Âºè</div>';
        formulas.forEach(f => {
            html += '<div class="formula-box" style="margin-bottom:12px">';
            html += '<div class="formula-box-title">' + escHtml(f.name) + '</div>';
            if (f.latex) html += '<div class="math-block" style="margin:8px 0">' + renderMathBlock(f.latex) + '</div>';
            if (f.desc) html += '<div class="mixed-text" style="font-size:13px;color:var(--text-secondary)">' + escHtml(f.desc) + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }

    // Learning Points / Tips
    if (unit.tips) {
        const tips = unit.tips.split('\\n').filter(t => t.trim());
        if (tips.length > 0) {
            html += '<div class="hint-card">';
            html += '<div class="result-title" style="color:var(--warning)">üí° Â≠¶Áøí„Éù„Ç§„É≥„Éà</div>';
            html += '<ul style="margin-top:8px;padding-left:20px;line-height:1.9;font-size:14px">';
            tips.forEach(t => { html += '<li>' + renderMixedText(t) + '</li>'; });
            html += '</ul></div>';
        }
    }

    body.innerHTML = html;
    overlay.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function closeLearning(event) {
    if (event && event.target !== document.getElementById('learningOverlay')) return;
    document.getElementById('learningOverlay').classList.remove('visible');
    document.body.style.overflow = '';
}

// ‚ïê‚ïê‚ïê Navigation System ‚ïê‚ïê‚ïê
let currentScreen = 'home';
let navHistory = [];
let currentProblemContext = null; // { problemKey, subUnitKey, unitKey } or null (free mode)

function navigateTo(screenId, data) {
    if (currentScreen !== screenId) navHistory.push(currentScreen);
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const target = document.getElementById('screen-' + screenId);
    if (target) target.classList.add('active');
    currentScreen = screenId;

    // Reset upload state on screen change
    if (screenId !== 'problem') resetUploadState();

    // Screen-specific init
    if (screenId === 'home') renderHomeScreen();
    else if (screenId === 'unit' && data) renderUnitDetail(data.unitKey);
    else if (screenId === 'problem' && data) renderProblemScreen(data);
    else if (screenId === 'free') {
        currentProblemContext = null;
        navigateTo('problem', { mode: 'free' });
    }

    window.scrollTo(0, 0);
}

function navigateBack() {
    const prev = navHistory.pop() || 'home';
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const target = document.getElementById('screen-' + prev);
    if (target) target.classList.add('active');
    currentScreen = prev;
    if (prev === 'home') renderHomeScreen();
    // Re-render unit detail if going back to it (unitKey stored on element)
    if (prev === 'unit') {
        const title = document.getElementById('unitDetailTitle').textContent;
        // Find unit by name
        const entry = Object.entries(UNIT_DB).find(([_, u]) => u.name === title);
        if (entry) renderUnitDetail(entry[0]);
    }
    window.scrollTo(0, 0);
}

function resetUploadState() {
    selectedFile = null; base64Image = null;
    const pc = document.getElementById('previewContainer');
    if (pc) pc.classList.remove('visible');
    const up = document.getElementById('uploadPrompt');
    if (up) up.style.display = '';
    const ua = document.getElementById('uploadArea');
    if (ua) ua.classList.remove('has-image');
    const btn = document.getElementById('analyzeBtn');
    if (btn) { btn.disabled = true; }
    const bt = document.getElementById('btnText');
    if (bt) bt.textContent = 'Á≠îÊ°à„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
    const rs = document.getElementById('resultsSection');
    if (rs) { rs.innerHTML = ''; rs.style.display = 'none'; rs.classList.remove('visible'); }
}

// ‚ïê‚ïê‚ïê Home Screen: Unit Grid ‚ïê‚ïê‚ïê
let activeSubjectFilter = 'all';

function renderHomeScreen() {
    // Subject tabs
    const tabsEl = document.getElementById('subjectTabs');
    const subjects = [
        { key: 'all', label: '„Åô„Åπ„Å¶' },
        { key: 'math1a', label: 'Êï∞‚Ö†„ÉªA' },
        { key: 'math2b', label: 'Êï∞‚Ö°„ÉªB' },
        { key: 'math3c', label: 'Êï∞‚Ö¢„ÉªC' },
    ];
    tabsEl.innerHTML = subjects.map(s =>
        '<button class="subject-tab' + (activeSubjectFilter === s.key ? ' active' : '') +
        '" onclick="filterSubject(\'' + s.key + '\')">' + s.label + '</button>'
    ).join('');

    // Unit grid
    const gridEl = document.getElementById('unitGrid');
    const units = Object.entries(UNIT_DB)
        .filter(([_, u]) => activeSubjectFilter === 'all' || u.category === activeSubjectFilter)
        .sort((a, b) => a[1].order - b[1].order);

    gridEl.innerHTML = units.map(([key, u]) => {
        const subUnits = getSubUnitsForUnit(key);
        const problemCount = subUnits.reduce((sum, su) => sum + getProblemsForSubUnit(su.key).length, 0);
        const cat = CATEGORY_LABELS[u.category] || '';
        return '<div class="unit-card ' + u.category + '" onclick="navigateTo(\'unit\', {unitKey:\'' + key + '\'})">' +
            '<div class="unit-card-subject ' + u.category + '">' + escHtml(u.subject) + '</div>' +
            '<div class="unit-card-name">' + escHtml(u.name) + '</div>' +
            '<div class="unit-card-meta">' + subUnits.length + 'Â∞èÂçòÂÖÉ' +
            (problemCount > 0 ? ' ¬∑ ' + problemCount + 'Âïè' : '') + '</div>' +
            '</div>';
    }).join('');
}

function filterSubject(key) {
    activeSubjectFilter = key;
    renderHomeScreen();
}

// ‚ïê‚ïê‚ïê Unit Detail Screen ‚ïê‚ïê‚ïê
function renderUnitDetail(unitKey) {
    const unit = UNIT_DB[unitKey];
    if (!unit) return;

    document.getElementById('unitDetailTitle').textContent = unit.name;
    document.getElementById('unitDetailSubject').textContent = unit.subject;

    // Overview
    const overviewEl = document.getElementById('unitOverview');
    overviewEl.innerHTML = '<p>' + escHtml(unit.summary) + '</p>';

    // Sub-units
    const subUnits = getSubUnitsForUnit(unitKey);
    const listEl = document.getElementById('subunitList');

    if (subUnits.length === 0) {
        listEl.innerHTML = '<div class="empty-state">Â∞èÂçòÂÖÉ„ÅØ„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
        return;
    }

    let html = '';
    subUnits.forEach(su => {
        const problems = getProblemsForSubUnit(su.key);
        const cached = exerciseCache[su.key];
        const count = cached ? cached.length : problems.length;
        const problemLabel = count > 0 ? count + 'Âïè' : 'Ê∫ñÂÇô‰∏≠';
        const supabaseBadge = (supabaseClient && SUB_UNIT_TO_SKILLS[su.key]) ?
            ' <span style="font-size:10px;color:var(--accent);opacity:0.7">DB</span>' : '';
        html += '<div class="subunit-item" onclick="openSubUnit(\'' + su.key + '\', \'' + unitKey + '\')">';
        html += '<div><div class="subunit-name">' + escHtml(su.name) + supabaseBadge + '</div>';
        html += '<div class="subunit-meta">' + escHtml(su.overview) + ' ¬∑ ' + problemLabel + '</div></div>';
        html += '<span class="subunit-arrow">‚Ä∫</span>';
        html += '</div>';
    });
    listEl.innerHTML = html;
}

// ‚ïê‚ïê‚ïê Open Sub-unit ‚Üí Problem List or First Problem ‚ïê‚ïê‚ïê
async function openSubUnit(subUnitKey, unitKey) {
    // Supabase „Åã„ÇâÊºîÁøí„ÇíÂèñÂæóÔºàË®≠ÂÆöÊ∏à„Åø„ÅÆÂ†¥ÂêàÔºâ
    if (supabaseClient && SUB_UNIT_TO_SKILLS[subUnitKey]) {
        const exercises = await fetchExercisesForSubUnit(subUnitKey);
        if (exercises && exercises.length > 0) {
            currentSubUnitExercises = exercises;
            currentExerciseIndex = 0;
            navigateTo('problem', {
                mode: 'supabase',
                subUnitKey,
                unitKey,
                exerciseIndex: 0,
                totalExercises: exercises.length,
            });
            return;
        }
    }

    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éè„Éº„Éâ„Ç≥„Éº„Éâ„Åï„Çå„ÅüÂïèÈ°å
    currentSubUnitExercises = null;
    const problems = getProblemsForSubUnit(subUnitKey);
    if (problems.length === 0) {
        navigateTo('problem', { mode: 'empty', subUnitKey, unitKey });
        return;
    }
    navigateTo('problem', {
        mode: 'problem',
        subUnitKey,
        unitKey,
        problemKey: problems[0].key,
        problemIndex: 0,
        totalProblems: problems.length,
    });
}

// ‚ïê‚ïê‚ïê Problem Screen ‚ïê‚ïê‚ïê
function renderProblemScreen(data) {
    const titleEl = document.getElementById('problemScreenTitle');
    const subEl = document.getElementById('problemScreenSub');
    const displayEl = document.getElementById('problemDisplay');
    const diffEl = document.getElementById('problemDifficulty');
    const textEl = document.getElementById('problemText');
    const hintEl = document.getElementById('problemHint');
    const answerArea = document.getElementById('answerArea');
    const uploadMain = document.getElementById('uploadMain');

    resetUploadState();
    answerArea.style.display = 'none';
    answerArea.innerHTML = '';
    uploadMain.style.display = '';

    if (data.mode === 'free') {
        currentProblemContext = null;
        titleEl.textContent = '„Éï„É™„ÉºÊé°ÁÇπ';
        subEl.textContent = 'Â•Ω„Åç„Å™ÂïèÈ°å„ÅÆÁ≠îÊ°à„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ';
        displayEl.style.display = 'none';
        document.getElementById('problemBackBtn').onclick = function() { navigateTo('home'); };
        return;
    }

    if (data.mode === 'empty') {
        const su = SUB_UNIT_DB[data.subUnitKey];
        titleEl.textContent = su ? su.name : 'Â∞èÂçòÂÖÉ';
        subEl.textContent = 'ÂïèÈ°å„ÇíÊ∫ñÂÇô‰∏≠„Åß„Åô';
        displayEl.style.display = 'none';
        document.getElementById('problemBackBtn').onclick = function() {
            navigateTo('unit', { unitKey: data.unitKey });
        };
        const rs = document.getElementById('resultsSection');
        rs.innerHTML = '<div class="empty-state" style="padding:60px 20px">' +
            '<div style="font-size:48px;margin-bottom:16px">üìù</div>' +
            '<div style="font-size:16px;font-weight:600;margin-bottom:8px">ÂïèÈ°å„ÇíÊ∫ñÂÇô‰∏≠„Åß„Åô</div>' +
            '<div style="font-size:13px">„Åì„ÅÆÂ∞èÂçòÂÖÉ„ÅÆÊºîÁøíÂïèÈ°å„ÅØËøëÊó•ËøΩÂä†‰∫àÂÆö„Åß„Åô„ÄÇ<br>„Éï„É™„ÉºÊé°ÁÇπ„É¢„Éº„Éâ„Åß„ÅØ„ÄÅ‰ªªÊÑè„ÅÆÂïèÈ°å„ÅÆÁ≠îÊ°à„ÇíÊé°ÁÇπ„Åß„Åç„Åæ„Åô„ÄÇ</div>' +
            '</div>';
        rs.style.display = 'block';
        rs.classList.add('visible');
        return;
    }

    // ‚ïê‚ïê‚ïê Supabase ÊºîÁøí„É¢„Éº„Éâ ‚ïê‚ïê‚ïê
    if (data.mode === 'supabase' && currentSubUnitExercises) {
        const exercise = currentSubUnitExercises[data.exerciseIndex];
        const su = SUB_UNIT_DB[data.subUnitKey];
        const unit = UNIT_DB[data.unitKey];
        if (!exercise || !su) return;

        currentProblemContext = {
            subUnitKey: data.subUnitKey,
            unitKey: data.unitKey,
            problemText: exercise.question_text,
            problemIndex: data.exerciseIndex,
            totalProblems: data.totalExercises,
        };

        titleEl.textContent = su.name;
        subEl.textContent = (unit ? unit.name + ' ¬∑ ' : '') + 'ÂïèÈ°å ' + (data.exerciseIndex + 1) + ' / ' + data.totalExercises;

        displayEl.style.display = 'block';
        const diffLabels = { 1: 'Âü∫Êú¨', 2: 'Âü∫Êú¨', 3: 'Ê®ôÊ∫ñ', 4: 'ÂøúÁî®', 5: 'ÂøúÁî®' };
        const diffClasses = { 1: 'basic', 2: 'basic', 3: 'standard', 4: 'advanced', 5: 'advanced' };
        const diffLabel = diffLabels[exercise.difficulty] || 'Ê®ôÊ∫ñ';
        const diffClass = diffClasses[exercise.difficulty] || 'standard';
        const tmpl = (exercise.input_template || '').toUpperCase();
        const isSelect = tmpl === 'SELECT_BASIC' || tmpl === 'SELECT_MULTI';
        const templateBadge = '<span class="template-badge ' + (isSelect ? 'select' : 'image') + '">' +
            (isSelect ? 'üîò ÈÅ∏Êäû' : 'üì∏ Ë®òËø∞') + '</span>';
        diffEl.innerHTML = '<span class="diff-badge ' + diffClass + '">' + escHtml(diffLabel) + '</span> ' + templateBadge;
        textEl.innerHTML = renderMixedText(exercise.question_text);

        // „Éí„É≥„ÉàÈùûË°®Á§∫ÔºàSupabaseÊºîÁøí„Å´„ÅØhint„Éï„Ç£„Éº„É´„Éâ„Å™„ÅóÔºâ
        hintEl.style.display = 'none';

        // Êàª„Çã„Éú„Çø„É≥
        document.getElementById('problemBackBtn').onclick = function() {
            currentSubUnitExercises = null;
            navigateTo('unit', { unitKey: data.unitKey });
        };

        // input_template „Åß UI „ÇíÂàá„ÇäÊõø„Åà
        if (tmpl === 'SELECT_BASIC' && exercise.choices && exercise.choices.length > 0) {
            uploadMain.style.display = 'none';
            answerArea.style.display = 'block';
            renderSelectBasic(exercise, answerArea, function(correct) {
                addSupabaseExerciseNav(data);
            });
        } else if (tmpl === 'SELECT_MULTI' && exercise.choices && exercise.choices.length > 0) {
            uploadMain.style.display = 'none';
            answerArea.style.display = 'block';
            renderSelectMulti(exercise, answerArea, function(correct) {
                addSupabaseExerciseNav(data);
            });
        } else {
            // IMAGE / TEXT Á≥ª ‚Üí Êó¢Â≠ò„ÅÆÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ UI
            uploadMain.style.display = '';
            answerArea.style.display = 'none';
        }

        // ÂïèÈ°å„Éä„Éì
        addSupabaseExerciseNav(data);
        return;
    }

    // ‚ïê‚ïê‚ïê ÂæìÊù•„ÅÆ„Éè„Éº„Éâ„Ç≥„Éº„ÉâÂïèÈ°å„É¢„Éº„Éâ ‚ïê‚ïê‚ïê
    const problem = PROBLEM_DB[data.problemKey];
    const su = SUB_UNIT_DB[data.subUnitKey];
    const unit = UNIT_DB[data.unitKey];
    if (!problem || !su) return;

    currentProblemContext = {
        problemKey: data.problemKey,
        subUnitKey: data.subUnitKey,
        unitKey: data.unitKey,
        problemText: problem.problem_text,
        problemIndex: data.problemIndex,
        totalProblems: data.totalProblems,
    };

    titleEl.textContent = su.name;
    subEl.textContent = (unit ? unit.name + ' ¬∑ ' : '') + 'ÂïèÈ°å ' + (data.problemIndex + 1) + ' / ' + data.totalProblems;

    // Problem display
    displayEl.style.display = 'block';
    const diffClass = problem.difficulty === 'Âü∫Êú¨' ? 'basic' : problem.difficulty === 'Ê®ôÊ∫ñ' ? 'standard' : 'advanced';
    diffEl.innerHTML = '<span class="diff-badge ' + diffClass + '">' + escHtml(problem.difficulty) + '</span> ' + escHtml(problem.title);
    textEl.innerHTML = renderMixedText(problem.problem_text);

    // Hint
    if (problem.hint) {
        hintEl.style.display = 'block';
        hintEl.innerHTML = 'üí° „Éí„É≥„Éà„ÇíË¶ã„Çã';
        hintEl.classList.remove('revealed');
        hintEl.dataset.hint = problem.hint;
    } else {
        hintEl.style.display = 'none';
    }

    // Back button
    document.getElementById('problemBackBtn').onclick = function() {
        navigateTo('unit', { unitKey: data.unitKey });
    };

    // Add problem navigation (prev/next) below results
    addProblemNav(data);
}

function revealHint(el) {
    if (el.classList.contains('revealed')) return;
    el.classList.add('revealed');
    el.innerHTML = 'üí° ' + renderMixedText(el.dataset.hint);
}

function addProblemNav(data) {
    // Remove existing nav if any
    const existing = document.getElementById('problemNav');
    if (existing) existing.remove();

    const problems = getProblemsForSubUnit(data.subUnitKey);
    if (problems.length <= 1) return;

    const nav = document.createElement('div');
    nav.id = 'problemNav';
    nav.style.cssText = 'display:flex;justify-content:space-between;padding:16px 20px;gap:12px;';

    const prevBtn = data.problemIndex > 0
        ? '<button class="nav-back" onclick="gotoProblem(' + (data.problemIndex - 1) + ',\'' + data.subUnitKey + '\',\'' + data.unitKey + '\')">‚Üê Ââç„ÅÆÂïèÈ°å</button>'
        : '<span></span>';
    const nextBtn = data.problemIndex < problems.length - 1
        ? '<button class="nav-back" onclick="gotoProblem(' + (data.problemIndex + 1) + ',\'' + data.subUnitKey + '\',\'' + data.unitKey + '\')" style="border-color:var(--accent);color:var(--accent)">Ê¨°„ÅÆÂïèÈ°å ‚Üí</button>'
        : '<span></span>';

    nav.innerHTML = prevBtn + '<div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)">' +
        problems.map((_, i) => '<span style="width:8px;height:8px;border-radius:50%;background:' +
        (i === data.problemIndex ? 'var(--accent)' : 'var(--border)') + '"></span>').join('') +
        '</div>' + nextBtn;

    // Insert after problem display
    const display = document.getElementById('problemDisplay');
    display.parentNode.insertBefore(nav, display.nextSibling);
}

function gotoProblem(index, subUnitKey, unitKey) {
    const problems = getProblemsForSubUnit(subUnitKey);
    if (index < 0 || index >= problems.length) return;
    renderProblemScreen({
        mode: 'problem',
        subUnitKey,
        unitKey,
        problemKey: problems[index].key,
        problemIndex: index,
        totalProblems: problems.length,
    });
}

// ‚ïê‚ïê‚ïê Supabase ÊºîÁøí„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ‚ïê‚ïê‚ïê
function addSupabaseExerciseNav(data) {
    const existing = document.getElementById('supabaseNav');
    if (existing) existing.remove();

    if (!currentSubUnitExercises || currentSubUnitExercises.length <= 1) return;

    const nav = document.createElement('div');
    nav.id = 'supabaseNav';
    nav.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:16px 20px;gap:12px;max-width:800px;margin:0 auto;';

    const prevBtn = data.exerciseIndex > 0
        ? '<button class="nav-back" onclick="gotoSupabaseExercise(' + (data.exerciseIndex - 1) + ',\'' + data.subUnitKey + '\',\'' + data.unitKey + '\')">‚Üê Ââç„ÅÆÂïèÈ°å</button>'
        : '<span></span>';
    const nextBtn = data.exerciseIndex < currentSubUnitExercises.length - 1
        ? '<button class="nav-back" onclick="gotoSupabaseExercise(' + (data.exerciseIndex + 1) + ',\'' + data.subUnitKey + '\',\'' + data.unitKey + '\')" style="border-color:var(--accent);color:var(--accent)">Ê¨°„ÅÆÂïèÈ°å ‚Üí</button>'
        : '<span></span>';

    const dots = currentSubUnitExercises.map((ex, i) => {
        const tmpl = (ex.input_template || '').toUpperCase();
        const color = i === data.exerciseIndex ? 'var(--accent)' :
            (tmpl.startsWith('SELECT') ? 'rgba(99,179,237,0.5)' : 'var(--border)');
        return '<span style="width:8px;height:8px;border-radius:50%;background:' + color + '" title="' + escHtml(ex.input_template) + '"></span>';
    }).join('');

    nav.innerHTML = prevBtn +
        '<div style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-muted);flex-wrap:wrap;justify-content:center">' + dots + '</div>' +
        nextBtn;

    // answerArea „Åã uploadMain „ÅÆÂæå„Å´ÊåøÂÖ•
    const answerArea = document.getElementById('answerArea');
    if (answerArea.style.display !== 'none') {
        answerArea.appendChild(nav);
    } else {
        const uploadMain = document.getElementById('uploadMain');
        uploadMain.parentNode.insertBefore(nav, uploadMain.nextSibling);
    }
}

function gotoSupabaseExercise(index, subUnitKey, unitKey) {
    if (!currentSubUnitExercises || index < 0 || index >= currentSubUnitExercises.length) return;
    currentExerciseIndex = index;
    renderProblemScreen({
        mode: 'supabase',
        subUnitKey,
        unitKey,
        exerciseIndex: index,
        totalExercises: currentSubUnitExercises.length,
    });
}

// ‚ïê‚ïê‚ïê Modified analyze() with problem context ‚ïê‚ïê‚ïê
function getSystemPrompt() {
    if (currentProblemContext && currentProblemContext.problemText) {
        return SYSTEM_PROMPT + `\n\n„ÄêÂá∫È°å„Åï„Çå„ÅüÂïèÈ°å„Äë\n${currentProblemContext.problemText}\n\n„Åì„ÅÆÂïèÈ°å„Å´ÂØæ„Åô„ÇãÊâãÊõ∏„Åç„ÅÆÁ≠îÊ°à„ÇíÊé°ÁÇπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇunit_keys„Å´„ÅØ "${currentProblemContext.unitKey}" „ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
    }
    return SYSTEM_PROMPT;
}

// ‚ïê‚ïê‚ïê Init: Render Home Screen ‚ïê‚ïê‚ïê
renderHomeScreen();
</script>
</body>
</html>
