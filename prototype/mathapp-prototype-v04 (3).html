<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MathApp - æ•°å­¦å­¦ç¿’</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a26;
            --bg-card-hover: #22222f;
            --accent: #6c63ff;
            --accent-glow: rgba(108, 99, 255, 0.3);
            --accent-soft: rgba(108, 99, 255, 0.12);
            --success: #2dd4a8;
            --success-soft: rgba(45, 212, 168, 0.12);
            --error: #ff6b6b;
            --error-soft: rgba(255, 107, 107, 0.12);
            --warning: #ffc857;
            --warning-soft: rgba(255, 200, 87, 0.12);
            --text-primary: #e8e6f0;
            --text-secondary: #8a879a;
            --text-muted: #5a576b;
            --border: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(108, 99, 255, 0.3);
            --radius: 16px;
            --radius-sm: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: ''; position: fixed; inset: 0;
            background: linear-gradient(rgba(108,99,255,0.03) 1px,transparent 1px),
                        linear-gradient(90deg,rgba(108,99,255,0.03) 1px,transparent 1px);
            background-size: 60px 60px; pointer-events: none; z-index: 0;
        }
        .header {
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(20px); background: rgba(10,10,15,0.8);
            border-bottom: 1px solid var(--border); padding: 16px 24px;
        }
        .header-inner {
            max-width: 800px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            border-radius: 10px; display: flex; align-items: center;
            justify-content: center; font-size: 18px; font-weight: 900; color: white;
        }
        .logo-text { font-weight: 700; font-size: 18px; letter-spacing: -0.5px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .badge {
            font-size: 11px; font-weight: 500; color: var(--accent);
            background: var(--accent-soft); padding: 4px 10px;
            border-radius: 20px; border: 1px solid var(--border-accent);
        }
        .settings-btn {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
            background: transparent; color: var(--text-secondary); cursor: pointer;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .settings-btn:hover { background: var(--bg-card); color: var(--text-primary); }
        .main {
            position: relative; z-index: 1;
            max-width: 800px; margin: 0 auto; padding: 32px 24px 100px;
        }

        /* API Key - collapsible */
        .api-key-section {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 24px; overflow: hidden;
        }
        .api-key-header {
            padding: 14px 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            font-size: 13px; font-weight: 500; color: var(--text-secondary);
        }
        .api-key-header:hover { color: var(--text-primary); }
        .api-key-arrow { transition: transform 0.3s; }
        .api-key-section.open .api-key-arrow { transform: rotate(180deg); }
        .api-key-body { display: none; padding: 0 20px 16px; }
        .api-key-section.open .api-key-body { display: block; }
        .api-key-row { display: flex; gap: 8px; }
        .api-key-input {
            flex: 1; padding: 10px 14px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
            font-size: 13px; outline: none;
        }
        .api-key-input:focus { border-color: var(--accent); }
        .api-key-save {
            padding: 10px 18px; border-radius: var(--radius-sm);
            border: 1px solid var(--border-accent); background: var(--accent-soft);
            color: var(--accent); font-family: inherit; font-size: 13px;
            font-weight: 600; cursor: pointer;
        }
        .api-key-save:hover { background: var(--accent); color: white; }
        .api-key-status { font-size: 12px; margin-top: 8px; color: var(--text-muted); }
        .api-key-status.saved { color: var(--success); }

        /* Upload */
        .upload-area {
            border: 2px dashed var(--border); border-radius: var(--radius);
            padding: 48px 24px; text-align: center; cursor: pointer;
            transition: all 0.3s; background: var(--bg-secondary); position: relative;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent); background: rgba(108,99,255,0.05);
        }
        .upload-area.has-image { padding: 16px; border-style: solid; border-color: var(--border-accent); }
        .upload-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
        .upload-title { font-size: 16px; font-weight: 500; margin-bottom: 8px; }
        .upload-subtitle { font-size: 13px; color: var(--text-secondary); }
        .upload-actions { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
        .upload-btn {
            padding: 10px 20px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-primary); font-family: inherit; font-size: 13px;
            font-weight: 500; cursor: pointer; display: flex; align-items: center;
            gap: 6px; transition: all 0.2s;
        }
        .upload-btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }
        .preview-container { position: relative; display: none; }
        .preview-container.visible { display: block; }
        .preview-img { max-width: 100%; max-height: 400px; border-radius: var(--radius-sm); display: block; margin: 0 auto; }
        .preview-remove {
            position: absolute; top: 8px; right: 8px;
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: rgba(0,0,0,0.7); color: white; cursor: pointer;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
        }
        #fileInput, #cameraInput { display: none; }

        /* Analyze button */
        .analyze-section { margin-top: 24px; }
        .analyze-btn {
            width: 100%; padding: 16px 32px; border: none; border-radius: var(--radius);
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white; font-family: inherit; font-size: 16px; font-weight: 700;
            cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;
        }
        .analyze-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
        .analyze-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .analyze-btn.loading { pointer-events: none; }
        .analyze-btn.loading .btn-text { opacity: 0; }
        .spinner { display: none; position: absolute; inset: 0; align-items: center; justify-content: center; }
        .loading .spinner { display: flex; }
        .spinner-dot {
            width: 8px; height: 8px; border-radius: 50%; background: white;
            margin: 0 4px; animation: bounce 1.4s infinite ease-in-out both;
        }
        .spinner-dot:nth-child(1) { animation-delay: -0.32s; }
        .spinner-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%,80%,100%{transform:scale(0)} 40%{transform:scale(1)} }

        /* â”€â”€ Score Display â”€â”€ */
        .score-display {
            text-align: center; padding: 32px 24px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 16px;
            animation: fadeInUp 0.4s ease;
        }
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 16px; position: relative;
        }
        .score-circle::before {
            content: ''; position: absolute; inset: 0;
            border-radius: 50%; border: 6px solid var(--border);
        }
        .score-circle::after {
            content: ''; position: absolute; inset: 0;
            border-radius: 50%; border: 6px solid transparent;
            border-top-color: var(--accent);
            animation: spin-in 0.6s ease-out;
        }
        .score-circle.perfect::after { border-color: var(--success); }
        .score-circle.good::after { border-top-color: var(--success); border-right-color: var(--success); }
        .score-circle.mid::after { border-top-color: var(--warning); border-right-color: var(--warning); }
        .score-circle.low::after { border-top-color: var(--error); }
        @keyframes spin-in { from { transform: rotate(-90deg); opacity: 0; } to { transform: rotate(0); opacity: 1; } }

        .score-number { font-size: 36px; font-weight: 900; line-height: 1; }
        .score-max { font-size: 14px; color: var(--text-secondary); font-weight: 400; }
        .score-message { font-size: 15px; font-weight: 500; margin-top: 4px; }
        .score-message.perfect { color: var(--success); }
        .score-message.good { color: var(--success); }
        .score-message.mid { color: var(--warning); }
        .score-message.low { color: var(--error); }

        /* Results cards */
        .results-section { margin-top: 32px; display: none; }
        .results-section.visible { display: block; }
        .result-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; margin-bottom: 16px;
            animation: fadeInUp 0.4s ease;
        }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
        .result-title {
            font-size: 13px; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .math-block {
            background: rgba(0,0,0,0.3); border-radius: var(--radius-sm);
            padding: 16px; margin: 8px 0; text-align: center;
            border: 1px solid var(--border); overflow-x: auto; font-size: 1.2em;
        }
        .math-block .katex-display { margin: 0; }
        .mixed-text { line-height: 1.9; font-size: 14px; }
        .mixed-text .katex { font-size: 1.1em; }

        /* Formula box */
        .formula-box {
            background: rgba(108,99,255,0.06); border: 1px solid var(--border-accent);
            border-radius: var(--radius-sm); padding: 16px; margin-top: 12px;
        }
        .formula-box-title {
            font-size: 12px; font-weight: 600; color: var(--accent);
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
        }
        .formula-item {
            padding: 8px 0; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 4px;
        }
        .formula-item:last-child { border-bottom: none; }
        .formula-name { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .formula-expr { font-size: 1.1em; padding: 6px 0; }

        /* â”€â”€ Unit Tags â”€â”€ */
        .unit-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; margin-bottom: 16px;
            animation: fadeInUp 0.5s ease;
        }
        .unit-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 4px; }
        .unit-tag {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: 1px solid;
        }
        .unit-tag.math1a { background: rgba(99,179,237,0.1); color: #63b3ed; border-color: rgba(99,179,237,0.3); }
        .unit-tag.math1a:hover { background: rgba(99,179,237,0.2); transform: translateY(-1px); }
        .unit-tag.math2b { background: rgba(129,230,217,0.1); color: #81e6d9; border-color: rgba(129,230,217,0.3); }
        .unit-tag.math2b:hover { background: rgba(129,230,217,0.2); transform: translateY(-1px); }
        .unit-tag.math3c { background: rgba(183,148,244,0.1); color: #b794f4; border-color: rgba(183,148,244,0.3); }
        .unit-tag.math3c:hover { background: rgba(183,148,244,0.2); transform: translateY(-1px); }
        .unit-tag-arrow { font-size: 11px; opacity: 0.6; }

        /* â”€â”€ Learning Panel â”€â”€ */
        .learning-overlay {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease;
        }
        .learning-overlay.visible { display: flex; align-items: flex-end; justify-content: center; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        .learning-panel {
            width: 100%; max-width: 800px; max-height: 85vh;
            background: var(--bg-primary); border-radius: var(--radius) var(--radius) 0 0;
            overflow-y: auto; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

        .learning-header {
            position: sticky; top: 0; z-index: 10;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;
        }
        .learning-title { font-size: 16px; font-weight: 700; }
        .learning-close {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
            background: transparent; color: var(--text-secondary); cursor: pointer;
            font-size: 18px; display: flex; align-items: center; justify-content: center;
        }
        .learning-close:hover { background: var(--bg-card); color: var(--text-primary); }
        .learning-body { padding: 24px; }
        .learning-loading { text-align: center; padding: 60px 0; color: var(--text-secondary); }

        .hint-card {
            background: var(--warning-soft); border: 1px solid rgba(255,200,87,0.2);
            border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
        }
        .error-card {
            background: var(--error-soft); border: 1px solid rgba(255,107,107,0.2);
            border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
        }
        .error-card .result-title { color: var(--error); }

        .step-list { list-style: none; margin-top: 12px; }
        .step-item {
            padding: 16px; border-left: 3px solid var(--accent);
            margin-bottom: 12px; background: rgba(108,99,255,0.04);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .step-number {
            font-size: 11px; font-weight: 700; color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
        }
        .step-desc { font-size: 14px; line-height: 1.8; margin-bottom: 8px; }
        .step-math {
            font-size: 1.1em; color: var(--accent); background: rgba(0,0,0,0.2);
            padding: 10px 14px; border-radius: 6px; display: inline-block; margin-top: 4px;
        }

        .meta-bar {
            display: flex; gap: 20px; margin-top: 16px;
            padding-top: 16px; border-top: 1px solid var(--border);
        }
        .meta-item { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .meta-label { color: var(--text-secondary); }


        /* â•â•â• Screen Navigation (Global) â•â•â• */
        .screen { display: none; }
        .screen.active { display: block; }
        .nav-bar {
            display: flex; align-items: center; gap: 12px; padding: 12px 20px;
            border-bottom: 1px solid var(--border);
        }
        .nav-back {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
            color: var(--text-primary); padding: 8px 14px; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; font-family: inherit;
        }
        .nav-back:hover { background: var(--bg-card-hover); }
        .nav-title { font-size: 16px; font-weight: 700; }
        .nav-subtitle { font-size: 12px; color: var(--text-secondary); }
        /* Subject Tabs */
        .subject-tabs {
            display: flex; gap: 8px; padding: 16px 20px 8px; overflow-x: auto;
            -webkit-overflow-scrolling: touch; max-width: 800px; margin: 0 auto;
        }
        .subject-tab {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary);
            cursor: pointer; white-space: nowrap; transition: 0.2s; font-family: inherit;
        }
        .subject-tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .subject-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        /* Unit Grid */
        .unit-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            padding: 12px 20px 100px; max-width: 800px; margin: 0 auto;
        }
        .unit-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .unit-card:hover { border-color: var(--border-accent); transform: translateY(-2px); }
        .unit-card-subject { font-size: 11px; font-weight: 600; opacity: 0.7; margin-bottom: 6px; }
        .unit-card-name { font-size: 14px; font-weight: 700; margin-bottom: 8px; line-height: 1.4; }
        .unit-card-meta { font-size: 11px; color: var(--text-muted); }
        .unit-card.math1a { border-left: 3px solid #6c63ff; }
        .unit-card.math2b { border-left: 3px solid #2dd4a8; }
        .unit-card.math3c { border-left: 3px solid #ff6b9d; }
        .unit-card-subject.math1a { color: #6c63ff; }
        .unit-card-subject.math2b { color: #2dd4a8; }
        .unit-card-subject.math3c { color: #ff6b9d; }
        /* Sub-unit List */
        .subunit-section { padding: 0 20px 16px; max-width: 800px; margin: 0 auto; }
        .subunit-group { margin-bottom: 20px; }
        .subunit-group-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px; }
        .subunit-item {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
            padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .subunit-item:hover { border-color: var(--border-accent); }
        .subunit-name { font-size: 14px; font-weight: 500; }
        .subunit-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .subunit-arrow { color: var(--text-muted); font-size: 18px; }
        /* Problem List */
        .problem-list { padding: 0 20px 20px; }
        .problem-item {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
            padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .problem-item:hover { border-color: var(--border-accent); }
        .problem-title { font-size: 14px; font-weight: 500; }
        .diff-badge {
            font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px;
        }
        .diff-badge.basic { background: var(--success-soft); color: var(--success); }
        .diff-badge.standard { background: var(--warning-soft); color: var(--warning); }
        .diff-badge.advanced { background: var(--error-soft); color: var(--error); }
        /* Problem Display */
        .problem-display {
            background: var(--bg-card); border: 1px solid var(--border-accent); border-radius: var(--radius);
            padding: 24px; margin: 16px 20px; max-width: 800px;
        }
        .problem-display-title { font-size: 13px; color: var(--accent); font-weight: 600; margin-bottom: 12px; }
        .problem-display-text { font-size: 16px; line-height: 1.8; }
        .problem-display-hint {
            margin-top: 16px; padding: 12px; background: var(--warning-soft);
            border-radius: var(--radius-sm); font-size: 13px; color: var(--warning);
            cursor: pointer;
        }
        .problem-display-hint.revealed { cursor: default; }
        .free-mode-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin: 0 20px 16px; padding: 14px; border-radius: var(--radius);
            background: var(--bg-card); border: 1px dashed var(--border);
            color: var(--text-secondary); font-size: 14px; cursor: pointer; transition: 0.2s;
            max-width: 800px;
        }
        .free-mode-btn:hover { border-color: var(--accent); color: var(--accent); }
        .overview-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px 20px; margin: 12px 20px; max-width: 800px;
        }
        .overview-card p { font-size: 14px; line-height: 1.7; color: var(--text-secondary); }
        .empty-state {
            text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px;
        }

        @media (max-width: 600px) {
            .main { padding: 20px 16px 80px; }
            .upload-area { padding: 32px 16px; }
            .upload-actions { flex-direction: column; align-items: stretch; }
            .api-key-row { flex-direction: column; }
            .meta-bar { flex-wrap: wrap; gap: 12px; }
            .learning-panel { max-height: 90vh; }
            .unit-grid { grid-template-columns: 1fr 1fr; }
            .score-circle { width: 100px; height: 100px; }
            .score-number { font-size: 30px; }
        }

    </style>
</head>
<body>

<header class="header">
    <div class="header-inner">
        <div class="logo" onclick="navigateTo('home')" style="cursor:pointer">
            <div class="logo-icon">âˆ‘</div>
            <span class="logo-text">MathApp</span>
        </div>
        <div class="header-right">
            <span class="badge">PoC v0.4</span>
            <button class="settings-btn" onclick="toggleApiKey()" title="APIè¨­å®š">âš™</button>
        </div>
    </div>
</header>

<!-- â•â•â• API Key (shared across screens) â•â•â• -->
<div class="api-key-section" id="apiKeySection" style="margin:0 auto;max-width:520px;">
    <div class="api-key-header" onclick="toggleApiKey()">
        <span>ğŸ”‘ APIè¨­å®š</span>
        <span class="api-key-arrow">â–¼</span>
    </div>
    <div class="api-key-body">
        <div class="api-key-row">
            <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-...">
            <button class="api-key-save" onclick="saveApiKey()">ä¿å­˜</button>
        </div>
        <div class="api-key-status" id="apiKeyStatus">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>
</div>

<!-- â•â•â• Screen: Home (å˜å…ƒä¸€è¦§) â•â•â• -->
<div id="screen-home" class="screen active">
    <div class="subject-tabs" id="subjectTabs"></div>
    <div class="free-mode-btn" onclick="navigateTo('free')">ğŸ“· ãƒ•ãƒªãƒ¼æ¡ç‚¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆå˜å…ƒã‚’æŒ‡å®šã›ãšè‡ªç”±ã«æ¡ç‚¹ï¼‰</div>
    <div class="unit-grid" id="unitGrid"></div>
</div>

<!-- â•â•â• Screen: Unit Detail (å˜å…ƒè©³ç´° â†’ å°å˜å…ƒãƒ»å•é¡Œä¸€è¦§) â•â•â• -->
<div id="screen-unit" class="screen">
    <div class="nav-bar">
        <button class="nav-back" onclick="navigateTo('home')">â† æˆ»ã‚‹</button>
        <div>
            <div class="nav-title" id="unitDetailTitle"></div>
            <div class="nav-subtitle" id="unitDetailSubject"></div>
        </div>
    </div>
    <div class="overview-card" id="unitOverview"></div>
    <div class="subunit-section" id="subunitList"></div>
</div>

<!-- â•â•â• Screen: Problem (å•é¡Œè¡¨ç¤º + ç­”æ¡ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ + æ¡ç‚¹) â•â•â• -->
<div id="screen-problem" class="screen">
    <div class="nav-bar">
        <button class="nav-back" id="problemBackBtn" onclick="navigateBack()">â† æˆ»ã‚‹</button>
        <div>
            <div class="nav-title" id="problemScreenTitle"></div>
            <div class="nav-subtitle" id="problemScreenSub"></div>
        </div>
    </div>

    <!-- Problem display (hidden in free mode) -->
    <div class="problem-display" id="problemDisplay" style="display:none">
        <div class="problem-display-title" id="problemDifficulty"></div>
        <div class="problem-display-text mixed-text" id="problemText"></div>
        <div class="problem-display-hint" id="problemHint" style="display:none" onclick="revealHint(this)">
            ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
        </div>
    </div>

    <main class="main">
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div id="uploadPrompt">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-title">è§£ã„ãŸç­”æ¡ˆã‚’æ’®å½±ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <div class="upload-subtitle">AIãŒæ¡ç‚¹ã—ã¦ã€ã¤ã¾ãšããƒã‚¤ãƒ³ãƒˆã‚’æ•™ãˆã¦ãã‚Œã¾ã™</div>
                <div class="upload-actions">
                    <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
                    <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('cameraInput').click()">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
                </div>
            </div>
            <div class="preview-container" id="previewContainer">
                <img id="previewImg" class="preview-img" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                <button class="preview-remove" onclick="event.stopPropagation(); removeImage()" title="å‰Šé™¤">âœ•</button>
            </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)">

        <div class="analyze-section">
            <button class="analyze-btn" id="analyzeBtn" disabled onclick="analyze()">
                <span class="btn-text" id="btnText">ç­”æ¡ˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span>
                <div class="spinner"><div class="spinner-dot"></div><div class="spinner-dot"></div><div class="spinner-dot"></div></div>
            </button>
        </div>

        <div class="results-section" id="resultsSection"></div>
    </main>
</div>

<!-- â•â•â• Screen: Free Mode (ãƒ•ãƒªãƒ¼æ¡ç‚¹) â•â•â• -->
<div id="screen-free" class="screen">
    <!-- Redirects to screen-problem with free mode context -->
</div>

<!-- Learning Panel Overlay -->
<div class="learning-overlay" id="learningOverlay" onclick="closeLearning(event)">
    <div class="learning-panel" onclick="event.stopPropagation()">
        <div class="learning-header">
            <span class="learning-title" id="learningTitle">å˜å…ƒå­¦ç¿’</span>
            <button class="learning-close" onclick="closeLearning()">âœ•</button>
        </div>
        <div class="learning-body" id="learningBody"></div>
    </div>
</div>

<script>
let selectedFile = null;
let base64Image = null;
let apiKey = '';

// â•â•â• Init â•â•â•
(function init() {
    const saved = localStorage.getItem('openai_api_key');
    if (saved) {
        apiKey = saved;
        document.getElementById('apiKeyInput').value = saved;
        document.getElementById('apiKeyStatus').textContent = 'âœ“ è¨­å®šæ¸ˆã¿';
        document.getElementById('apiKeyStatus').className = 'api-key-status saved';
    } else {
        document.getElementById('apiKeySection').classList.add('open');
    }
})();

function toggleApiKey() {
    document.getElementById('apiKeySection').classList.toggle('open');
}

function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) return;
    apiKey = key;
    localStorage.setItem('openai_api_key', key);
    document.getElementById('apiKeyStatus').textContent = 'âœ“ ä¿å­˜æ¸ˆã¿';
    document.getElementById('apiKeyStatus').className = 'api-key-status saved';
    setTimeout(() => toggleApiKey(), 500);
}

// â•â•â• File Handling â•â•â•
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        base64Image = e.target.result;
        document.getElementById('previewImg').src = base64Image;
        document.getElementById('previewContainer').classList.add('visible');
        document.getElementById('uploadPrompt').style.display = 'none';
        document.getElementById('uploadArea').classList.add('has-image');
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('btnText').textContent = 'æ¡ç‚¹ã™ã‚‹';
    };
    reader.readAsDataURL(file);
}

function removeImage() {
    selectedFile = null; base64Image = null;
    document.getElementById('previewContainer').classList.remove('visible');
    document.getElementById('uploadPrompt').style.display = 'block';
    document.getElementById('uploadArea').classList.remove('has-image');
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('fileInput').value = '';
    document.getElementById('cameraInput').value = '';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('btnText').textContent = 'ç­”æ¡ˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„';
}

const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        const dt = new DataTransfer(); dt.items.add(file);
        document.getElementById('fileInput').files = dt.files;
        handleFileSelect({ target: { files: [file] } });
    }
});

// â•â•â• Math Rendering â•â•â•
function renderMathBlock(latex) {
    if (!latex || latex === 'â€”') return escHtml(latex || '');
    let expr = latex.trim();
    if (expr.startsWith('$$') && expr.endsWith('$$')) expr = expr.slice(2,-2).trim();
    else if (expr.startsWith('$') && expr.endsWith('$')) expr = expr.slice(1,-1).trim();
    else if (expr.startsWith('\\[') && expr.endsWith('\\]')) expr = expr.slice(2,-2).trim();
    else if (expr.startsWith('\\(') && expr.endsWith('\\)')) expr = expr.slice(2,-2).trim();
    try { return katex.renderToString(expr, { displayMode: true, throwOnError: false }); }
    catch (e) { return '<code>' + escHtml(latex) + '</code>'; }
}

function renderMixedText(text) {
    if (!text) return '';
    const result = [];
    let i = 0;
    while (i < text.length) {
        if (text[i] === '$' && text[i+1] === '$') {
            const end = text.indexOf('$$', i+2);
            if (end !== -1) {
                try { result.push(katex.renderToString(text.slice(i+2,end).trim(), {displayMode:true,throwOnError:false})); }
                catch(e) { result.push('<code>'+escHtml(text.slice(i+2,end))+'</code>'); }
                i = end+2; continue;
            }
        }
        if (text[i] === '$') {
            const end = text.indexOf('$', i+1);
            if (end !== -1 && end > i+1) {
                const expr = text.slice(i+1, end);
                if (expr.trim()) {
                    try { result.push(katex.renderToString(expr.trim(), {displayMode:false,throwOnError:false})); }
                    catch(e) { result.push('<code>'+escHtml(expr)+'</code>'); }
                    i = end+1; continue;
                }
            }
        }
        if (text[i] === '\\' && text[i+1] === '(') {
            const end = text.indexOf('\\)', i+2);
            if (end !== -1) {
                try { result.push(katex.renderToString(text.slice(i+2,end).trim(), {displayMode:false,throwOnError:false})); }
                catch(e) { result.push('<code>'+escHtml(text.slice(i+2,end))+'</code>'); }
                i = end+2; continue;
            }
        }
        if (text[i] === '\\' && text[i+1] === '[') {
            const end = text.indexOf('\\]', i+2);
            if (end !== -1) {
                try { result.push(katex.renderToString(text.slice(i+2,end).trim(), {displayMode:true,throwOnError:false})); }
                catch(e) { result.push('<code>'+escHtml(text.slice(i+2,end))+'</code>'); }
                i = end+2; continue;
            }
        }
        if (text[i] === '\n') { result.push('<br>'); i++; continue; }
        let j = i;
        while (j < text.length && text[j] !== '$' && text[j] !== '\n' &&
               !(text[j]==='\\' && (text[j+1]==='(' || text[j+1]==='['))) j++;
        result.push(escHtml(text.slice(i,j)));
        i = j;
    }
    return result.join('');
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â• Unit & Formula Database (from Notion) â•â•â•
const UNIT_DB = {
    "expressions": { name: "æ•°ã¨å¼", subject: "æ•°å­¦â… ", category: "math1a", order: 1, summary: "å±•é–‹ãƒ»å› æ•°åˆ†è§£ã€å®Ÿæ•°ã®åˆ†é¡ã€1æ¬¡ä¸ç­‰å¼ãªã©ã€æ•°å­¦ã®åŸºç¤ã¨ãªã‚‹è¨ˆç®—åŠ›ã‚’èº«ã«ã¤ã‘ã‚‹å˜å…ƒ", tips: "å› æ•°åˆ†è§£ã¯å±•é–‹ã®é€†æ“ä½œã€‚ä¹—æ³•å…¬å¼ã‚’é€†å‘ãã«ä½¿ã†ç·´ç¿’ãŒé‡è¦\nçµ¶å¯¾å€¤ã®å•é¡Œã¯ä¸­èº«ã®æ­£è² ã§å ´åˆåˆ†ã‘\nä¸ç­‰å¼ã§ã¯ä¸¡è¾ºã«è² ã®æ•°ã‚’ã‹ã‘ã‚‹ã¨ä¸ç­‰å·ãŒé€†è»¢", formulas: ["square_of_sum","square_of_diff","diff_of_squares"] },
    "sets_logic": { name: "é›†åˆã¨å‘½é¡Œ", subject: "æ•°å­¦â… ", category: "math1a", order: 2, summary: "é›†åˆã®è¡¨ã—æ–¹ã€å…±é€šéƒ¨åˆ†ãƒ»å’Œé›†åˆã€å‘½é¡Œã®çœŸå½ã€å¿…è¦æ¡ä»¶ãƒ»ååˆ†æ¡ä»¶ã«ã¤ã„ã¦å­¦ã¶", tips: "ãƒ™ãƒ³å›³ã‚’æã„ã¦é›†åˆã®é–¢ä¿‚ã‚’è¦–è¦šçš„ã«ç†è§£ã™ã‚‹\nã€Œpâ‡’qã€ãŒçœŸã®ã¨ãã€pã¯qã®ååˆ†æ¡ä»¶ã€qã¯pã®å¿…è¦æ¡ä»¶\nåä¾‹ã‚’1ã¤è¦‹ã¤ã‘ã‚Œã°å‘½é¡Œã¯å½", formulas: [] },
    "quadratic_function": { name: "äºŒæ¬¡é–¢æ•°", subject: "æ•°å­¦â… ", category: "math1a", order: 3, summary: "äºŒæ¬¡é–¢æ•°ã®ã‚°ãƒ©ãƒ•ã€å¹³æ–¹å®Œæˆã€æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã€äºŒæ¬¡æ–¹ç¨‹å¼ãƒ»äºŒæ¬¡ä¸ç­‰å¼ã‚’æ‰±ã†é‡è¦å˜å…ƒ", tips: "å¹³æ–¹å®Œæˆã§æ¨™æº–å½¢ y=a(x-p)Â²+q ã«ã™ã‚‹ã¨é ‚ç‚¹ãƒ»è»¸ãŒã™ãã‚ã‹ã‚‹\nå®šç¾©åŸŸãŒé™ã‚‰ã‚Œã‚‹ã¨ãã¯è»¸ã¨å®šç¾©åŸŸã®ä½ç½®é–¢ä¿‚ã§å ´åˆåˆ†ã‘\näºŒæ¬¡ä¸ç­‰å¼ã¯ã‚°ãƒ©ãƒ•ã‚’æã„ã¦xè»¸ã¨ã®ä½ç½®é–¢ä¿‚ã§è§£ã", formulas: ["quadratic_formula","quadratic_standard","discriminant"] },
    "trigonometric_ratio": { name: "å›³å½¢ã¨è¨ˆé‡", subject: "æ•°å­¦â… ", category: "math1a", order: 4, summary: "ä¸‰è§’æ¯”ï¼ˆsin, cos, tanï¼‰ã®å®šç¾©ã€ç›¸äº’é–¢ä¿‚ã€æ­£å¼¦å®šç†ãƒ»ä½™å¼¦å®šç†ã‚’ç”¨ã„ãŸå›³å½¢ã®è¨ˆé‡", tips: "sin, cos, tanã¯ç›´è§’ä¸‰è§’å½¢ã®è¾ºã®æ¯”ã€‚å˜ä½å††ã§ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãã‚‹\næ­£å¼¦å®šç†ã¯ã€Œè§’ã¨å‘ã‹ã„åˆã†è¾ºã€ã€ä½™å¼¦å®šç†ã¯ã€Œ3è¾ºã¨1è§’ã€ã®é–¢ä¿‚\nä¸‰è§’æ¯”ã®ç›¸äº’é–¢ä¿‚ sinÂ²Î¸+cosÂ²Î¸=1 ã¯æœ€é‡è¦", formulas: ["sine_rule","cosine_rule","trig_identity","triangle_area_sin"] },
    "data_analysis": { name: "ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ", subject: "æ•°å­¦â… ", category: "math1a", order: 5, summary: "å¹³å‡å€¤ã€ä¸­å¤®å€¤ã€åˆ†æ•£ã€æ¨™æº–åå·®ã€ç›¸é–¢ä¿‚æ•°ãªã©çµ±è¨ˆçš„ãªæŒ‡æ¨™ã®æ„å‘³ã¨è¨ˆç®—æ–¹æ³•", tips: "åˆ†æ•£ã¯ã€ŒäºŒä¹—ã®å¹³å‡âˆ’å¹³å‡ã®äºŒä¹—ã€ã®å…¬å¼ãŒè¨ˆç®—ã—ã‚„ã™ã„\nç›¸é–¢ä¿‚æ•°ã¯ç›´ç·šçš„ãªé–¢ä¿‚ã®å¼·ã•ã‚’ç¤ºã—ã€å› æœé–¢ä¿‚ã¨ã¯ç•°ãªã‚‹\nç®±ã²ã’å›³ã¯å››åˆ†ä½æ•°ã®ç†è§£ãŒå¿…è¦", formulas: ["variance","correlation"] },
    "probability": { name: "å ´åˆã®æ•°ã¨ç¢ºç‡", subject: "æ•°å­¦A", category: "math1a", order: 6, summary: "é †åˆ—ãƒ»çµ„åˆã›ã®è¨ˆç®—ã€ç¢ºç‡ã®åŸºæœ¬ã€æ¡ä»¶ä»˜ãç¢ºç‡ã€æœŸå¾…å€¤ã«ã¤ã„ã¦å­¦ã¶", tips: "ã€Œä¸¦ã¹ã‚‹ã€ãªã‚‰é †åˆ—Pã€ã€Œé¸ã¶ã ã‘ã€ãªã‚‰çµ„åˆã›Cã¨ä½¿ã„åˆ†ã‘ã‚‹\nã€Œå°‘ãªãã¨ã‚‚1ã¤ã€ã¯ä½™äº‹è±¡ï¼ˆ1ã¤ã‚‚ãªã„ç¢ºç‡ï¼‰ã‚’å¼•ã\næ¡ä»¶ä»˜ãç¢ºç‡ã¯åˆ†æ¯ãŒæ¡ä»¶ã®äº‹è±¡ã«ãªã‚‹", formulas: ["permutation","combination","prob_addition","complementary_prob"] },
    "geometry_properties": { name: "å›³å½¢ã®æ€§è³ª", subject: "æ•°å­¦A", category: "math1a", order: 7, summary: "ä¸‰è§’å½¢ã®äº”å¿ƒã€å††ã®æ€§è³ªã€ãƒ¡ãƒãƒ©ã‚¦ã‚¹ãƒ»ãƒã‚§ãƒã®å®šç†ã€ä½œå›³ã«ã¤ã„ã¦å­¦ã¶", tips: "ãƒ¡ãƒãƒ©ã‚¦ã‚¹ã®å®šç†ã¯ã€Œä¸‰è§’å½¢ã®è¾ºã®å»¶é•·ä¸Šã®3ç‚¹ãŒä¸€ç›´ç·šä¸Šã€ã®æ¡ä»¶\nå††ã«å†…æ¥ã™ã‚‹å››è§’å½¢ã®å¯¾è§’ã®å’Œã¯180Â°\næ¥ç·šã®é•·ã•ã®æ€§è³ªï¼ˆå††å¤–ã®ç‚¹ã‹ã‚‰ã®2æ¥ç·šã¯ç­‰ã—ã„ï¼‰", formulas: ["menelaus","ceva"] },
    "integer_properties": { name: "æ•´æ•°ã®æ€§è³ª", subject: "æ•°å­¦A", category: "math1a", order: 8, summary: "ç´„æ•°ãƒ»å€æ•°ã€ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã€ä¸å®šæ–¹ç¨‹å¼ã€åˆåŒå¼ã®åŸºç¤", tips: "ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã¯ã€Œå‰²ã‚Šç®—ã‚’ç¹°ã‚Šè¿”ã—ã¦ä½™ã‚ŠãŒ0ã«ãªã‚‹ã¾ã§ã€\nä¸å®šæ–¹ç¨‹å¼ ax+by=gcd(a,b) ã«ã¯å¿…ãšæ•´æ•°è§£ãŒå­˜åœ¨\nä½™ã‚Šã§å ´åˆåˆ†ã‘ï¼ˆå¶å¥‡ã€3ã®å€æ•°ãªã©ï¼‰ãŒæœ‰åŠ¹ãªæ‰‹æ³•", formulas: ["euclidean_algorithm"] },
    "equations_proof": { name: "å¼ã¨è¨¼æ˜", subject: "æ•°å­¦â…¡", category: "math2b", order: 9, summary: "æ’ç­‰å¼ã®è¨¼æ˜ã€ç­‰å¼ãƒ»ä¸ç­‰å¼ã®è¨¼æ˜ã€äºŒé …å®šç†ã€å‰°ä½™ã®å®šç†ãªã©", tips: "æ’ç­‰å¼ã®è¨¼æ˜ã¯ã€Œå·¦è¾ºâˆ’å³è¾ºï¼0ã€ã‚’ç¤ºã™æ–¹æ³•ãŒåŸºæœ¬\näºŒé …å®šç†ã®ä¸€èˆ¬é …ã¯C(n,r)Â·a^(n-r)Â·b^r\nå‰°ä½™ã®å®šç†ï¼šP(x)ã‚’(x-a)ã§å‰²ã£ãŸä½™ã‚Šã¯P(a)", formulas: ["binomial_theorem","remainder_theorem"] },
    "complex_equations": { name: "è¤‡ç´ æ•°ã¨æ–¹ç¨‹å¼", subject: "æ•°å­¦â…¡", category: "math2b", order: 10, summary: "è¤‡ç´ æ•°ã®è¨ˆç®—ã€è§£ã¨ä¿‚æ•°ã®é–¢ä¿‚ã€å‰°ä½™ã®å®šç†ã€é«˜æ¬¡æ–¹ç¨‹å¼ã®è§£æ³•", tips: "è™šæ•°å˜ä½ iÂ²=-1 ã•ãˆæŠ‘ãˆã‚Œã°è¨ˆç®—ã¯å®Ÿæ•°ã¨åŒã˜\nè§£ã¨ä¿‚æ•°ã®é–¢ä¿‚ï¼šå’Œã¨ç©ãŒä¿‚æ•°ã‹ã‚‰æ±‚ã¾ã‚‹\né«˜æ¬¡æ–¹ç¨‹å¼ã¯å› æ•°å®šç†ã§è§£ã‚’æ¢ã—ã¦æ¬¡æ•°ã‚’ä¸‹ã’ã‚‹", formulas: ["vieta_formulas","remainder_theorem"] },
    "coordinate_geometry": { name: "å›³å½¢ã¨æ–¹ç¨‹å¼", subject: "æ•°å­¦â…¡", category: "math2b", order: 11, summary: "ç‚¹ã®åº§æ¨™ã€ç›´ç·šã®æ–¹ç¨‹å¼ã€å††ã®æ–¹ç¨‹å¼ã€è»Œè·¡ã€é ˜åŸŸã®å›³ç¤º", tips: "ç‚¹ã¨ç›´ç·šã®è·é›¢ã®å…¬å¼ |axâ‚€+byâ‚€+c|/âˆš(aÂ²+bÂ²) ã¯é »å‡º\nå††ã®æ–¹ç¨‹å¼ã¯ã€Œä¸­å¿ƒã¨åŠå¾„ã€ã‚’èª­ã¿å–ã‚‹\nä¸ç­‰å¼ã®è¡¨ã™é ˜åŸŸã¯ã€Œå¢ƒç•Œç·šã€ã¨ã€Œå‘ãï¼ˆä¸Šä¸‹ï¼‰ã€ã§åˆ¤æ–­", formulas: ["point_line_distance","circle_equation"] },
    "trigonometric_function": { name: "ä¸‰è§’é–¢æ•°", subject: "æ•°å­¦â…¡", category: "math2b", order: 12, summary: "å¼§åº¦æ³•ã€ä¸‰è§’é–¢æ•°ã®ã‚°ãƒ©ãƒ•ã€åŠ æ³•å®šç†ã€åˆæˆã€ä¸‰è§’æ–¹ç¨‹å¼", tips: "å¼§åº¦æ³•ã®å¤‰æ›ï¼š180Â°=Ï€ ã‚’åŸºæœ¬ã«è§’åº¦ã¨å¼§åº¦ã‚’è¡Œãæ¥ã™ã‚‹\nåŠ æ³•å®šç†ã‹ã‚‰å€è§’ãƒ»åŠè§’ã®å…¬å¼ãŒå°å‡ºã§ãã‚‹\nåˆæˆ aÂ·sinÎ¸+bÂ·cosÎ¸=rÂ·sin(Î¸+Î±) ã¯æœ€å¤§æœ€å°å•é¡Œã§å¿…é ˆ", formulas: ["sin_addition","cos_addition","trig_synthesis","double_angle_sin","double_angle_cos"] },
    "exponential_logarithm": { name: "æŒ‡æ•°é–¢æ•°ãƒ»å¯¾æ•°é–¢æ•°", subject: "æ•°å­¦â…¡", category: "math2b", order: 13, summary: "æŒ‡æ•°æ³•å‰‡ã€æŒ‡æ•°é–¢æ•°ãƒ»å¯¾æ•°é–¢æ•°ã®ã‚°ãƒ©ãƒ•ã€å¯¾æ•°ã®æ€§è³ªã¨è¨ˆç®—", tips: "æŒ‡æ•°ã¨å¯¾æ•°ã¯é€†æ¼”ç®—ã®é–¢ä¿‚ï¼ša^x=M â‡” x=log_a(M)\nå¯¾æ•°ã®è¨ˆç®—ã¯3æ³•å‰‡ï¼ˆå’Œâ†’ç©ã€å·®â†’å•†ã€å®šæ•°å€â†’ã¹ãä¹—ï¼‰\nåº•ã®å¤‰æ›å…¬å¼ log_a(b)=log_c(b)/log_c(a) ã§åº•ã‚’æƒãˆã‚‹", formulas: ["log_properties","log_base_change"] },
    "differentiation_2": { name: "å¾®åˆ†æ³•", subject: "æ•°å­¦â…¡", category: "math2b", order: 14, summary: "å¾®åˆ†ä¿‚æ•°ã€å°é–¢æ•°ã®è¨ˆç®—ã€æ¥ç·šã®æ–¹ç¨‹å¼ã€é–¢æ•°ã®å¢—æ¸›ãƒ»æ¥µå€¤", tips: "å¾®åˆ†ã¯ã€Œå¤‰åŒ–ã®å‰²åˆã€ã‚’æ±‚ã‚ã‚‹æ“ä½œã€‚ã‚°ãƒ©ãƒ•ã®å‚¾ã\n(x^n)'=nx^(n-1) ãŒåŸºæœ¬ã€‚å®šæ•°ã®å¾®åˆ†ã¯0\nf'(x)=0 ã¨ãªã‚‹ç‚¹ã§æ¥µå€¤ã‚’ã¨ã‚‹å¯èƒ½æ€§â†’å¢—æ¸›è¡¨ã§ç¢ºèª", formulas: ["power_derivative","tangent_line"] },
    "integration_2": { name: "ç©åˆ†æ³•", subject: "æ•°å­¦â…¡", category: "math2b", order: 15, summary: "ä¸å®šç©åˆ†ã€å®šç©åˆ†ã€é¢ç©ã®è¨ˆç®—", tips: "ç©åˆ†ã¯å¾®åˆ†ã®é€†æ“ä½œã€‚ã€Œå¾®åˆ†ã—ãŸã‚‰å…ƒã«æˆ»ã‚‹ã€é–¢æ•°ã‚’æ¢ã™\nå®šç©åˆ†ã¯ã€Œé¢ç©ã€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚xè»¸ã®ä¸‹ã¯è² ã«ãªã‚‹\né¢ç©ã®ã€Œ1/6å…¬å¼ã€ã€Œ1/12å…¬å¼ã€ã¯æ”¾ç‰©ç·šã¨ç›´ç·šã§é »å‡º", formulas: ["area_one_sixth"] },
    "sequences": { name: "æ•°åˆ—", subject: "æ•°å­¦B", category: "math2b", order: 16, summary: "ç­‰å·®æ•°åˆ—ãƒ»ç­‰æ¯”æ•°åˆ—ã€ã„ã‚ã„ã‚ãªæ•°åˆ—ã®å’Œã€æ¼¸åŒ–å¼ã€æ•°å­¦çš„å¸°ç´æ³•", tips: "ç­‰å·®æ•°åˆ—ã¯ã€Œå·®ãŒä¸€å®šã€ã€ç­‰æ¯”æ•°åˆ—ã¯ã€Œæ¯”ãŒä¸€å®šã€\næ¼¸åŒ–å¼ã¯ã€Œç‰¹æ€§æ–¹ç¨‹å¼ã€ã§è§£ãã®ãŒåŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³\næ•°å­¦çš„å¸°ç´æ³•ã¯n=1ã§ç¢ºèªã€n=kâ†’n=k+1ã‚’ç¤ºã™", formulas: ["arithmetic_seq","arithmetic_sum","geometric_seq","geometric_sum"] },
    "statistical_inference": { name: "çµ±è¨ˆçš„ãªæ¨æ¸¬", subject: "æ•°å­¦B", category: "math2b", order: 17, summary: "ç¢ºç‡åˆ†å¸ƒã€æ­£è¦åˆ†å¸ƒã€ä¿¡é ¼åŒºé–“ã€ä»®èª¬æ¤œå®šã®åŸºç¤", tips: "æ­£è¦åˆ†å¸ƒ N(Î¼,ÏƒÂ²) ã®æ¨™æº–åŒ–ï¼šZ=(X-Î¼)/Ïƒ\nä¿¡é ¼åŒºé–“ 95% ã¯ Z=Â±1.96 ãŒç”¨ã„ã‚‰ã‚Œã‚‹\nä»®èª¬æ¤œå®šã¯ã€Œå¸°ç„¡ä»®èª¬ã‚’ç«‹ã¦ã¦æ£„å´ã§ãã‚‹ã‹ã€ã‚’åˆ¤æ–­", formulas: ["z_score","confidence_interval"] },
    "limits": { name: "æ¥µé™", subject: "æ•°å­¦â…¢", category: "math3c", order: 18, summary: "æ•°åˆ—ã®æ¥µé™ã€ç„¡é™ç´šæ•°ã€é–¢æ•°ã®æ¥µé™ã€é€£ç¶šæ€§", tips: "æ•°åˆ—ã®æ¥µé™ã¯ã€Œæœ€é«˜æ¬¡ã®é …ã§å‰²ã‚‹ã€ã®ãŒå®šçŸ³\nç„¡é™ç­‰æ¯”ç´šæ•°ã¯ |r|<1 ã®ã¨ã a/(1-r) ã«åæŸ\nã¯ã•ã¿ã†ã¡ã®åŸç†ã¯æ¥µé™ã®å­˜åœ¨è¨¼æ˜ã«ä½¿ã†", formulas: ["infinite_geometric_series","e_definition"] },
    "differentiation_3": { name: "å¾®åˆ†æ³•ï¼ˆæ•°â…¢ï¼‰", subject: "æ•°å­¦â…¢", category: "math3c", order: 19, summary: "åˆæˆé–¢æ•°ãƒ»é€†é–¢æ•°ã®å¾®åˆ†ã€åª’ä»‹å¤‰æ•°è¡¨ç¤ºã®å¾®åˆ†ã€æ¥ç·šãƒ»æ³•ç·šã€é€Ÿåº¦ãƒ»åŠ é€Ÿåº¦", tips: "åˆæˆé–¢æ•°ã®å¾®åˆ†ã¯ã€Œå¤–å´ã®å¾®åˆ†Ã—å†…å´ã®å¾®åˆ†ã€ï¼ˆé€£é–å¾‹å‰‡ï¼‰\ne^x, sin x, cos x, log x ã®å¾®åˆ†ã¯åŸºæœ¬ä¸­ã®åŸºæœ¬\nåª’ä»‹å¤‰æ•°è¡¨ç¤ºã¯ dy/dx = (dy/dt)/(dx/dt)", formulas: ["power_derivative","tangent_line","chain_rule","trig_derivatives","exp_log_derivatives"] },
    "integration_3": { name: "ç©åˆ†æ³•ï¼ˆæ•°â…¢ï¼‰", subject: "æ•°å­¦â…¢", category: "math3c", order: 20, summary: "ç½®æ›ç©åˆ†ã€éƒ¨åˆ†ç©åˆ†ã€å„ç¨®é–¢æ•°ã®ç©åˆ†ã€é¢ç©ãƒ»ä½“ç©ãƒ»å¼§é•·", tips: "ç½®æ›ç©åˆ†ã¯ã€Œä¸­èº«ã‚’tã¨ç½®ãã€ã§è¤‡é›‘ãªç©åˆ†ã‚’å˜ç´”åŒ–\néƒ¨åˆ†ç©åˆ†ã¯ã€Œç©ã®å¾®åˆ†ã€ã‚’é€†ã«ä½¿ã†ã€‚âˆ«fg'dx=fg-âˆ«f'gdx\nå›è»¢ä½“ã®ä½“ç© V=Ï€âˆ«yÂ²dx ã¯é »å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³", formulas: ["integration_by_parts","volume_rotation"] },
    "vectors": { name: "ãƒ™ã‚¯ãƒˆãƒ«", subject: "æ•°å­¦C", category: "math3c", order: 21, summary: "å¹³é¢ãƒ™ã‚¯ãƒˆãƒ«ã€ç©ºé–“ãƒ™ã‚¯ãƒˆãƒ«ã€å†…ç©ã€ä½ç½®ãƒ™ã‚¯ãƒˆãƒ«ã€ãƒ™ã‚¯ãƒˆãƒ«æ–¹ç¨‹å¼", tips: "ãƒ™ã‚¯ãƒˆãƒ«ã¯ã€Œå‘ãã¨å¤§ãã•ã€ã‚’æŒã¤é‡ã€‚çŸ¢å°ã§ã‚¤ãƒ¡ãƒ¼ã‚¸\nå†…ç© aÂ·b = |a||b|cosÎ¸ ã¯å‚ç›´åˆ¤å®šã‚„è§’åº¦è¨ˆç®—ã«ä½¿ã†\nä½ç½®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½¿ã†ã¨åˆ†ç‚¹ãƒ»é‡å¿ƒãŒç°¡å˜ã«æ±‚ã¾ã‚‹", formulas: ["dot_product","dot_product_components"] },
    "plane_curves": { name: "å¹³é¢ä¸Šã®æ›²ç·š", subject: "æ•°å­¦C", category: "math3c", order: 22, summary: "äºŒæ¬¡æ›²ç·šï¼ˆæ”¾ç‰©ç·šãƒ»æ¥•å††ãƒ»åŒæ›²ç·šï¼‰ã€åª’ä»‹å¤‰æ•°è¡¨ç¤ºã€æ¥µåº§æ¨™", tips: "äºŒæ¬¡æ›²ç·šã¯ç„¦ç‚¹ã¨æº–ç·šã‹ã‚‰ã®è·é›¢ã®æ¯”ï¼ˆé›¢å¿ƒç‡ï¼‰ã§åˆ†é¡\næ¥•å†† xÂ²/aÂ²+yÂ²/bÂ²=1ã€åŒæ›²ç·š xÂ²/aÂ²-yÂ²/bÂ²=1\næ¥µåº§æ¨™ (r,Î¸) ã¨ç›´äº¤åº§æ¨™ (x,y) ã®ç›¸äº’å¤‰æ›ãŒåŸºæœ¬", formulas: ["ellipse","hyperbola","polar_conversion"] },
    "complex_plane": { name: "è¤‡ç´ æ•°å¹³é¢", subject: "æ•°å­¦C", category: "math3c", order: 23, summary: "è¤‡ç´ æ•°ã®å›³å½¢çš„æ„å‘³ã€æ¥µå½¢å¼ã€ãƒ‰ãƒ»ãƒ¢ã‚¢ãƒ–ãƒ«ã®å®šç†ã€å›è»¢ã¨æ‹¡å¤§", tips: "è¤‡ç´ æ•°ã®ç©ã¯ã€Œçµ¶å¯¾å€¤ã®ç©ã€åè§’ã®å’Œã€\nãƒ‰ãƒ»ãƒ¢ã‚¢ãƒ–ãƒ«ã®å®šç† (cosÎ¸+iÂ·sinÎ¸)^n = cos(nÎ¸)+iÂ·sin(nÎ¸)\nè¤‡ç´ æ•°ã®ã‹ã‘ç®—ã¯å›è»¢ã¨æ‹¡å¤§ã®åˆæˆå¤‰æ›", formulas: ["complex_polar","de_moivre"] },
};

const FORMULA_DB = {
    "square_of_sum": { name: "ä¹—æ³•å…¬å¼ï¼ˆå’Œã®äºŒä¹—ï¼‰", latex: "(a+b)^2 = a^2 + 2ab + b^2", desc: "å±•é–‹ãƒ»å› æ•°åˆ†è§£ã®åŸºæœ¬ã€‚é€†å‘ãã«ä½¿ã†ã¨å› æ•°åˆ†è§£ã«ãªã‚‹" },
    "square_of_diff": { name: "ä¹—æ³•å…¬å¼ï¼ˆå·®ã®äºŒä¹—ï¼‰", latex: "(a-b)^2 = a^2 - 2ab + b^2", desc: "å±•é–‹ãƒ»å› æ•°åˆ†è§£ã®åŸºæœ¬" },
    "diff_of_squares": { name: "ä¹—æ³•å…¬å¼ï¼ˆå’Œã¨å·®ã®ç©ï¼‰", latex: "(a+b)(a-b) = a^2 - b^2", desc: "ãŸã™ãæ›ã‘ã®å…¬å¼ã€‚å› æ•°åˆ†è§£ã§ã‚‚æ´»ç”¨" },
    "quadratic_formula": { name: "è§£ã®å…¬å¼", latex: "x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}", desc: "äºŒæ¬¡æ–¹ç¨‹å¼ axÂ²+bx+c=0 ã®è§£ã€‚åˆ¤åˆ¥å¼ D=bÂ²-4ac ã§è§£ã®æ•°ãŒã‚ã‹ã‚‹" },
    "quadratic_standard": { name: "äºŒæ¬¡é–¢æ•°ã®æ¨™æº–å½¢", latex: "y = a(x-p)^2 + q", desc: "é ‚ç‚¹(p,q)ã€è»¸x=pã®ã‚°ãƒ©ãƒ•ã€‚å¹³æ–¹å®Œæˆã§ã“ã®å½¢ã«å¤‰å½¢ã™ã‚‹" },
    "discriminant": { name: "åˆ¤åˆ¥å¼", latex: "D = b^2 - 4ac", desc: "D>0:ç•°ãªã‚‹2å®Ÿæ•°è§£ã€D=0:é‡è§£ã€D<0:å®Ÿæ•°è§£ãªã—" },
    "sine_rule": { name: "æ­£å¼¦å®šç†", latex: "\\frac{a}{\\sin A} = \\frac{b}{\\sin B} = \\frac{c}{\\sin C} = 2R", desc: "å¤–æ¥å††ã®åŠå¾„Rã¨è¾ºãƒ»è§’ã®é–¢ä¿‚" },
    "cosine_rule": { name: "ä½™å¼¦å®šç†", latex: "a^2 = b^2 + c^2 - 2bc\\cos A", desc: "3è¾ºã¨1è§’ã®é–¢ä¿‚ã€‚ä¸‰å¹³æ–¹ã®å®šç†ã®ä¸€èˆ¬åŒ–" },
    "trig_identity": { name: "ä¸‰è§’æ¯”ã®ç›¸äº’é–¢ä¿‚", latex: "\\sin^2\\theta + \\cos^2\\theta = 1", desc: "ä¸‰è§’æ¯”ã®æœ€ã‚‚åŸºæœ¬çš„ãªé–¢ä¿‚å¼" },
    "triangle_area_sin": { name: "ä¸‰è§’å½¢ã®é¢ç©", latex: "S = \\frac{1}{2}bc\\sin A", desc: "2è¾ºã¨ãã®é–“ã®è§’ã‹ã‚‰é¢ç©ã‚’æ±‚ã‚ã‚‹å…¬å¼" },
    "variance": { name: "åˆ†æ•£ã®å…¬å¼", latex: "s^2 = \\overline{x^2} - \\bar{x}^2", desc: "åˆ†æ•£ï¼äºŒä¹—ã®å¹³å‡ âˆ’ å¹³å‡ã®äºŒä¹—" },
    "correlation": { name: "ç›¸é–¢ä¿‚æ•°", latex: "r = \\frac{s_{xy}}{s_x \\cdot s_y}", desc: "å…±åˆ†æ•£ã‚’ãã‚Œãã‚Œã®æ¨™æº–åå·®ã§å‰²ã£ãŸã‚‚ã®ã€‚-1â‰¤râ‰¤1" },
    "permutation": { name: "é †åˆ—", latex: "{}_nP_r = \\frac{n!}{(n-r)!}", desc: "nå€‹ã‹ã‚‰rå€‹ã‚’é¸ã‚“ã§ä¸¦ã¹ã‚‹å ´åˆã®æ•°" },
    "combination": { name: "çµ„åˆã›", latex: "{}_nC_r = \\frac{n!}{r!(n-r)!}", desc: "nå€‹ã‹ã‚‰rå€‹ã‚’é¸ã¶å ´åˆã®æ•°" },
    "prob_addition": { name: "ç¢ºç‡ã®åŠ æ³•å®šç†", latex: "P(A \\cup B) = P(A) + P(B) - P(A \\cap B)", desc: "ã€Œã¾ãŸã¯ã€ã®ç¢ºç‡ã€‚é‡è¤‡ã‚’å¼•ã" },
    "complementary_prob": { name: "ä½™äº‹è±¡ã®ç¢ºç‡", latex: "P(\\bar{A}) = 1 - P(A)", desc: "ã€Œå°‘ãªãã¨ã‚‚1ã¤ã€ã®å•é¡Œã§ä½¿ã†" },
    "menelaus": { name: "ãƒ¡ãƒãƒ©ã‚¦ã‚¹ã®å®šç†", latex: "\\frac{BD}{DC} \\cdot \\frac{CE}{EA} \\cdot \\frac{AF}{FB} = 1", desc: "ä¸‰è§’å½¢ã®è¾ºã¾ãŸã¯ãã®å»¶é•·ä¸Šã®3ç‚¹ãŒä¸€ç›´ç·šä¸Šã«ã‚ã‚‹æ¡ä»¶" },
    "ceva": { name: "ãƒã‚§ãƒã®å®šç†", latex: "\\frac{BD}{DC} \\cdot \\frac{CE}{EA} \\cdot \\frac{AF}{FB} = 1", desc: "ä¸‰è§’å½¢ã®é ‚ç‚¹ã¨å¯¾è¾ºä¸Šã®ç‚¹ã‚’çµã¶ç·šåˆ†ãŒ1ç‚¹ã§äº¤ã‚ã‚‹æ¡ä»¶" },
    "euclidean_algorithm": { name: "ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•", latex: "\\gcd(a, b) = \\gcd(b, a \\bmod b)", desc: "å‰²ã‚Šç®—ã®ä½™ã‚Šã‚’ä½¿ã£ã¦æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ " },
    "binomial_theorem": { name: "äºŒé …å®šç†", latex: "(a+b)^n = \\sum_{r=0}^{n} {}_nC_r \\, a^{n-r} b^r", desc: "nä¹—ã®å±•é–‹å…¬å¼" },
    "remainder_theorem": { name: "å‰°ä½™ã®å®šç†", latex: "P(a) = (P(x)\\text{ã‚’}(x-a)\\text{ã§å‰²ã£ãŸä½™ã‚Š})", desc: "å¤šé …å¼P(x)ã‚’(x-a)ã§å‰²ã£ãŸä½™ã‚Šã¯P(a)ã«ç­‰ã—ã„" },
    "vieta_formulas": { name: "è§£ã¨ä¿‚æ•°ã®é–¢ä¿‚", latex: "\\alpha + \\beta = -\\frac{b}{a}, \\quad \\alpha\\beta = \\frac{c}{a}", desc: "äºŒæ¬¡æ–¹ç¨‹å¼ã®2è§£ã®å’Œã¨ç©" },
    "point_line_distance": { name: "ç‚¹ã¨ç›´ç·šã®è·é›¢", latex: "d = \\frac{|ax_0 + by_0 + c|}{\\sqrt{a^2 + b^2}}", desc: "ç‚¹(xâ‚€,yâ‚€)ã¨ç›´ç·š ax+by+c=0 ã®è·é›¢" },
    "circle_equation": { name: "å††ã®æ–¹ç¨‹å¼", latex: "(x-a)^2 + (y-b)^2 = r^2", desc: "ä¸­å¿ƒ(a,b)ã€åŠå¾„rã®å††ã®æ–¹ç¨‹å¼" },
    "sin_addition": { name: "åŠ æ³•å®šç†ï¼ˆsinï¼‰", latex: "\\sin(\\alpha \\pm \\beta) = \\sin\\alpha\\cos\\beta \\pm \\cos\\alpha\\sin\\beta", desc: "ä¸‰è§’é–¢æ•°ã®åŠ æ³•å®šç†ã€‚å€è§’ãƒ»åŠè§’å…¬å¼ã®å…ƒ" },
    "cos_addition": { name: "åŠ æ³•å®šç†ï¼ˆcosï¼‰", latex: "\\cos(\\alpha \\pm \\beta) = \\cos\\alpha\\cos\\beta \\mp \\sin\\alpha\\sin\\beta", desc: "ä¸‰è§’é–¢æ•°ã®åŠ æ³•å®šç†ã€‚Â±ã®ç¬¦å·ãŒé€†ã«ãªã‚‹" },
    "trig_synthesis": { name: "ä¸‰è§’é–¢æ•°ã®åˆæˆ", latex: "a\\sin\\theta + b\\cos\\theta = \\sqrt{a^2+b^2}\\sin(\\theta + \\alpha)", desc: "æœ€å¤§æœ€å°å•é¡Œã®å¿…é ˆãƒ†ã‚¯ãƒ‹ãƒƒã‚¯" },
    "double_angle_sin": { name: "å€è§’ã®å…¬å¼ï¼ˆsinï¼‰", latex: "\\sin 2\\alpha = 2\\sin\\alpha\\cos\\alpha", desc: "åŠ æ³•å®šç†ã§Î±=Î²ã¨ã—ãŸã‚‚ã®" },
    "double_angle_cos": { name: "å€è§’ã®å…¬å¼ï¼ˆcosï¼‰", latex: "\\cos 2\\alpha = \\cos^2\\alpha - \\sin^2\\alpha", desc: "=2cosÂ²Î±-1=1-2sinÂ²Î±ã®3ã¤ã®å½¢ã‚’ä½¿ã„åˆ†ã‘ã‚‹" },
    "log_properties": { name: "å¯¾æ•°ã®æ€§è³ª", latex: "\\log_a MN = \\log_a M + \\log_a N", desc: "å¯¾æ•°ã®å’Œâ†’ç©ã®æ³•å‰‡" },
    "log_base_change": { name: "åº•ã®å¤‰æ›å…¬å¼", latex: "\\log_a b = \\frac{\\log_c b}{\\log_c a}", desc: "åº•ã‚’æƒãˆãŸã„ã¨ãã«ä½¿ã†" },
    "power_derivative": { name: "å¾®åˆ†ã®åŸºæœ¬å…¬å¼", latex: "(x^n)' = nx^{n-1}", desc: "ã¹ãä¹—é–¢æ•°ã®å¾®åˆ†ã€‚æŒ‡æ•°ã‚’å‰ã«å‡ºã—ã€1ä¸‹ã’ã‚‹" },
    "tangent_line": { name: "æ¥ç·šã®æ–¹ç¨‹å¼", latex: "y - f(a) = f'(a)(x - a)", desc: "æ›²ç·šä¸Šã®ç‚¹ã«ãŠã‘ã‚‹æ¥ç·š" },
    "area_one_sixth": { name: "é¢ç©ã®1/6å…¬å¼", latex: "S = \\frac{|a|}{6}(\\beta - \\alpha)^3", desc: "æ”¾ç‰©ç·šã¨xè»¸ã§å›²ã¾ã‚ŒãŸé¢ç©" },
    "arithmetic_seq": { name: "ç­‰å·®æ•°åˆ—ã®ä¸€èˆ¬é …", latex: "a_n = a_1 + (n-1)d", desc: "åˆé …aâ‚ã€å…¬å·®dã®ç­‰å·®æ•°åˆ—ã®ç¬¬né …" },
    "arithmetic_sum": { name: "ç­‰å·®æ•°åˆ—ã®å’Œ", latex: "S_n = \\frac{n(a_1 + a_n)}{2}", desc: "åˆé …ã¨æœ«é …ã®å¹³å‡Ã—é …æ•°" },
    "geometric_seq": { name: "ç­‰æ¯”æ•°åˆ—ã®ä¸€èˆ¬é …", latex: "a_n = a_1 \\cdot r^{n-1}", desc: "åˆé …aâ‚ã€å…¬æ¯”rã®ç­‰æ¯”æ•°åˆ—ã®ç¬¬né …" },
    "geometric_sum": { name: "ç­‰æ¯”æ•°åˆ—ã®å’Œ", latex: "S_n = \\frac{a_1(1 - r^n)}{1 - r}", desc: "å…¬æ¯”râ‰ 1ã®ã¨ãã®ç­‰æ¯”æ•°åˆ—ã®å’Œ" },
    "z_score": { name: "æ­£è¦åˆ†å¸ƒã®æ¨™æº–åŒ–", latex: "Z = \\frac{X - \\mu}{\\sigma}", desc: "æ­£è¦åˆ†å¸ƒã‚’æ¨™æº–æ­£è¦åˆ†å¸ƒN(0,1)ã«å¤‰æ›" },
    "confidence_interval": { name: "ä¿¡é ¼åŒºé–“ï¼ˆ95%ï¼‰", latex: "\\bar{x} - 1.96\\frac{\\sigma}{\\sqrt{n}} \\leq \\mu \\leq \\bar{x} + 1.96\\frac{\\sigma}{\\sqrt{n}}", desc: "æ¯å¹³å‡Î¼ã®95%ä¿¡é ¼åŒºé–“" },
    "infinite_geometric_series": { name: "ç„¡é™ç­‰æ¯”ç´šæ•°ã®å’Œ", latex: "\\sum_{n=1}^{\\infty} ar^{n-1} = \\frac{a}{1-r} \\quad (|r|<1)", desc: "å…¬æ¯”ã®çµ¶å¯¾å€¤ãŒ1æœªæº€ã®ã¨ãåæŸã™ã‚‹" },
    "e_definition": { name: "eã®å®šç¾©", latex: "e = \\lim_{n \\to \\infty}\\left(1 + \\frac{1}{n}\\right)^n", desc: "è‡ªç„¶å¯¾æ•°ã®åº•eã®å®šç¾©ã€‚ç´„ 2.718" },
    "chain_rule": { name: "åˆæˆé–¢æ•°ã®å¾®åˆ†ï¼ˆé€£é–å¾‹å‰‡ï¼‰", latex: "\\{f(g(x))\\}' = f'(g(x)) \\cdot g'(x)", desc: "å¤–å´ã®å¾®åˆ†Ã—å†…å´ã®å¾®åˆ†" },
    "trig_derivatives": { name: "ä¸‰è§’é–¢æ•°ã®å¾®åˆ†", latex: "(\\sin x)' = \\cos x, \\quad (\\cos x)' = -\\sin x", desc: "sinã®å¾®åˆ†ã¯cosã€cosã®å¾®åˆ†ã¯-sin" },
    "exp_log_derivatives": { name: "æŒ‡æ•°ãƒ»å¯¾æ•°é–¢æ•°ã®å¾®åˆ†", latex: "(e^x)' = e^x, \\quad (\\log x)' = \\frac{1}{x}", desc: "e^xã¯å¾®åˆ†ã—ã¦ã‚‚å¤‰ã‚ã‚‰ãªã„" },
    "integration_by_parts": { name: "éƒ¨åˆ†ç©åˆ†", latex: "\\int f(x)g'(x)dx = f(x)g(x) - \\int f'(x)g(x)dx", desc: "ç©ã®å¾®åˆ†ã‚’é€†ã«ä½¿ã†ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯" },
    "volume_rotation": { name: "å›è»¢ä½“ã®ä½“ç©", latex: "V = \\pi\\int_a^b \\{f(x)\\}^2 dx", desc: "y=f(x)ã‚’xè»¸ã®ã¾ã‚ã‚Šã«å›è»¢ã•ã›ãŸä½“ç©" },
    "dot_product": { name: "å†…ç©", latex: "\\vec{a} \\cdot \\vec{b} = |\\vec{a}||\\vec{b}|\\cos\\theta", desc: "ãƒ™ã‚¯ãƒˆãƒ«ã®å†…ç©ã€‚å‚ç›´ã®ã¨ã0ã«ãªã‚‹" },
    "dot_product_components": { name: "å†…ç©ï¼ˆæˆåˆ†è¡¨ç¤ºï¼‰", latex: "\\vec{a} \\cdot \\vec{b} = a_1b_1 + a_2b_2", desc: "æˆåˆ†ã§ã®å†…ç©è¨ˆç®—" },
    "ellipse": { name: "æ¥•å††ã®æ–¹ç¨‹å¼", latex: "\\frac{x^2}{a^2} + \\frac{y^2}{b^2} = 1", desc: "é•·è»¸aã€çŸ­è»¸bã®æ¥•å††" },
    "hyperbola": { name: "åŒæ›²ç·šã®æ–¹ç¨‹å¼", latex: "\\frac{x^2}{a^2} - \\frac{y^2}{b^2} = 1", desc: "æ¼¸è¿‘ç·š y=Â±(b/a)x" },
    "polar_conversion": { name: "æ¥µåº§æ¨™ã¨ç›´äº¤åº§æ¨™ã®å¤‰æ›", latex: "x = r\\cos\\theta, \\quad y = r\\sin\\theta", desc: "æ¥µåº§æ¨™ã¨ç›´äº¤åº§æ¨™ã®ç›¸äº’å¤‰æ›" },
    "complex_polar": { name: "è¤‡ç´ æ•°ã®æ¥µå½¢å¼", latex: "z = r(\\cos\\theta + i\\sin\\theta)", desc: "çµ¶å¯¾å€¤rã€åè§’Î¸ã§è¤‡ç´ æ•°ã‚’è¡¨ã™å½¢å¼" },
    "de_moivre": { name: "ãƒ‰ãƒ»ãƒ¢ã‚¢ãƒ–ãƒ«ã®å®šç†", latex: "(\\cos\\theta + i\\sin\\theta)^n = \\cos n\\theta + i\\sin n\\theta", desc: "è¤‡ç´ æ•°ã®nä¹—ã‚’æ¥µå½¢å¼ã§ç°¡å˜ã«è¨ˆç®—ã§ãã‚‹" },
};

// unit_key list for GPT prompt
const UNIT_KEY_LIST = Object.entries(UNIT_DB).map(([k,v]) => k + ' (' + v.name + ')').join(', ');

// Legacy mapping: unit display name â†’ unit_key (for backward compat)
const UNIT_NAME_TO_KEY = {};
Object.entries(UNIT_DB).forEach(([key, unit]) => { UNIT_NAME_TO_KEY[unit.name] = key; });

const CATEGORY_LABELS = {
    "math1a": "æ•°å­¦â… ãƒ»A",
    "math2b": "æ•°å­¦â…¡ãƒ»B",
    "math3c": "æ•°å­¦â…¢ãƒ»C",
};

function getUnitByKey(key) { return UNIT_DB[key] || null; }
function getFormulaByKey(key) { return FORMULA_DB[key] || null; }
function getFormulasForUnit(unitKey) {
    const unit = UNIT_DB[unitKey];
    if (!unit) return [];
    return unit.formulas.map(fk => FORMULA_DB[fk]).filter(Boolean);
}
function getCategoryForKey(unitKey) {
    const unit = UNIT_DB[unitKey];
    return unit ? unit.category : 'math1a';
}
function getCategoryLabel(unitKey) {
    return CATEGORY_LABELS[getCategoryForKey(unitKey)] || 'æ•°å­¦';
}
// For legacy tag name â†’ category class
function getTagClass(tagName) {
    const key = UNIT_NAME_TO_KEY[tagName];
    return key ? UNIT_DB[key].category : 'math1a';
}

// â•â•â• Sub-unit Database â•â•â•
const SUB_UNIT_DB = {
    // æ•°å­¦â…  â€” æ•°ã¨å¼
    "exp_expand":     { name: "å±•é–‹", unit_key: "expressions", order: 1, overview: "ä¹—æ³•å…¬å¼ã‚’ä½¿ã£ãŸå¼ã®å±•é–‹" },
    "exp_factor":     { name: "å› æ•°åˆ†è§£", unit_key: "expressions", order: 2, overview: "å…±é€šå› æ•°ã®ããã‚Šå‡ºã—ã€å…¬å¼ã‚’ä½¿ã£ãŸå› æ•°åˆ†è§£" },
    "exp_real_ineq":  { name: "å®Ÿæ•°ã¨1æ¬¡ä¸ç­‰å¼", unit_key: "expressions", order: 3, overview: "å®Ÿæ•°ã®åˆ†é¡ã¨1æ¬¡ä¸ç­‰å¼ã®è§£æ³•" },
    // æ•°å­¦â…  â€” é›†åˆã¨å‘½é¡Œ
    "sets_set":       { name: "é›†åˆ", unit_key: "sets_logic", order: 1, overview: "é›†åˆã®è¡¨ã—æ–¹ã€å…±é€šéƒ¨åˆ†ãƒ»å’Œé›†åˆ" },
    "sets_prop":      { name: "å‘½é¡Œã¨æ¡ä»¶", unit_key: "sets_logic", order: 2, overview: "å‘½é¡Œã®çœŸå½ã€å¿…è¦æ¡ä»¶ãƒ»ååˆ†æ¡ä»¶" },
    // æ•°å­¦â…  â€” äºŒæ¬¡é–¢æ•°
    "qf_graph":       { name: "ã‚°ãƒ©ãƒ•ã¨å¹³æ–¹å®Œæˆ", unit_key: "quadratic_function", order: 1, overview: "å¹³æ–¹å®Œæˆã«ã‚ˆã‚‹æ¨™æº–å½¢ã¸ã®å¤‰å½¢ã¨ã‚°ãƒ©ãƒ•ã®æç”»" },
    "qf_maxmin":      { name: "æœ€å¤§å€¤ãƒ»æœ€å°å€¤", unit_key: "quadratic_function", order: 2, overview: "å®šç¾©åŸŸä»˜ãã®æœ€å¤§å€¤ãƒ»æœ€å°å€¤å•é¡Œ" },
    "qf_eq_ineq":     { name: "äºŒæ¬¡æ–¹ç¨‹å¼ãƒ»ä¸ç­‰å¼", unit_key: "quadratic_function", order: 3, overview: "åˆ¤åˆ¥å¼ã‚’ä½¿ã£ãŸè§£ã®åˆ†æã€äºŒæ¬¡ä¸ç­‰å¼ã®è§£æ³•" },
    // æ•°å­¦â…  â€” å›³å½¢ã¨è¨ˆé‡
    "tr_ratio":       { name: "ä¸‰è§’æ¯”ã®å®šç¾©", unit_key: "trigonometric_ratio", order: 1, overview: "sin, cos, tanã®å®šç¾©ã¨ç›¸äº’é–¢ä¿‚" },
    "tr_law":         { name: "æ­£å¼¦å®šç†ãƒ»ä½™å¼¦å®šç†", unit_key: "trigonometric_ratio", order: 2, overview: "æ­£å¼¦å®šç†ã¨ä½™å¼¦å®šç†ã®ä½¿ã„åˆ†ã‘" },
    "tr_area":        { name: "å›³å½¢ã®è¨ˆé‡", unit_key: "trigonometric_ratio", order: 3, overview: "ä¸‰è§’æ¯”ã‚’ä½¿ã£ãŸé¢ç©ãƒ»è¾ºã®é•·ã•ã®è¨ˆç®—" },
    // æ•°å­¦â…  â€” ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ
    "da_stats":       { name: "ä»£è¡¨å€¤ã¨æ•£å¸ƒåº¦", unit_key: "data_analysis", order: 1, overview: "å¹³å‡å€¤ã€åˆ†æ•£ã€æ¨™æº–åå·®ã®è¨ˆç®—" },
    "da_corr":        { name: "ç›¸é–¢", unit_key: "data_analysis", order: 2, overview: "æ•£å¸ƒå›³ã¨ç›¸é–¢ä¿‚æ•°ã®èª­ã¿å–ã‚Š" },
    // æ•°å­¦A â€” å ´åˆã®æ•°ã¨ç¢ºç‡
    "prob_count":     { name: "å ´åˆã®æ•°", unit_key: "probability", order: 1, overview: "æ¨¹å½¢å›³ã€å’Œã®æ³•å‰‡ãƒ»ç©ã®æ³•å‰‡" },
    "prob_perm_comb": { name: "é †åˆ—ãƒ»çµ„åˆã›", unit_key: "probability", order: 2, overview: "é †åˆ—Pã€çµ„åˆã›Cã®è¨ˆç®—ã¨ä½¿ã„åˆ†ã‘" },
    "prob_basic":     { name: "ç¢ºç‡ã®åŸºæœ¬", unit_key: "probability", order: 3, overview: "ç¢ºç‡ã®åŠ æ³•å®šç†ã€ä½™äº‹è±¡" },
    "prob_cond":      { name: "æ¡ä»¶ä»˜ãç¢ºç‡", unit_key: "probability", order: 4, overview: "æ¡ä»¶ä»˜ãç¢ºç‡ã¨ç¢ºç‡ã®ä¹—æ³•å®šç†" },
    // æ•°å­¦A â€” å›³å½¢ã®æ€§è³ª
    "geo_triangle":   { name: "ä¸‰è§’å½¢ã®æ€§è³ª", unit_key: "geometry_properties", order: 1, overview: "äº”å¿ƒã€è§’ã®äºŒç­‰åˆ†ç·šã®æ€§è³ª" },
    "geo_circle":     { name: "å††ã®æ€§è³ª", unit_key: "geometry_properties", order: 2, overview: "å††å‘¨è§’ã€æ¥ç·šã€æ–¹ã¹ãã®å®šç†" },
    // æ•°å­¦A â€” æ•´æ•°ã®æ€§è³ª
    "int_divisor":    { name: "ç´„æ•°ã¨å€æ•°", unit_key: "integer_properties", order: 1, overview: "ç´ å› æ•°åˆ†è§£ã€ç´„æ•°ã®å€‹æ•°ã¨ç·å’Œ" },
    "int_euclid":     { name: "äº’é™¤æ³•ã¨ä¸å®šæ–¹ç¨‹å¼", unit_key: "integer_properties", order: 2, overview: "ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã€1æ¬¡ä¸å®šæ–¹ç¨‹å¼" },
    // æ•°å­¦â…¡ â€” å¼ã¨è¨¼æ˜
    "prf_binomial":   { name: "äºŒé …å®šç†", unit_key: "equations_proof", order: 1, overview: "äºŒé …å®šç†ã¨ä¸€èˆ¬é …ã®åˆ©ç”¨" },
    "prf_proof":      { name: "ç­‰å¼ãƒ»ä¸ç­‰å¼ã®è¨¼æ˜", unit_key: "equations_proof", order: 2, overview: "æ’ç­‰å¼ã®è¨¼æ˜ã€ç›¸åŠ ç›¸ä¹—å¹³å‡" },
    // æ•°å­¦â…¡ â€” è¤‡ç´ æ•°ã¨æ–¹ç¨‹å¼
    "ceq_complex":    { name: "è¤‡ç´ æ•°ã®è¨ˆç®—", unit_key: "complex_equations", order: 1, overview: "è™šæ•°å˜ä½iã¨è¤‡ç´ æ•°ã®å››å‰‡æ¼”ç®—" },
    "ceq_vieta":      { name: "è§£ã¨ä¿‚æ•°ã®é–¢ä¿‚", unit_key: "complex_equations", order: 2, overview: "äºŒæ¬¡æ–¹ç¨‹å¼ã®è§£ã®å’Œã¨ç©" },
    "ceq_higher":     { name: "é«˜æ¬¡æ–¹ç¨‹å¼", unit_key: "complex_equations", order: 3, overview: "å› æ•°å®šç†ã‚’ä½¿ã£ãŸé«˜æ¬¡æ–¹ç¨‹å¼ã®è§£æ³•" },
    // æ•°å­¦â…¡ â€” å›³å½¢ã¨æ–¹ç¨‹å¼
    "cg_line":        { name: "ç›´ç·šã®æ–¹ç¨‹å¼", unit_key: "coordinate_geometry", order: 1, overview: "2ç‚¹ã‚’é€šã‚‹ç›´ç·šã€ç‚¹ã¨ç›´ç·šã®è·é›¢" },
    "cg_circle":      { name: "å††ã®æ–¹ç¨‹å¼", unit_key: "coordinate_geometry", order: 2, overview: "å††ã®æ–¹ç¨‹å¼ã¨ç›´ç·šã¨ã®ä½ç½®é–¢ä¿‚" },
    "cg_region":      { name: "è»Œè·¡ã¨é ˜åŸŸ", unit_key: "coordinate_geometry", order: 3, overview: "è»Œè·¡ã®æ–¹ç¨‹å¼ã€ä¸ç­‰å¼ã®è¡¨ã™é ˜åŸŸ" },
    // æ•°å­¦â…¡ â€” ä¸‰è§’é–¢æ•°
    "tf_graph":       { name: "ä¸‰è§’é–¢æ•°ã®ã‚°ãƒ©ãƒ•", unit_key: "trigonometric_function", order: 1, overview: "å¼§åº¦æ³•ã€å‘¨æœŸã€æŒ¯å¹…" },
    "tf_addition":    { name: "åŠ æ³•å®šç†", unit_key: "trigonometric_function", order: 2, overview: "sin, cosã®åŠ æ³•å®šç†ã¨å€è§’ã®å…¬å¼" },
    "tf_synthesis":   { name: "ä¸‰è§’é–¢æ•°ã®åˆæˆ", unit_key: "trigonometric_function", order: 3, overview: "a sinÎ¸ + b cosÎ¸ã®åˆæˆã¨æœ€å¤§æœ€å°" },
    // æ•°å­¦â…¡ â€” æŒ‡æ•°é–¢æ•°ãƒ»å¯¾æ•°é–¢æ•°
    "el_exp":         { name: "æŒ‡æ•°é–¢æ•°", unit_key: "exponential_logarithm", order: 1, overview: "æŒ‡æ•°æ³•å‰‡ã¨æŒ‡æ•°é–¢æ•°ã®ã‚°ãƒ©ãƒ•" },
    "el_log":         { name: "å¯¾æ•°é–¢æ•°", unit_key: "exponential_logarithm", order: 2, overview: "å¯¾æ•°ã®æ€§è³ªã€åº•ã®å¤‰æ›" },
    // æ•°å­¦â…¡ â€” å¾®åˆ†æ³•
    "d2_deriv":       { name: "å°é–¢æ•°ã¨æ¥ç·š", unit_key: "differentiation_2", order: 1, overview: "ã¹ãä¹—ã®å¾®åˆ†ã€æ¥ç·šã®æ–¹ç¨‹å¼" },
    "d2_app":         { name: "é–¢æ•°ã®å¢—æ¸›ãƒ»æ¥µå€¤", unit_key: "differentiation_2", order: 2, overview: "å¢—æ¸›è¡¨ã¨æ¥µå¤§æ¥µå°ã®åˆ¤å®š" },
    // æ•°å­¦â…¡ â€” ç©åˆ†æ³•
    "i2_basic":       { name: "ä¸å®šç©åˆ†ãƒ»å®šç©åˆ†", unit_key: "integration_2", order: 1, overview: "å¤šé …å¼ã®ç©åˆ†è¨ˆç®—" },
    "i2_area":        { name: "é¢ç©", unit_key: "integration_2", order: 2, overview: "å®šç©åˆ†ã«ã‚ˆã‚‹é¢ç©ã®è¨ˆç®—" },
    // æ•°å­¦B â€” æ•°åˆ—
    "seq_arith_geo":  { name: "ç­‰å·®ãƒ»ç­‰æ¯”æ•°åˆ—", unit_key: "sequences", order: 1, overview: "ä¸€èˆ¬é …ã¨å’Œã®å…¬å¼" },
    "seq_recurrence": { name: "æ¼¸åŒ–å¼", unit_key: "sequences", order: 2, overview: "ç‰¹æ€§æ–¹ç¨‹å¼ã«ã‚ˆã‚‹æ¼¸åŒ–å¼ã®è§£æ³•" },
    "seq_induction":  { name: "æ•°å­¦çš„å¸°ç´æ³•", unit_key: "sequences", order: 3, overview: "æ•°å­¦çš„å¸°ç´æ³•ã«ã‚ˆã‚‹è¨¼æ˜" },
    // æ•°å­¦B â€” çµ±è¨ˆçš„ãªæ¨æ¸¬
    "si_dist":        { name: "ç¢ºç‡åˆ†å¸ƒ", unit_key: "statistical_inference", order: 1, overview: "ç¢ºç‡å¤‰æ•°ã®æœŸå¾…å€¤ã¨åˆ†æ•£" },
    "si_normal":      { name: "æ­£è¦åˆ†å¸ƒã¨æ¨å®š", unit_key: "statistical_inference", order: 2, overview: "æ­£è¦åˆ†å¸ƒã®æ¨™æº–åŒ–ã€ä¿¡é ¼åŒºé–“" },
    "si_test":        { name: "ä»®èª¬æ¤œå®š", unit_key: "statistical_inference", order: 3, overview: "å¸°ç„¡ä»®èª¬ã¨æœ‰æ„æ°´æº–" },
    // æ•°å­¦â…¢ â€” æ¥µé™
    "lim_seq":        { name: "æ•°åˆ—ã®æ¥µé™", unit_key: "limits", order: 1, overview: "åæŸãƒ»ç™ºæ•£ã®åˆ¤å®šã€ã¯ã•ã¿ã†ã¡ã®åŸç†" },
    "lim_func":       { name: "é–¢æ•°ã®æ¥µé™", unit_key: "limits", order: 2, overview: "é–¢æ•°ã®æ¥µé™ã¨é€£ç¶šæ€§" },
    // æ•°å­¦â…¢ â€” å¾®åˆ†æ³•
    "d3_comp":        { name: "åˆæˆé–¢æ•°ã®å¾®åˆ†", unit_key: "differentiation_3", order: 1, overview: "é€£é–å¾‹å‰‡ã«ã‚ˆã‚‹å¾®åˆ†" },
    "d3_trig_exp":    { name: "ä¸‰è§’ãƒ»æŒ‡æ•°ãƒ»å¯¾æ•°ã®å¾®åˆ†", unit_key: "differentiation_3", order: 2, overview: "sin, cos, eË£, log xã®å¾®åˆ†" },
    "d3_param":       { name: "åª’ä»‹å¤‰æ•°è¡¨ç¤º", unit_key: "differentiation_3", order: 3, overview: "åª’ä»‹å¤‰æ•°è¡¨ç¤ºã®å¾®åˆ†" },
    // æ•°å­¦â…¢ â€” ç©åˆ†æ³•
    "i3_subst":       { name: "ç½®æ›ç©åˆ†ãƒ»éƒ¨åˆ†ç©åˆ†", unit_key: "integration_3", order: 1, overview: "ç½®æ›ç©åˆ†æ³•ã¨éƒ¨åˆ†ç©åˆ†æ³•" },
    "i3_vol":         { name: "é¢ç©ãƒ»ä½“ç©", unit_key: "integration_3", order: 2, overview: "é¢ç©ã€å›è»¢ä½“ã®ä½“ç©ã€å¼§é•·" },
    // æ•°å­¦C â€” ãƒ™ã‚¯ãƒˆãƒ«
    "vec_plane":      { name: "å¹³é¢ãƒ™ã‚¯ãƒˆãƒ«", unit_key: "vectors", order: 1, overview: "ãƒ™ã‚¯ãƒˆãƒ«ã®åŠ æ³•ãƒ»æ¸›æ³•ã€å®Ÿæ•°å€" },
    "vec_space":      { name: "ç©ºé–“ãƒ™ã‚¯ãƒˆãƒ«", unit_key: "vectors", order: 2, overview: "ç©ºé–“ã«ãŠã‘ã‚‹ä½ç½®ãƒ™ã‚¯ãƒˆãƒ«ã¨å†…ç©" },
    // æ•°å­¦C â€” å¹³é¢ä¸Šã®æ›²ç·š
    "pc_conic":       { name: "äºŒæ¬¡æ›²ç·š", unit_key: "plane_curves", order: 1, overview: "æ”¾ç‰©ç·šãƒ»æ¥•å††ãƒ»åŒæ›²ç·š" },
    "pc_param":       { name: "åª’ä»‹å¤‰æ•°è¡¨ç¤º", unit_key: "plane_curves", order: 2, overview: "æ›²ç·šã®åª’ä»‹å¤‰æ•°è¡¨ç¤º" },
    "pc_polar":       { name: "æ¥µåº§æ¨™", unit_key: "plane_curves", order: 3, overview: "æ¥µåº§æ¨™ã¨ç›´äº¤åº§æ¨™ã®å¤‰æ›" },
    // æ•°å­¦C â€” è¤‡ç´ æ•°å¹³é¢
    "cp_polar":       { name: "æ¥µå½¢å¼", unit_key: "complex_plane", order: 1, overview: "è¤‡ç´ æ•°ã®æ¥µå½¢å¼ã¨å¹¾ä½•å­¦çš„æ„å‘³" },
    "cp_demoivre":    { name: "ãƒ‰ãƒ»ãƒ¢ã‚¢ãƒ–ãƒ«ã®å®šç†", unit_key: "complex_plane", order: 2, overview: "nä¹—æ ¹ã¨å›è»¢" },
};

// Helper: get sub-units for a unit_key
function getSubUnitsForUnit(unitKey) {
    return Object.entries(SUB_UNIT_DB)
        .filter(([_, su]) => su.unit_key === unitKey)
        .sort((a, b) => a[1].order - b[1].order)
        .map(([key, su]) => ({ key, ...su }));
}

// â•â•â• Problem Database (ã‚µãƒ³ãƒ—ãƒ«å•é¡Œ â€” Notionã‹ã‚‰è¿½åŠ å¯èƒ½) â•â•â•
const PROBLEM_DB = {
    // æ•°ã¨å¼ â€” å±•é–‹
    "exp_expand_01": {
        sub_unit_key: "exp_expand", order: 1, title: "ä¹—æ³•å…¬å¼ã®åŸºæœ¬",
        problem_text: "æ¬¡ã®å¼ã‚’å±•é–‹ã›ã‚ˆã€‚\n$(x+3)^2$",
        difficulty: "åŸºæœ¬", hint: "$(a+b)^2 = a^2 + 2ab + b^2$ ã®å…¬å¼ã‚’ä½¿ãŠã†"
    },
    "exp_expand_02": {
        sub_unit_key: "exp_expand", order: 2, title: "å’Œã¨å·®ã®ç©",
        problem_text: "æ¬¡ã®å¼ã‚’å±•é–‹ã›ã‚ˆã€‚\n$(2x+5)(2x-5)$",
        difficulty: "åŸºæœ¬", hint: "$(a+b)(a-b) = a^2 - b^2$ ã‚’ä½¿ãŠã†"
    },
    // æ•°ã¨å¼ â€” å› æ•°åˆ†è§£
    "exp_factor_01": {
        sub_unit_key: "exp_factor", order: 1, title: "å…±é€šå› æ•°ã¨å…¬å¼",
        problem_text: "æ¬¡ã®å¼ã‚’å› æ•°åˆ†è§£ã›ã‚ˆã€‚\n$x^2 + 6x + 9$",
        difficulty: "åŸºæœ¬", hint: "å’Œã®äºŒä¹—ã®å½¢ $a^2 + 2ab + b^2$ ã«ãªã£ã¦ã„ãªã„ã‹ç¢ºèªã—ã‚ˆã†"
    },
    "exp_factor_02": {
        sub_unit_key: "exp_factor", order: 2, title: "ãŸã™ãæ›ã‘",
        problem_text: "æ¬¡ã®å¼ã‚’å› æ•°åˆ†è§£ã›ã‚ˆã€‚\n$2x^2 + 5x + 3$",
        difficulty: "æ¨™æº–", hint: "ãŸã™ãæ›ã‘ã§åˆ†è§£ã§ãã‚‹çµ„ã¿åˆã‚ã›ã‚’æ¢ãã†"
    },
    // äºŒæ¬¡é–¢æ•° â€” ã‚°ãƒ©ãƒ•ã¨å¹³æ–¹å®Œæˆ
    "qf_graph_01": {
        sub_unit_key: "qf_graph", order: 1, title: "å¹³æ–¹å®Œæˆ",
        problem_text: "æ¬¡ã®äºŒæ¬¡é–¢æ•°ã®ã‚°ãƒ©ãƒ•ã®é ‚ç‚¹ã®åº§æ¨™ã‚’æ±‚ã‚ã‚ˆã€‚\n$y = x^2 - 4x + 7$",
        difficulty: "åŸºæœ¬", hint: "å¹³æ–¹å®Œæˆã—ã¦ $y = (x-p)^2 + q$ ã®å½¢ã«ã—ã‚ˆã†"
    },
    // äºŒæ¬¡é–¢æ•° â€” æœ€å¤§å€¤ãƒ»æœ€å°å€¤
    "qf_maxmin_01": {
        sub_unit_key: "qf_maxmin", order: 1, title: "å®šç¾©åŸŸãªã—ã®æœ€å°å€¤",
        problem_text: "äºŒæ¬¡é–¢æ•° $y = x^2 - 6x + 11$ ã®æœ€å°å€¤ã‚’æ±‚ã‚ã‚ˆã€‚",
        difficulty: "åŸºæœ¬", hint: "å¹³æ–¹å®Œæˆã—ã¦é ‚ç‚¹ã‚’æ±‚ã‚ã‚ˆã†"
    },
    // å›³å½¢ã¨è¨ˆé‡ â€” æ­£å¼¦å®šç†ãƒ»ä½™å¼¦å®šç†
    "tr_law_01": {
        sub_unit_key: "tr_law", order: 1, title: "ä½™å¼¦å®šç†",
        problem_text: "ä¸‰è§’å½¢ABCã«ãŠã„ã¦ã€$a=5$, $b=7$, $C=60Â°$ ã®ã¨ãã€$c$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚",
        difficulty: "æ¨™æº–", hint: "$c^2 = a^2 + b^2 - 2ab\\cos C$ ã‚’ä½¿ãŠã†"
    },
    // ç¢ºç‡ â€” é †åˆ—ãƒ»çµ„åˆã›
    "prob_perm_comb_01": {
        sub_unit_key: "prob_perm_comb", order: 1, title: "çµ„åˆã›ã®åŸºæœ¬",
        problem_text: "10äººã®ä¸­ã‹ã‚‰3äººã®å§”å“¡ã‚’é¸ã¶æ–¹æ³•ã¯ä½•é€šã‚Šã‚ã‚‹ã‹ã€‚",
        difficulty: "åŸºæœ¬", hint: "é †ç•ªã‚’è€ƒãˆãªã„ã®ã§çµ„åˆã› ${}_nC_r$ ã‚’ä½¿ãŠã†"
    },
};

// Helper: get problems for a sub_unit_key
function getProblemsForSubUnit(subUnitKey) {
    return Object.entries(PROBLEM_DB)
        .filter(([_, p]) => p.sub_unit_key === subUnitKey)
        .sort((a, b) => a[1].order - b[1].order)
        .map(([key, p]) => ({ key, ...p }));
}

// â•â•â• System Prompt â•â•â•
const SYSTEM_PROMPT = `ã‚ãªãŸã¯é«˜æ ¡1ã€œ2å¹´ç”Ÿå‘ã‘ã®ã€ã‚„ã•ã—ã„æ•°å­¦ã®å…ˆç”ŸAIã§ã™ã€‚
ç”Ÿå¾’ãŒæ‰‹æ›¸ãã§è§£ã„ãŸæ•°å­¦ã®ç­”æ¡ˆã®ç”»åƒã‚’å—ã‘å–ã‚Šã€æ¡ç‚¹ã—ã¾ã™ã€‚

ã€æ•°å¼ãƒ«ãƒ¼ãƒ«ã€‘
- èª¬æ˜æ–‡ä¸­ã®æ•°å¼ã¯å¿…ãš $...$ ã§å›²ã‚€ï¼ˆä¾‹: $x = 3$ï¼‰
- score_explanation ã®ä¸­ã§ã‚‚åŒæ§˜

ã€æ¡ç‚¹åŸºæº–ã€‘10ç‚¹æº€ç‚¹
- 10ç‚¹: å®Œå…¨æ­£è§£
- 7ã€œ9ç‚¹: æ–¹é‡ã¯åˆã£ã¦ã„ã‚‹ãŒè¨ˆç®—ãƒŸã‚¹ã‚„è¨˜è¿°ä¸è¶³
- 4ã€œ6ç‚¹: ä¸€éƒ¨æ­£ã—ã„ãŒé‡è¦ãªèª¤ã‚ŠãŒã‚ã‚‹
- 1ã€œ3ç‚¹: æ–¹é‡ã‹ã‚‰é–“é•ã£ã¦ã„ã‚‹
- 0ç‚¹: å…¨ãè§£ã‘ã¦ã„ãªã„

ã€unit_keysä¸€è¦§ã€‘
${UNIT_KEY_LIST}

ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚å…¬å¼ã¯è¿”ã•ãªãã¦OKï¼ˆã‚¢ãƒ—ãƒªå´ã§è‡ªå‹•å–å¾—ã—ã¾ã™ï¼‰ã€‚

{
  "score": 8,
  "score_message": "ç‚¹æ•°ã«å¿œã˜ãŸçŸ­ã„ä¸€è¨€ï¼ˆ10ç‚¹:ã™ã°ã‚‰ã—ã„ï¼å®Œç’§ï¼/ 7-9ç‚¹:ãŠã—ã„ï¼ã‚ã¨å°‘ã—ï¼/ 4-6ç‚¹:ã„ã„ç·šã„ã£ã¦ã‚‹ã‚ˆï¼/ 0-3ç‚¹:åŸºç¤ã‹ã‚‰ç¢ºèªã—ã‚ˆã†ï¼ï¼‰",
  "unit_keys": ["ã“ã®å•é¡ŒãŒå±ã™ã‚‹å˜å…ƒkeyã®ãƒªã‚¹ãƒˆã€‚ä¸Šã®unit_keysä¸€è¦§ã‹ã‚‰é¸æŠ"],
  "score_explanation": "7ç‚¹ä»¥ä¸‹ã®å ´åˆã®ã¿è¨˜è¼‰ã€‚ã©ã“ãŒé–“é•ã£ã¦ã„ã¦ã©ã†ã™ã‚Œã°æ­£è§£ã§ããŸã‹ã€‚æ•°å¼ã¯ $...$ ã§å›²ã‚€ã€‚8ç‚¹ä»¥ä¸Šã®å ´åˆã¯ null",
  "hint": "7ç‚¹ä»¥ä¸‹ã®å ´åˆã€æ¬¡ã«æ°—ã‚’ã¤ã‘ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‚8ç‚¹ä»¥ä¸Šãªã‚‰ null"
}`;

// â•â•â• API Call â•â•â•
async function analyze() {
    if (!selectedFile || !base64Image) return;
    if (!apiKey) { renderError('APIè¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    const btn = document.getElementById('analyzeBtn');
    btn.classList.add('loading'); btn.disabled = true;
    document.getElementById('resultsSection').innerHTML = '';
    document.getElementById('resultsSection').style.display = 'none';

    const startTime = performance.now();

    try {
        const response = await fetch('https://api.openai.com/v1/responses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({
                model: 'gpt-5-nano',
                input: [
                    { role: 'developer', content: getSystemPrompt() },
                    { role: 'user', content: [
                        { type: 'input_image', image_url: base64Image },
                        { type: 'input_text', text: 'ã“ã®ç­”æ¡ˆã‚’æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚' }
                    ]}
                ],
            }),
        });

        if (!response.ok) {
            const errData = await response.json().catch(() => null);
            throw new Error(errData?.error?.message || 'HTTP ' + response.status);
        }

        const data = await response.json();
        const processingTime = Math.round(performance.now() - startTime);

        let rawText = '';
        if (data.output) {
            for (const item of data.output) {
                if (item.type === 'message' && item.content) {
                    for (const c of item.content) {
                        if (c.type === 'output_text') rawText += c.text;
                    }
                }
            }
        }
        if (!rawText) throw new Error('APIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚');

        if (rawText.includes('```json')) rawText = rawText.split('```json')[1].split('```')[0].trim();
        else if (rawText.includes('```')) rawText = rawText.split('```')[1].split('```')[0].trim();

        const result = JSON.parse(rawText);
        const tokens = data.usage ? { input: data.usage.input_tokens, output: data.usage.output_tokens, total: data.usage.total_tokens } : null;

        renderResults(result, processingTime, tokens);
    } catch (err) {
        renderError(err.message);
    } finally {
        btn.classList.remove('loading'); btn.disabled = false;
    }
}

// â•â•â• Render Results â•â•â•
function renderResults(data, processingTime, tokens) {
    const section = document.getElementById('resultsSection');
    const score = data.score ?? 0;
    let html = '';

    // Resolve unit_keys (support both unit_keys and legacy unit_tags)
    const unitKeys = (data.unit_keys || []).map(k => {
        if (UNIT_DB[k]) return k;
        // Legacy: try to match by display name
        return UNIT_NAME_TO_KEY[k] || null;
    }).filter(Boolean);

    // Collect all formulas from matched units
    const allFormulas = [];
    const seenFormulas = new Set();
    unitKeys.forEach(uk => {
        getFormulasForUnit(uk).forEach(f => {
            const fKey = UNIT_DB[uk].formulas.find(fk => FORMULA_DB[fk] === f);
            if (fKey && !seenFormulas.has(fKey)) {
                seenFormulas.add(fKey);
                allFormulas.push(f);
            }
        });
    });

    // Score circle
    let level = 'low';
    if (score >= 10) level = 'perfect';
    else if (score >= 8) level = 'good';
    else if (score >= 5) level = 'mid';

    html += '<div class="score-display">';
    html += '<div class="score-circle ' + level + '">';
    html += '<span class="score-number">' + score + '</span>';
    html += '<span class="score-max">/ 10</span>';
    html += '</div>';
    html += '<div class="score-message ' + level + '">' + escHtml(data.score_message || '') + '</div>';
    html += '</div>';

    // Explanation (only for score <= 7)
    if (score <= 7 && data.score_explanation) {
        html += '<div class="result-card">';
        html += '<div class="result-title">ğŸ“ è§£èª¬</div>';
        html += '<div class="mixed-text">' + renderMixedText(data.score_explanation) + '</div>';

        // Formulas from DB
        if (allFormulas.length > 0) {
            html += '<div class="formula-box">';
            html += '<div class="formula-box-title">ğŸ“ é–¢é€£ã™ã‚‹å…¬å¼ãƒ»å®šç†</div>';
            allFormulas.forEach(f => {
                html += '<div class="formula-item">';
                html += '<span class="formula-name">' + escHtml(f.name) + '</span>';
                if (f.latex) html += '<div class="formula-expr">' + renderMathBlock(f.latex) + '</div>';
                if (f.desc) html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">' + escHtml(f.desc) + '</div>';
                html += '</div>';
            });
            html += '</div>';
        }
        html += '</div>';

        // Hint
        if (data.hint) {
            html += '<div class="hint-card">';
            html += '<div class="result-title" style="color:var(--warning)">ğŸ’¡ æ¬¡ã«æ°—ã‚’ã¤ã‘ã‚‹ãƒã‚¤ãƒ³ãƒˆ</div>';
            html += '<div class="mixed-text">' + renderMixedText(data.hint) + '</div>';
            html += '</div>';
        }
    }

    // Formulas for high score too
    if (score >= 8 && allFormulas.length > 0) {
        html += '<div class="result-card">';
        html += '<div class="formula-box" style="margin-top:0">';
        html += '<div class="formula-box-title">ğŸ“ ã“ã®å•é¡Œã§ä½¿ã£ãŸå…¬å¼</div>';
        allFormulas.forEach(f => {
            html += '<div class="formula-item">';
            html += '<span class="formula-name">' + escHtml(f.name) + '</span>';
            if (f.latex) html += '<div class="formula-expr">' + renderMathBlock(f.latex) + '</div>';
            html += '</div>';
        });
        html += '</div></div>';
    }

    // Unit tags (always shown) â€” now using unit_keys
    if (unitKeys.length > 0) {
        html += '<div class="unit-section">';
        html += '<div class="result-title">ğŸ“š é–¢é€£ã™ã‚‹å˜å…ƒ</div>';
        html += '<div class="unit-tags">';
        unitKeys.forEach(uk => {
            const unit = UNIT_DB[uk];
            if (!unit) return;
            const cls = unit.category;
            const cat = CATEGORY_LABELS[unit.category] || 'æ•°å­¦';
            html += '<button class="unit-tag ' + cls + '" onclick="navigateTo(\'unit\', {unitKey:\'' + uk + '\'})">';
            html += '<span style="font-size:11px;opacity:0.7">' + escHtml(cat) + '</span> ';
            html += escHtml(unit.name);
            html += ' <span class="unit-tag-arrow">â†’</span>';
            html += '</button>';
        });
        html += '</div></div>';
    }

    // Meta
    html += '<div class="meta-bar">';
    html += '<span class="meta-item"><span class="meta-label">å‡¦ç†æ™‚é–“:</span> ' + processingTime + 'ms</span>';
    if (tokens) html += '<span class="meta-item"><span class="meta-label">ãƒˆãƒ¼ã‚¯ãƒ³:</span> ' + tokens.total + '</span>';
    html += '<span class="meta-item"><span class="meta-label">ãƒ¢ãƒ‡ãƒ«:</span> GPT-5 Nano</span>';
    html += '</div>';

    section.innerHTML = html;
    section.style.display = 'block';
    section.classList.add('visible');
}

function renderError(message) {
    const section = document.getElementById('resultsSection');
    section.innerHTML = '<div class="error-card"><div class="result-title">âŒ ã‚¨ãƒ©ãƒ¼</div>' +
        '<p style="margin-top:8px;font-size:14px;color:var(--error)">' + escHtml(message) + '</p></div>';
    section.style.display = 'block';
    section.classList.add('visible');
}

// â•â•â• Learning Panel (DB-based, instant, no API call) â•â•â•
function openLearning(unitKey) {
    const overlay = document.getElementById('learningOverlay');
    const title = document.getElementById('learningTitle');
    const body = document.getElementById('learningBody');

    const unit = UNIT_DB[unitKey];
    if (!unit) {
        body.innerHTML = '<div class="error-card"><p style="color:var(--error)">å˜å…ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>';
        overlay.classList.add('visible');
        document.body.style.overflow = 'hidden';
        return;
    }

    title.textContent = unit.name + ' â€” å˜å…ƒå­¦ç¿’';
    const formulas = getFormulasForUnit(unitKey);
    const cat = CATEGORY_LABELS[unit.category] || 'æ•°å­¦';

    let html = '';

    // Subject badge + Overview
    html += '<div class="result-card" style="border-color:var(--border-accent)">';
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">';
    html += '<span class="unit-tag ' + unit.category + '" style="cursor:default;font-size:12px;padding:4px 10px">' + escHtml(cat) + '</span>';
    html += '</div>';
    html += '<div class="result-title">ğŸ“– æ¦‚è¦</div>';
    html += '<div class="mixed-text">' + escHtml(unit.summary) + '</div>';
    html += '</div>';

    // Key Formulas from DB
    if (formulas.length > 0) {
        html += '<div class="result-card">';
        html += '<div class="result-title">ğŸ“ é‡è¦å…¬å¼</div>';
        formulas.forEach(f => {
            html += '<div class="formula-box" style="margin-bottom:12px">';
            html += '<div class="formula-box-title">' + escHtml(f.name) + '</div>';
            if (f.latex) html += '<div class="math-block" style="margin:8px 0">' + renderMathBlock(f.latex) + '</div>';
            if (f.desc) html += '<div class="mixed-text" style="font-size:13px;color:var(--text-secondary)">' + escHtml(f.desc) + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }

    // Learning Points / Tips
    if (unit.tips) {
        const tips = unit.tips.split('\\n').filter(t => t.trim());
        if (tips.length > 0) {
            html += '<div class="hint-card">';
            html += '<div class="result-title" style="color:var(--warning)">ğŸ’¡ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</div>';
            html += '<ul style="margin-top:8px;padding-left:20px;line-height:1.9;font-size:14px">';
            tips.forEach(t => { html += '<li>' + renderMixedText(t) + '</li>'; });
            html += '</ul></div>';
        }
    }

    body.innerHTML = html;
    overlay.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function closeLearning(event) {
    if (event && event.target !== document.getElementById('learningOverlay')) return;
    document.getElementById('learningOverlay').classList.remove('visible');
    document.body.style.overflow = '';
}

// â•â•â• Navigation System â•â•â•
let currentScreen = 'home';
let navHistory = [];
let currentProblemContext = null; // { problemKey, subUnitKey, unitKey } or null (free mode)

function navigateTo(screenId, data) {
    if (currentScreen !== screenId) navHistory.push(currentScreen);
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const target = document.getElementById('screen-' + screenId);
    if (target) target.classList.add('active');
    currentScreen = screenId;

    // Reset upload state on screen change
    if (screenId !== 'problem') resetUploadState();

    // Screen-specific init
    if (screenId === 'home') renderHomeScreen();
    else if (screenId === 'unit' && data) renderUnitDetail(data.unitKey);
    else if (screenId === 'problem' && data) renderProblemScreen(data);
    else if (screenId === 'free') {
        currentProblemContext = null;
        navigateTo('problem', { mode: 'free' });
    }

    window.scrollTo(0, 0);
}

function navigateBack() {
    const prev = navHistory.pop() || 'home';
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const target = document.getElementById('screen-' + prev);
    if (target) target.classList.add('active');
    currentScreen = prev;
    if (prev === 'home') renderHomeScreen();
    // Re-render unit detail if going back to it (unitKey stored on element)
    if (prev === 'unit') {
        const title = document.getElementById('unitDetailTitle').textContent;
        // Find unit by name
        const entry = Object.entries(UNIT_DB).find(([_, u]) => u.name === title);
        if (entry) renderUnitDetail(entry[0]);
    }
    window.scrollTo(0, 0);
}

function resetUploadState() {
    selectedFile = null; base64Image = null;
    const pc = document.getElementById('previewContainer');
    if (pc) pc.classList.remove('visible');
    const up = document.getElementById('uploadPrompt');
    if (up) up.style.display = '';
    const ua = document.getElementById('uploadArea');
    if (ua) ua.classList.remove('has-image');
    const btn = document.getElementById('analyzeBtn');
    if (btn) { btn.disabled = true; }
    const bt = document.getElementById('btnText');
    if (bt) bt.textContent = 'ç­”æ¡ˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„';
    const rs = document.getElementById('resultsSection');
    if (rs) { rs.innerHTML = ''; rs.style.display = 'none'; rs.classList.remove('visible'); }
}

// â•â•â• Home Screen: Unit Grid â•â•â•
let activeSubjectFilter = 'all';

function renderHomeScreen() {
    // Subject tabs
    const tabsEl = document.getElementById('subjectTabs');
    const subjects = [
        { key: 'all', label: 'ã™ã¹ã¦' },
        { key: 'math1a', label: 'æ•°â… ãƒ»A' },
        { key: 'math2b', label: 'æ•°â…¡ãƒ»B' },
        { key: 'math3c', label: 'æ•°â…¢ãƒ»C' },
    ];
    tabsEl.innerHTML = subjects.map(s =>
        '<button class="subject-tab' + (activeSubjectFilter === s.key ? ' active' : '') +
        '" onclick="filterSubject(\'' + s.key + '\')">' + s.label + '</button>'
    ).join('');

    // Unit grid
    const gridEl = document.getElementById('unitGrid');
    const units = Object.entries(UNIT_DB)
        .filter(([_, u]) => activeSubjectFilter === 'all' || u.category === activeSubjectFilter)
        .sort((a, b) => a[1].order - b[1].order);

    gridEl.innerHTML = units.map(([key, u]) => {
        const subUnits = getSubUnitsForUnit(key);
        const problemCount = subUnits.reduce((sum, su) => sum + getProblemsForSubUnit(su.key).length, 0);
        const cat = CATEGORY_LABELS[u.category] || '';
        return '<div class="unit-card ' + u.category + '" onclick="navigateTo(\'unit\', {unitKey:\'' + key + '\'})">' +
            '<div class="unit-card-subject ' + u.category + '">' + escHtml(u.subject) + '</div>' +
            '<div class="unit-card-name">' + escHtml(u.name) + '</div>' +
            '<div class="unit-card-meta">' + subUnits.length + 'å°å˜å…ƒ' +
            (problemCount > 0 ? ' Â· ' + problemCount + 'å•' : '') + '</div>' +
            '</div>';
    }).join('');
}

function filterSubject(key) {
    activeSubjectFilter = key;
    renderHomeScreen();
}

// â•â•â• Unit Detail Screen â•â•â•
function renderUnitDetail(unitKey) {
    const unit = UNIT_DB[unitKey];
    if (!unit) return;

    document.getElementById('unitDetailTitle').textContent = unit.name;
    document.getElementById('unitDetailSubject').textContent = unit.subject;

    // Overview
    const overviewEl = document.getElementById('unitOverview');
    overviewEl.innerHTML = '<p>' + escHtml(unit.summary) + '</p>';

    // Sub-units
    const subUnits = getSubUnitsForUnit(unitKey);
    const listEl = document.getElementById('subunitList');

    if (subUnits.length === 0) {
        listEl.innerHTML = '<div class="empty-state">å°å˜å…ƒã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
    }

    let html = '';
    subUnits.forEach(su => {
        const problems = getProblemsForSubUnit(su.key);
        const problemLabel = problems.length > 0 ? problems.length + 'å•' : 'æº–å‚™ä¸­';
        html += '<div class="subunit-item" onclick="openSubUnit(\'' + su.key + '\', \'' + unitKey + '\')">'; 
        html += '<div><div class="subunit-name">' + escHtml(su.name) + '</div>';
        html += '<div class="subunit-meta">' + escHtml(su.overview) + ' Â· ' + problemLabel + '</div></div>';
        html += '<span class="subunit-arrow">â€º</span>';
        html += '</div>';
    });
    listEl.innerHTML = html;
}

// â•â•â• Open Sub-unit â†’ Problem List or First Problem â•â•â•
function openSubUnit(subUnitKey, unitKey) {
    const problems = getProblemsForSubUnit(subUnitKey);
    if (problems.length === 0) {
        // No problems yet â€” show coming-soon in problem screen
        navigateTo('problem', { mode: 'empty', subUnitKey, unitKey });
        return;
    }
    // Open first problem
    navigateTo('problem', {
        mode: 'problem',
        subUnitKey,
        unitKey,
        problemKey: problems[0].key,
        problemIndex: 0,
        totalProblems: problems.length,
    });
}

// â•â•â• Problem Screen â•â•â•
function renderProblemScreen(data) {
    const titleEl = document.getElementById('problemScreenTitle');
    const subEl = document.getElementById('problemScreenSub');
    const displayEl = document.getElementById('problemDisplay');
    const diffEl = document.getElementById('problemDifficulty');
    const textEl = document.getElementById('problemText');
    const hintEl = document.getElementById('problemHint');

    resetUploadState();

    if (data.mode === 'free') {
        // Free grading mode
        currentProblemContext = null;
        titleEl.textContent = 'ãƒ•ãƒªãƒ¼æ¡ç‚¹';
        subEl.textContent = 'å¥½ããªå•é¡Œã®ç­”æ¡ˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
        displayEl.style.display = 'none';
        document.getElementById('problemBackBtn').onclick = function() { navigateTo('home'); };
        return;
    }

    if (data.mode === 'empty') {
        const su = SUB_UNIT_DB[data.subUnitKey];
        titleEl.textContent = su ? su.name : 'å°å˜å…ƒ';
        subEl.textContent = 'å•é¡Œã‚’æº–å‚™ä¸­ã§ã™';
        displayEl.style.display = 'none';
        document.getElementById('problemBackBtn').onclick = function() {
            navigateTo('unit', { unitKey: data.unitKey });
        };
        // Show empty state in results area
        const rs = document.getElementById('resultsSection');
        rs.innerHTML = '<div class="empty-state" style="padding:60px 20px">' +
            '<div style="font-size:48px;margin-bottom:16px">ğŸ“</div>' +
            '<div style="font-size:16px;font-weight:600;margin-bottom:8px">å•é¡Œã‚’æº–å‚™ä¸­ã§ã™</div>' +
            '<div style="font-size:13px">ã“ã®å°å˜å…ƒã®æ¼”ç¿’å•é¡Œã¯è¿‘æ—¥è¿½åŠ äºˆå®šã§ã™ã€‚<br>ãƒ•ãƒªãƒ¼æ¡ç‚¹ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ä»»æ„ã®å•é¡Œã®ç­”æ¡ˆã‚’æ¡ç‚¹ã§ãã¾ã™ã€‚</div>' +
            '</div>';
        rs.style.display = 'block';
        rs.classList.add('visible');
        return;
    }

    // Problem mode
    const problem = PROBLEM_DB[data.problemKey];
    const su = SUB_UNIT_DB[data.subUnitKey];
    const unit = UNIT_DB[data.unitKey];
    if (!problem || !su) return;

    currentProblemContext = {
        problemKey: data.problemKey,
        subUnitKey: data.subUnitKey,
        unitKey: data.unitKey,
        problemText: problem.problem_text,
        problemIndex: data.problemIndex,
        totalProblems: data.totalProblems,
    };

    titleEl.textContent = su.name;
    subEl.textContent = (unit ? unit.name + ' Â· ' : '') + 'å•é¡Œ ' + (data.problemIndex + 1) + ' / ' + data.totalProblems;

    // Problem display
    displayEl.style.display = 'block';
    const diffClass = problem.difficulty === 'åŸºæœ¬' ? 'basic' : problem.difficulty === 'æ¨™æº–' ? 'standard' : 'advanced';
    diffEl.innerHTML = '<span class="diff-badge ' + diffClass + '">' + escHtml(problem.difficulty) + '</span> ' + escHtml(problem.title);
    textEl.innerHTML = renderMixedText(problem.problem_text);

    // Hint
    if (problem.hint) {
        hintEl.style.display = 'block';
        hintEl.innerHTML = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹';
        hintEl.classList.remove('revealed');
        hintEl.dataset.hint = problem.hint;
    } else {
        hintEl.style.display = 'none';
    }

    // Back button
    document.getElementById('problemBackBtn').onclick = function() {
        navigateTo('unit', { unitKey: data.unitKey });
    };

    // Add problem navigation (prev/next) below results
    addProblemNav(data);
}

function revealHint(el) {
    if (el.classList.contains('revealed')) return;
    el.classList.add('revealed');
    el.innerHTML = 'ğŸ’¡ ' + renderMixedText(el.dataset.hint);
}

function addProblemNav(data) {
    // Remove existing nav if any
    const existing = document.getElementById('problemNav');
    if (existing) existing.remove();

    const problems = getProblemsForSubUnit(data.subUnitKey);
    if (problems.length <= 1) return;

    const nav = document.createElement('div');
    nav.id = 'problemNav';
    nav.style.cssText = 'display:flex;justify-content:space-between;padding:16px 20px;gap:12px;';

    const prevBtn = data.problemIndex > 0
        ? '<button class="nav-back" onclick="gotoProblem(' + (data.problemIndex - 1) + ',\'' + data.subUnitKey + '\',\'' + data.unitKey + '\')">â† å‰ã®å•é¡Œ</button>'
        : '<span></span>';
    const nextBtn = data.problemIndex < problems.length - 1
        ? '<button class="nav-back" onclick="gotoProblem(' + (data.problemIndex + 1) + ',\'' + data.subUnitKey + '\',\'' + data.unitKey + '\')" style="border-color:var(--accent);color:var(--accent)">æ¬¡ã®å•é¡Œ â†’</button>'
        : '<span></span>';

    nav.innerHTML = prevBtn + '<div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)">' +
        problems.map((_, i) => '<span style="width:8px;height:8px;border-radius:50%;background:' +
        (i === data.problemIndex ? 'var(--accent)' : 'var(--border)') + '"></span>').join('') +
        '</div>' + nextBtn;

    // Insert after problem display
    const display = document.getElementById('problemDisplay');
    display.parentNode.insertBefore(nav, display.nextSibling);
}

function gotoProblem(index, subUnitKey, unitKey) {
    const problems = getProblemsForSubUnit(subUnitKey);
    if (index < 0 || index >= problems.length) return;
    // Don't push to navHistory for prev/next
    renderProblemScreen({
        mode: 'problem',
        subUnitKey,
        unitKey,
        problemKey: problems[index].key,
        problemIndex: index,
        totalProblems: problems.length,
    });
}

// â•â•â• Modified analyze() with problem context â•â•â•
function getSystemPrompt() {
    if (currentProblemContext && currentProblemContext.problemText) {
        return SYSTEM_PROMPT + `\n\nã€å‡ºé¡Œã•ã‚ŒãŸå•é¡Œã€‘\n${currentProblemContext.problemText}\n\nã“ã®å•é¡Œã«å¯¾ã™ã‚‹æ‰‹æ›¸ãã®ç­”æ¡ˆã‚’æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚unit_keysã«ã¯ "${currentProblemContext.unitKey}" ã‚’å«ã‚ã¦ãã ã•ã„ã€‚`;
    }
    return SYSTEM_PROMPT;
}

// â•â•â• Init: Render Home Screen â•â•â•
renderHomeScreen();
</script>
</body>
</html>
