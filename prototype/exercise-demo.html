<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¼”ç¿’ãƒ‡ãƒ¢ â€” ä¸‰è§’æ¯”ãƒ¦ãƒ‹ãƒƒãƒˆ</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f4f5f9;
  --card: #ffffff;
  --border: #e2e4ea;
  --primary: #3b5fe5;
  --primary-light: #edf0ff;
  --primary-dark: #2a47b0;
  --success: #16a34a;
  --success-bg: #ecfdf5;
  --error: #dc2626;
  --error-bg: #fef2f2;
  --warning: #d97706;
  --warning-bg: #fffbeb;
  --text: #1a1d2e;
  --text-muted: #6b7280;
  --radius: 14px;
  --shadow: 0 1px 4px rgba(0,0,0,.06);
}
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.75;
  min-height: 100dvh;
  -webkit-text-size-adjust: 100%;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
.header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  padding: 18px 20px 14px;
}
.header h1 { font-size: 17px; font-weight: 700; letter-spacing: .02em; }
.header-sub { font-size: 12px; opacity: .8; margin-top: 3px; }

/* ===== é€²æ—ãƒãƒ¼ ===== */
.progress-section {
  background: #fff;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 90;
}
.progress-bar-track {
  flex: 1;
  height: 8px;
  background: #e8eaef;
  border-radius: 4px;
  overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--primary), #6366f1);
  border-radius: 4px;
  transition: width .4s ease;
}
.progress-text {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  min-width: 90px;
  text-align: right;
}

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ===== */
.filters {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  overflow-x: auto;
  background: #fff;
  border-bottom: 1px solid var(--border);
}
.filter-btn {
  flex-shrink: 0;
  padding: 7px 16px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  background: #fff;
  font-size: 13px;
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  transition: all .15s;
  color: var(--text-muted);
}
.filter-btn.active {
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}
.filter-btn:hover:not(.active) {
  border-color: var(--primary);
  color: var(--primary);
}

/* ===== ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ ===== */
.card-list {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 700px;
  margin: 0 auto;
  padding-bottom: 60px;
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  border: 1.5px solid var(--border);
  transition: border-color .2s;
}
.card.result-ok { border-color: var(--success); }
.card.result-ng { border-color: var(--error); }
.card.result-partial { border-color: var(--warning); }

.card-head {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  background: #fafafd;
}
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.badge-skill { background: #ede9fe; color: #6d28d9; }
.badge-type { background: #e0f2fe; color: #0369a1; }
.stars { color: #f59e0b; font-size: 12px; letter-spacing: .5px; margin-left: auto; }

.card-body { padding: 16px; }
.question-text {
  font-size: 15px;
  line-height: 1.85;
  margin-bottom: 16px;
}

/* ===== SELECTç³» å…±é€š ===== */
.choices { display: flex; flex-direction: column; gap: 8px; }
.choice-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all .15s;
  font-size: 14px;
  user-select: none;
}
.choice-item:hover { border-color: var(--primary); background: var(--primary-light); }
.choice-item input[type="radio"],
.choice-item input[type="checkbox"] {
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  accent-color: var(--primary);
}
.choice-label-text { font-weight: 600; margin-right: 2px; }
.choice-item.locked { cursor: default; pointer-events: none; }
.choice-item.is-correct { border-color: var(--success); background: var(--success-bg); }
.choice-item.is-wrong { border-color: var(--error); background: var(--error-bg); }
.choice-item.is-missed { border-color: var(--success); background: var(--success-bg); opacity: .7; }

/* ===== è§£ç­”ãƒœã‚¿ãƒ³ ===== */
.submit-row {
  display: flex;
  justify-content: flex-end;
  margin-top: 12px;
}
.btn {
  padding: 9px 22px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-primary:disabled { opacity: .45; cursor: not-allowed; }

/* ===== IMAGE / è¨˜è¿°ç³» ===== */
.image-area { text-align: center; }
.upload-zone {
  border: 2px dashed #cbd5e1;
  border-radius: 12px;
  padding: 28px 16px;
  background: #f8fafc;
  transition: border-color .2s, background .2s;
}
.upload-zone.has-file { border-style: solid; border-color: var(--primary); background: var(--primary-light); }
.upload-icon { font-size: 40px; margin-bottom: 8px; }
.upload-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 12px; }
.btn-camera, .btn-file {
  padding: 9px 18px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: #fff;
  font-size: 13px;
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  transition: all .15s;
}
.btn-camera:hover, .btn-file:hover { border-color: var(--primary); color: var(--primary); }
.upload-preview {
  margin-top: 12px;
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  object-fit: contain;
  display: none;
}
.ai-grading-box {
  display: none;
  margin-top: 14px;
  padding: 14px;
  border-radius: 10px;
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  text-align: left;
}
.ai-spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2.5px solid #93c5fd;
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  vertical-align: middle;
  margin-right: 6px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.cost-tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 6px;
  background: var(--warning-bg);
  color: var(--warning);
  font-size: 12px;
  font-weight: 600;
}
.rubric-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 13px;
}
.rubric-table th, .rubric-table td {
  padding: 7px 10px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.rubric-table th { background: #f1f5f9; font-weight: 600; }
.model-answer {
  margin-top: 10px;
  padding: 10px 14px;
  background: var(--success-bg);
  border-radius: 8px;
  border-left: 3px solid var(--success);
  font-size: 14px;
  line-height: 1.8;
}
.model-answer-label {
  font-weight: 600;
  font-size: 12px;
  color: var(--success);
  margin-bottom: 4px;
}

/* ===== æ­£èª¤ãƒãƒŠãƒ¼ ===== */
.result-banner {
  margin-top: 14px;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
}
.result-banner.ok { background: var(--success-bg); color: var(--success); }
.result-banner.ng { background: var(--error-bg); color: var(--error); }
.result-banner.partial { background: var(--warning-bg); color: var(--warning); }

/* ===== è§£èª¬ ===== */
.explanation-btn {
  display: none;
  margin-top: 12px;
  font-size: 13px;
  color: var(--primary);
  cursor: pointer;
  user-select: none;
  font-weight: 500;
}
.explanation-box {
  display: none;
  margin-top: 8px;
  padding: 12px 14px;
  background: #f8f8fd;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.85;
  border-left: 3px solid var(--primary);
}

/* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
@media (max-width: 480px) {
  .card-list { padding: 10px; gap: 12px; }
  .card-body { padding: 14px; }
  .question-text { font-size: 14px; }
  .upload-buttons { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<div class="header">
  <h1>æ¼”ç¿’ãƒ‡ãƒ¢ â€” ä¸‰è§’æ¯”ãƒ¦ãƒ‹ãƒƒãƒˆ</h1>
  <div class="header-sub">æ•°å­¦I ï¼ 3ç¨®é¡ã®UI ï¼ 11å•</div>
</div>

<div class="progress-section">
  <div class="progress-bar-track"><div class="progress-bar-fill" id="progressFill"></div></div>
  <div class="progress-text" id="progressText">0 / 11 è§£ç­”æ¸ˆã¿</div>
</div>

<div class="filters" id="filters">
  <button class="filter-btn active" data-filter="all">ã™ã¹ã¦ (11)</button>
  <button class="filter-btn" data-filter="select">ğŸ”˜ é¸æŠ (5)</button>
  <button class="filter-btn" data-filter="image">ğŸ“¸ è¨˜è¿° (6)</button>
</div>

<div class="card-list" id="cardList"></div>

<script>
// ============================================================
// ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
// ============================================================
const SKILLS = {
  trig_ratio_basic:   'ä¸‰è§’æ¯”ã®å®šç¾©',
  trig_ratio_special: 'ç‰¹æ®Šè§’ã®ä¸‰è§’æ¯”',
  trig_identity:      'ä¸‰è§’æ¯”ã®ç›¸äº’é–¢ä¿‚',
  trig_obtuse:        'éˆè§’ã®ä¸‰è§’æ¯”',
  trig_sine_rule:     'æ­£å¼¦å®šç†',
  trig_cosine_rule:   'ä½™å¼¦å®šç†',
  trig_area:          'ä¸‰è§’å½¢ã®é¢ç©'
};

const PATTERNS = {
  'trb__definition':     { skill: 'trig_ratio_basic' },
  'trb__find_ratio':     { skill: 'trig_ratio_basic' },
  'trs__value':          { skill: 'trig_ratio_special' },
  'tri__pythagorean':    { skill: 'trig_identity' },
  'tri__transform':      { skill: 'trig_identity' },
  'tro__unit_circle':    { skill: 'trig_obtuse' },
  'tro__find_angle':     { skill: 'trig_obtuse' },
  'tsr__circumradius':   { skill: 'trig_sine_rule' },
  'tcr__find_angle':     { skill: 'trig_cosine_rule' },
  'tar__two_sides_angle':{ skill: 'trig_area' }
};

// UIç¨®åˆ¥ãƒãƒƒãƒ”ãƒ³ã‚°: TEXTç³»ã¯ IMAGE æ‰±ã„
function uiType(tmpl) {
  if (tmpl === 'SELECT_BASIC') return 'select_basic';
  if (tmpl === 'SELECT_MULTI') return 'select_multi';
  return 'image'; // TEXT_NUMERIC, TEXT_EXPRESSION, IMAGE_PROCESS â†’ image
}
function uiCategory(tmpl) {
  return tmpl.startsWith('SELECT') ? 'select' : 'image';
}
function uiIcon(tmpl) {
  if (tmpl === 'SELECT_BASIC') return 'ğŸ”˜';
  if (tmpl === 'SELECT_MULTI') return 'â˜‘ï¸';
  return 'ğŸ“¸';
}
function uiLabel(tmpl) {
  if (tmpl === 'SELECT_BASIC') return '4æŠ';
  if (tmpl === 'SELECT_MULTI') return 'è¤‡æ•°é¸æŠ';
  return 'è¨˜è¿°ï¼ˆAIæ¡ç‚¹ï¼‰';
}
function skillName(patId) {
  const p = PATTERNS[patId];
  return p ? (SKILLS[p.skill] || '') : '';
}
function starsHTML(d) { return 'â˜…'.repeat(d) + 'â˜†'.repeat(5 - d); }

// ============================================================
// æ¼”ç¿’ãƒ‡ãƒ¼ã‚¿ (004_trigonometry_seed.sql ã‚ˆã‚Š)
// ============================================================
const EXERCISES = [
  // â”€â”€â”€ SELECT_BASIC â”€â”€â”€
  {
    id: 'drill_trb_def_01', pattern_id: 'trb__definition',
    input_template: 'SELECT_BASIC', difficulty: 1,
    question_text: 'ç›´è§’ä¸‰è§’å½¢ABCã§ $\\angle C = 90Â°$ã€$AB = 13$ã€$BC = 5$ã€$CA = 12$ ã®ã¨ãã€$\\sin A$ ã¯ã©ã‚Œã‹ã€‚',
    explanation: '$\\angle A$ ã®å¯¾è¾ºã¯ $BC = 5$ã€æ–œè¾ºã¯ $AB = 13$ã€‚\n\n$\\sin A = \\frac{\\text{å¯¾è¾º}}{\\text{æ–œè¾º}} = \\frac{5}{13}$',
    choices: [
      { label: 'A', expr: '\\frac{5}{13}',  correct: true },
      { label: 'B', expr: '\\frac{12}{13}', correct: false },
      { label: 'C', expr: '\\frac{5}{12}',  correct: false },
      { label: 'D', expr: '\\frac{13}{5}',  correct: false }
    ]
  },
  {
    id: 'drill_trs_val_01', pattern_id: 'trs__value',
    input_template: 'SELECT_BASIC', difficulty: 1,
    question_text: '$\\cos 60Â°$ ã®å€¤ã¯ã©ã‚Œã‹ã€‚',
    explanation: '30Â°-60Â°-90Â°ã®ç›´è§’ä¸‰è§’å½¢ã§ã€60Â°ã®éš£è¾ºã¯1ã€æ–œè¾ºã¯2ã€‚\n\n$\\cos 60Â° = \\frac{1}{2}$',
    choices: [
      { label: 'A', expr: '\\frac{1}{2}',        correct: true },
      { label: 'B', expr: '\\frac{\\sqrt{3}}{2}', correct: false },
      { label: 'C', expr: '1',                     correct: false },
      { label: 'D', expr: '\\frac{\\sqrt{2}}{2}', correct: false }
    ]
  },
  {
    id: 'drill_tcr_fa_01', pattern_id: 'tcr__find_angle',
    input_template: 'SELECT_BASIC', difficulty: 2,
    question_text: 'â–³ABCã§ $a = 5$ã€$b = 6$ã€$c = 7$ ã®ã¨ãã€$\\cos C$ ã¯ã©ã‚Œã‹ã€‚',
    explanation: '$\\cos C = \\frac{a^2 + b^2 - c^2}{2ab} = \\frac{25 + 36 - 49}{2 \\cdot 5 \\cdot 6} = \\frac{12}{60} = \\frac{1}{5}$',
    choices: [
      { label: 'A', expr: '\\frac{1}{5}',   correct: true },
      { label: 'B', expr: '\\frac{1}{7}',   correct: false },
      { label: 'C', expr: '\\frac{12}{70}', correct: false },
      { label: 'D', expr: '-\\frac{1}{5}',  correct: false }
    ]
  },

  // â”€â”€â”€ SELECT_MULTI â”€â”€â”€
  {
    id: 'drill_trs_val_03', pattern_id: 'trs__value',
    input_template: 'SELECT_MULTI', difficulty: 2,
    question_text: 'æ¬¡ã®ã†ã¡ã€å€¤ãŒ $\\frac{\\sqrt{3}}{2}$ ã§ã‚ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã¹ã€‚',
    explanation: '$\\sin 60Â° = \\frac{\\sqrt{3}}{2}$ã€$\\cos 30Â° = \\frac{\\sqrt{3}}{2}$ã€‚\n\n$\\sin 30Â° = \\frac{1}{2}$ã€$\\cos 45Â° = \\frac{\\sqrt{2}}{2}$ ãªã®ã§ã“ã‚Œã‚‰ã¯ä¸æ­£è§£ã€‚',
    choices: [
      { label: 'A', expr: '\\sin 60Â°', correct: true },
      { label: 'B', expr: '\\cos 30Â°', correct: true },
      { label: 'C', expr: '\\sin 30Â°', correct: false },
      { label: 'D', expr: '\\cos 45Â°', correct: false }
    ]
  },
  {
    id: 'drill_tro_uc_02', pattern_id: 'tro__unit_circle',
    input_template: 'SELECT_MULTI', difficulty: 2,
    question_text: '$0Â° < \\theta < 180Â°$ ã«ãŠã„ã¦ã€$\\theta$ ãŒéˆè§’ã®ã¨ãè² ã®å€¤ã‚’ã¨ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã¹ã€‚',
    explanation: 'éˆè§’ï¼ˆ$90Â° < \\theta < 180Â°$ï¼‰ã§ã¯ $\\cos\\theta < 0$ã€$\\tan\\theta < 0$ã€‚\n\n$\\sin\\theta$ ã¯ $0Â°$ã€œ$180Â°$ ã§å¸¸ã« $\\geqq 0$ã€‚\n\n$\\sin\\theta \\cos\\theta$ ã¯ æ­£Ã—è² ï¼è² ã€‚',
    choices: [
      { label: 'A', expr: '\\cos\\theta',              correct: true },
      { label: 'B', expr: '\\tan\\theta',              correct: true },
      { label: 'C', expr: '\\sin\\theta',              correct: false },
      { label: 'D', expr: '\\sin\\theta \\cos\\theta', correct: true }
    ]
  },

  // â”€â”€â”€ TEXT_NUMERIC â†’ IMAGE æ‰±ã„ â”€â”€â”€
  {
    id: 'drill_trb_def_02', pattern_id: 'trb__definition',
    input_template: 'TEXT_NUMERIC', difficulty: 2,
    question_text: 'ç›´è§’ä¸‰è§’å½¢ABCã§ $\\angle C = 90Â°$ã€$AB = 10$ã€$BC = 6$ã€$CA = 8$ ã®ã¨ãã€$\\tan A$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\angle A$ ã®å¯¾è¾ºã¯ $BC = 6$ã€éš£è¾ºã¯ $CA = 8$ã€‚\n\n$\\tan A = \\frac{6}{8} = \\frac{3}{4}$',
    model_answer: '$\\tan A = \\frac{3}{4}$'
  },
  {
    id: 'drill_tri_pyth_02', pattern_id: 'tri__pythagorean',
    input_template: 'TEXT_NUMERIC', difficulty: 2,
    question_text: '$0Â° < \\theta < 90Â°$ ã§ $\\sin \\theta = \\frac{1}{3}$ ã®ã¨ãã€$\\cos \\theta$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\cos^2\\theta = 1 - \\frac{1}{9} = \\frac{8}{9}$\n\n$\\cos\\theta > 0$ ã‚ˆã‚Š $\\cos\\theta = \\frac{2\\sqrt{2}}{3}$',
    model_answer: '$\\cos\\theta = \\frac{2\\sqrt{2}}{3}$'
  },

  // â”€â”€â”€ TEXT_EXPRESSION â†’ IMAGE æ‰±ã„ â”€â”€â”€
  {
    id: 'drill_tro_fa_02', pattern_id: 'tro__find_angle',
    input_template: 'TEXT_EXPRESSION', difficulty: 3,
    question_text: '$0Â° \\leqq \\theta \\leqq 180Â°$ ã§ $\\sin \\theta = \\frac{\\sqrt{3}}{2}$ ã‚’æº€ãŸã™ $\\theta$ ã‚’ã™ã¹ã¦æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\sin 60Â° = \\frac{\\sqrt{3}}{2}$ ã‚ˆã‚Š $\\theta = 60Â°$ã€‚\n\n$\\sin(180Â° - 60Â°) = \\sin 120Â° = \\frac{\\sqrt{3}}{2}$ ã‚ˆã‚Š $\\theta = 120Â°$ ã‚‚è§£ã€‚',
    model_answer: '$\\theta = 60Â°, \\; 120Â°$'
  },
  {
    id: 'drill_tcr_fa_02', pattern_id: 'tcr__find_angle',
    input_template: 'TEXT_EXPRESSION', difficulty: 3,
    question_text: 'â–³ABCã§ $a = 3$ã€$b = 4$ã€$c = 6$ ã®ã¨ãã€$\\cos C$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\cos C = \\frac{9 + 16 - 36}{2 \\cdot 3 \\cdot 4} = \\frac{-11}{24}$\n\n$\\cos C < 0$ ãªã®ã§ $C$ ã¯éˆè§’ã€‚',
    model_answer: '$\\cos C = -\\frac{11}{24}$'
  },

  // â”€â”€â”€ IMAGE_PROCESS â”€â”€â”€
  {
    id: 'drill_trb_fr_03', pattern_id: 'trb__find_ratio',
    input_template: 'IMAGE_PROCESS', difficulty: 4,
    question_text: 'ç›´è§’ä¸‰è§’å½¢ABCã§ $\\angle C = 90Â°$ã€$AB = \\sqrt{13}$ã€$BC = 2$ ã®ã¨ãã€$\\sin A$ã€$\\cos A$ã€$\\tan A$ ã®å€¤ã‚’ã™ã¹ã¦æ±‚ã‚ã‚ˆã€‚é€”ä¸­å¼ã‚‚æ›¸ãã“ã¨ã€‚',
    explanation: '$CA^2 = AB^2 - BC^2 = 13 - 4 = 9$ ã‚ˆã‚Š $CA = 3$ã€‚\n\n$\\sin A = \\frac{2}{\\sqrt{13}} = \\frac{2\\sqrt{13}}{13}$\n\n$\\cos A = \\frac{3}{\\sqrt{13}} = \\frac{3\\sqrt{13}}{13}$\n\n$\\tan A = \\frac{2}{3}$',
    grading_cost: 5,
    rubrics: [
      { criterion: 'ä¸‰å¹³æ–¹ã®å®šç†ã§CAã‚’æ±‚ã‚ã‚‹', points: 2, desc: 'CAÂ² = 13 - 4 = 9 â†’ CA = 3 ã®è¨ˆç®—ãŒæ­£ã—ã„' },
      { criterion: 'sinA, cosA, tanAã®ç«‹å¼',   points: 2, desc: 'å¯¾è¾º/æ–œè¾º, éš£è¾º/æ–œè¾º, å¯¾è¾º/éš£è¾ºã®å„ç«‹å¼ãŒæ­£ã—ã„' },
      { criterion: 'åˆ†æ¯ã®æœ‰ç†åŒ–',             points: 1, desc: 'âˆš13ã‚’å«ã‚€åˆ†æ•°ã‚’æœ‰ç†åŒ–ã—ã¦ã„ã‚‹' }
    ]
  },
  {
    id: 'drill_tri_tf_03', pattern_id: 'tri__transform',
    input_template: 'IMAGE_PROCESS', difficulty: 4,
    question_text: '$\\cos \\theta = \\frac{1}{4}$ï¼ˆ$0Â° < \\theta < 90Â°$ï¼‰ã®ã¨ãã€$\\frac{\\sin^2\\theta}{1 + \\cos\\theta}$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚é€”ä¸­å¼ã‚‚æ›¸ãã“ã¨ã€‚',
    explanation: '$\\sin^2\\theta = 1 - \\cos^2\\theta = (1 - \\cos\\theta)(1 + \\cos\\theta)$ ã¨å› æ•°åˆ†è§£ã€‚\n\n$\\frac{(1-\\cos\\theta)(1+\\cos\\theta)}{1+\\cos\\theta} = 1 - \\cos\\theta = 1 - \\frac{1}{4} = \\frac{3}{4}$',
    grading_cost: 5,
    rubrics: [
      { criterion: 'sinÂ²Î¸ã®å¤‰æ›',  points: 2, desc: 'sinÂ²Î¸ = 1 - cosÂ²Î¸ ã¾ãŸã¯ (1-cosÎ¸)(1+cosÎ¸) ã¸ã®å¤‰æ›ãŒæ­£ã—ã„' },
      { criterion: 'ç´„åˆ†',         points: 2, desc: '(1+cosÎ¸) ã§ç´„åˆ†ã™ã‚‹å‡¦ç†ãŒæ­£ã—ã„' },
      { criterion: 'æœ€çµ‚å€¤',       points: 1, desc: '3/4 ãŒæ­£ã—ã„' }
    ]
  }
];

const TOTAL = EXERCISES.length;
let answered = 0;

// ============================================================
// é€²æ—
// ============================================================
function updateProgress() {
  const pct = Math.round(answered / TOTAL * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = answered + ' / ' + TOTAL + ' è§£ç­”æ¸ˆã¿';
}

// ============================================================
// KaTeX ãƒ˜ãƒ«ãƒ‘ãƒ¼
// ============================================================
function renderMath(el) {
  if (typeof renderMathInElement === 'function') {
    renderMathInElement(el, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false }
      ],
      throwOnError: false
    });
  }
}

// ============================================================
// ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
// ============================================================
function buildCard(ex) {
  const type = uiType(ex.input_template);
  const cat = uiCategory(ex.input_template);
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.category = cat;
  card.dataset.id = ex.id;

  // --- ãƒ˜ãƒƒãƒ€ãƒ¼ ---
  card.innerHTML = `
    <div class="card-head">
      <span class="badge badge-skill">${skillName(ex.pattern_id)}</span>
      <span class="badge badge-type">${uiIcon(ex.input_template)} ${uiLabel(ex.input_template)}</span>
      <span class="stars">${starsHTML(ex.difficulty)}</span>
    </div>`;

  const body = document.createElement('div');
  body.className = 'card-body';

  // --- å•é¡Œæ–‡ ---
  const q = document.createElement('div');
  q.className = 'question-text';
  q.textContent = ex.question_text;
  body.appendChild(q);

  // --- UIæœ¬ä½“ ---
  let done = false;
  const markDone = () => { if (!done) { done = true; answered++; updateProgress(); } };

  if (type === 'select_basic') {
    body.appendChild(buildSelectBasic(ex, card, () => done, markDone));
  } else if (type === 'select_multi') {
    body.appendChild(buildSelectMulti(ex, card, () => done, markDone));
  } else {
    body.appendChild(buildImage(ex, card, () => done, markDone));
  }

  // --- è§£èª¬ãƒˆã‚°ãƒ« ---
  const togBtn = document.createElement('div');
  togBtn.className = 'explanation-btn';
  togBtn.textContent = 'â–¶ è§£èª¬ã‚’è¡¨ç¤º';
  body.appendChild(togBtn);

  const togBox = document.createElement('div');
  togBox.className = 'explanation-box';
  togBox.textContent = ex.explanation;
  body.appendChild(togBox);

  togBtn.addEventListener('click', () => {
    const open = togBox.style.display === 'block';
    togBox.style.display = open ? 'none' : 'block';
    togBtn.textContent = open ? 'â–¶ è§£èª¬ã‚’è¡¨ç¤º' : 'â–¼ è§£èª¬ã‚’éè¡¨ç¤º';
    if (!open) renderMath(togBox);
  });

  card.appendChild(body);
  return card;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SELECT_BASIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSelectBasic(ex, card, isDone, markDone) {
  const frag = document.createDocumentFragment();
  const list = document.createElement('div');
  list.className = 'choices';

  ex.choices.forEach((ch, i) => {
    const item = document.createElement('label');
    item.className = 'choice-item';
    item.innerHTML = `<input type="radio" name="r_${ex.id}" value="${i}">
      <span class="choice-label-text">${ch.label}.</span>
      <span>$${ch.expr}$</span>`;
    list.appendChild(item);
  });
  frag.appendChild(list);

  const row = document.createElement('div');
  row.className = 'submit-row';
  const btn = document.createElement('button');
  btn.className = 'btn btn-primary';
  btn.textContent = 'è§£ç­”ã™ã‚‹';
  btn.disabled = true;
  row.appendChild(btn);
  frag.appendChild(row);

  // ãƒ©ã‚¸ã‚ªé¸æŠã§æœ‰åŠ¹åŒ–
  list.addEventListener('change', () => { if (!isDone()) btn.disabled = false; });

  btn.addEventListener('click', () => {
    if (isDone()) return;
    const sel = list.querySelector('input:checked');
    if (!sel) return;
    const idx = parseInt(sel.value);
    markDone();
    btn.disabled = true;

    list.querySelectorAll('.choice-item').forEach((el, j) => {
      el.classList.add('locked');
      if (ex.choices[j].correct) el.classList.add('is-correct');
      if (j === idx && !ex.choices[j].correct) el.classList.add('is-wrong');
    });

    const ok = ex.choices[idx].correct;
    showBanner(card, ok ? 'ok' : 'ng', ok ? 'â­• æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£');
    showExplBtn(card);
  });

  return frag;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SELECT_MULTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSelectMulti(ex, card, isDone, markDone) {
  const frag = document.createDocumentFragment();
  const list = document.createElement('div');
  list.className = 'choices';

  ex.choices.forEach((ch, i) => {
    const item = document.createElement('label');
    item.className = 'choice-item';
    item.innerHTML = `<input type="checkbox" value="${i}">
      <span class="choice-label-text">${ch.label}.</span>
      <span>$${ch.expr}$</span>`;
    list.appendChild(item);
  });
  frag.appendChild(list);

  const row = document.createElement('div');
  row.className = 'submit-row';
  const btn = document.createElement('button');
  btn.className = 'btn btn-primary';
  btn.textContent = 'è§£ç­”ã™ã‚‹';
  row.appendChild(btn);
  frag.appendChild(row);

  btn.addEventListener('click', () => {
    if (isDone()) return;
    markDone();
    btn.disabled = true;

    const checked = new Set();
    list.querySelectorAll('input:checked').forEach(inp => checked.add(parseInt(inp.value)));
    const correctSet = new Set();
    ex.choices.forEach((ch, i) => { if (ch.correct) correctSet.add(i); });

    let allOk = true;
    let anyOk = false;
    list.querySelectorAll('.choice-item').forEach((el, j) => {
      el.classList.add('locked');
      el.querySelector('input').disabled = true;
      if (ex.choices[j].correct) {
        el.classList.add(checked.has(j) ? 'is-correct' : 'is-missed');
        if (checked.has(j)) anyOk = true; else allOk = false;
      }
      if (checked.has(j) && !ex.choices[j].correct) {
        el.classList.add('is-wrong');
        allOk = false;
      }
    });
    const perfect = allOk && checked.size === correctSet.size;
    if (perfect) {
      showBanner(card, 'ok', 'â­• æ­£è§£ï¼');
    } else if (anyOk) {
      showBanner(card, 'partial', 'â–³ éƒ¨åˆ†æ­£è§£');
    } else {
      showBanner(card, 'ng', 'âŒ ä¸æ­£è§£');
    }
    showExplBtn(card);
  });

  return frag;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IMAGEï¼ˆè¨˜è¿°ç³»å…±é€šï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildImage(ex, card, isDone, markDone) {
  const wrap = document.createElement('div');
  wrap.className = 'image-area';

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¾ãƒ¼ãƒ³
  const zone = document.createElement('div');
  zone.className = 'upload-zone';
  zone.id = 'zone_' + ex.id;
  zone.innerHTML = `
    <div class="upload-icon">ğŸ“</div>
    <div style="font-size:14px;color:var(--text-muted)">è§£ç­”ã‚’æ’®å½±ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã§æå‡º</div>
    <div class="upload-buttons">
      <button class="btn-camera" id="cam_${ex.id}">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
      <button class="btn-file" id="fil_${ex.id}">ğŸ“ ç”»åƒã‚’é¸æŠ</button>
    </div>
    <input type="file" accept="image/*" capture="environment" id="finp_cam_${ex.id}" style="display:none">
    <input type="file" accept="image/*" id="finp_fil_${ex.id}" style="display:none">
    <img class="upload-preview" id="prev_${ex.id}">`;
  wrap.appendChild(zone);

  // æ¡ç‚¹ãƒœã‚¿ãƒ³
  const submitRow = document.createElement('div');
  submitRow.className = 'submit-row';
  submitRow.style.display = 'none';
  submitRow.id = 'srow_' + ex.id;
  const sbtn = document.createElement('button');
  sbtn.className = 'btn btn-primary';
  sbtn.textContent = 'æ¡ç‚¹ã™ã‚‹';
  sbtn.id = 'sbtn_' + ex.id;
  submitRow.appendChild(sbtn);
  wrap.appendChild(submitRow);

  // AIæ¡ç‚¹ãƒœãƒƒã‚¯ã‚¹
  const aiBox = document.createElement('div');
  aiBox.className = 'ai-grading-box';
  aiBox.id = 'ai_' + ex.id;
  wrap.appendChild(aiBox);

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  setTimeout(() => {
    const camBtn = document.getElementById('cam_' + ex.id);
    const filBtn = document.getElementById('fil_' + ex.id);
    const camInp = document.getElementById('finp_cam_' + ex.id);
    const filInp = document.getElementById('finp_fil_' + ex.id);
    const preview = document.getElementById('prev_' + ex.id);
    const srow = document.getElementById('srow_' + ex.id);

    if (camBtn) camBtn.addEventListener('click', () => camInp.click());
    if (filBtn) filBtn.addEventListener('click', () => filInp.click());

    function handleFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        zone.classList.add('has-file');
        srow.style.display = 'flex';
      };
      reader.readAsDataURL(file);
    }
    if (camInp) camInp.addEventListener('change', e => handleFile(e.target.files[0]));
    if (filInp) filInp.addEventListener('change', e => handleFile(e.target.files[0]));

    // æ¡ç‚¹
    const sBtn = document.getElementById('sbtn_' + ex.id);
    if (sBtn) sBtn.addEventListener('click', () => {
      if (isDone()) return;
      markDone();
      sBtn.disabled = true;

      const box = document.getElementById('ai_' + ex.id);
      box.style.display = 'block';
      box.innerHTML = '<span class="ai-spinner"></span> AIæ¡ç‚¹ä¸­â€¦';

      setTimeout(() => {
        const cost = ex.grading_cost || 5;
        let html = `<div style="margin-bottom:10px"><span class="cost-tag">æ¨å®šã‚³ã‚¹ãƒˆ: Â¥${cost}</span></div>`;
        html += '<div style="font-size:13px;color:var(--text-muted);margin-bottom:10px">ã“ã®å•é¡Œã¯AIæ¡ç‚¹ãŒå¿…è¦ã§ã™ã€‚ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚æ¨¡ç¯„è§£ç­”ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>';

        // æ¨¡ç¯„è§£ç­”
        const ma = ex.model_answer || ex.explanation;
        html += `<div class="model-answer"><div class="model-answer-label">æ¨¡ç¯„è§£ç­”</div><div>${ma}</div></div>`;

        // ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯
        if (ex.rubrics && ex.rubrics.length) {
          const total = ex.rubrics.reduce((s, r) => s + r.points, 0);
          html += '<table class="rubric-table"><thead><tr><th>è©•ä¾¡åŸºæº–</th><th>é…ç‚¹</th><th>è©³ç´°</th></tr></thead><tbody>';
          ex.rubrics.forEach(r => {
            html += `<tr><td>${r.criterion}</td><td style="text-align:center">${r.points}ç‚¹</td><td>${r.desc}</td></tr>`;
          });
          html += `<tr style="font-weight:600"><td>åˆè¨ˆ</td><td style="text-align:center">${total}ç‚¹</td><td></td></tr>`;
          html += '</tbody></table>';
        }

        box.innerHTML = html;
        renderMath(box);
        showExplBtn(card);
      }, 1200);
    });
  }, 0);

  return wrap;
}

// ============================================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼
// ============================================================
function showBanner(card, type, msg) {
  const body = card.querySelector('.card-body');
  const b = document.createElement('div');
  b.className = 'result-banner ' + type;
  b.textContent = msg;
  body.appendChild(b);
  card.classList.add(type === 'ok' ? 'result-ok' : type === 'partial' ? 'result-partial' : 'result-ng');
}
function showExplBtn(card) {
  const btn = card.querySelector('.explanation-btn');
  if (btn) btn.style.display = 'block';
}

// ============================================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// ============================================================
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const f = btn.dataset.filter;
    document.querySelectorAll('.card').forEach(c => {
      c.style.display = (f === 'all' || c.dataset.category === f) ? '' : 'none';
    });
  });
});

// ============================================================
// åˆæœŸåŒ–
// ============================================================
function init() {
  const list = document.getElementById('cardList');
  EXERCISES.forEach(ex => list.appendChild(buildCard(ex)));
  renderMath(list);
  updateProgress();
}

// auto-render èª­ã¿è¾¼ã¿å¾…ã¡
(function wait() {
  if (typeof renderMathInElement === 'function') return init();
  let n = 0;
  const iv = setInterval(() => { if (typeof renderMathInElement === 'function' || ++n > 50) { clearInterval(iv); init(); } }, 100);
})();
</script>
</body>
</html>
