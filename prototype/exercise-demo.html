<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¼”ç¿’ãƒ‡ãƒ¢ â€” input_templateåˆ¥ UI</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f5f5f8; --card: #fff; --border: #e0e0e6;
  --primary: #4f46e5; --primary-light: #eef2ff;
  --success: #16a34a; --success-bg: #f0fdf4;
  --error: #dc2626; --error-bg: #fef2f2;
  --warning: #d97706; --warning-bg: #fffbeb;
  --text: #1e1e2e; --text-muted: #6b7280;
  --radius: 12px;
}
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg); color: var(--text);
  line-height: 1.7; padding: 0; min-height: 100dvh;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  background: var(--primary); color: #fff;
  padding: 16px 20px; position: sticky; top: 0; z-index: 100;
}
.header h1 { font-size: 18px; font-weight: 700; }
.header p { font-size: 12px; opacity: .8; margin-top: 2px; }

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
.filters {
  display: flex; gap: 8px; padding: 12px 16px;
  overflow-x: auto; background: #fff;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 60px; z-index: 90;
}
.filter-btn {
  flex-shrink: 0; padding: 6px 14px; border-radius: 20px;
  border: 1.5px solid var(--border); background: #fff;
  font-size: 13px; font-family: inherit; cursor: pointer;
  transition: all .15s;
}
.filter-btn.active {
  background: var(--primary); color: #fff;
  border-color: var(--primary);
}
.filter-btn:hover:not(.active) { border-color: var(--primary); color: var(--primary); }

/* ã‚¹ã‚³ã‚¢ãƒãƒ¼ */
.score-bar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 16px; background: var(--primary-light);
  font-size: 13px; font-weight: 500;
}

/* ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ */
.card-list { padding: 16px; display: flex; flex-direction: column; gap: 16px; max-width: 720px; margin: 0 auto; }

/* æ¼”ç¿’ã‚«ãƒ¼ãƒ‰ */
.card {
  background: var(--card); border-radius: var(--radius);
  box-shadow: 0 1px 3px rgba(0,0,0,.06); overflow: hidden;
  border: 1px solid var(--border);
}
.card.correct { border-color: var(--success); }
.card.incorrect { border-color: var(--error); }

.card-head {
  display: flex; flex-wrap: wrap; align-items: center; gap: 8px;
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  background: #fafafe;
}
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 10px; border-radius: 12px;
  font-size: 11px; font-weight: 500;
}
.badge-skill { background: #ede9fe; color: #5b21b6; }
.badge-template { background: #e0f2fe; color: #0369a1; }
.stars { color: var(--warning); font-size: 13px; letter-spacing: 1px; }

.card-body { padding: 16px; }
.question-text { font-size: 15px; margin-bottom: 16px; line-height: 1.8; }

/* é¸æŠè‚¢ */
.choices { display: flex; flex-direction: column; gap: 8px; }
.choice-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border: 1.5px solid var(--border);
  border-radius: 8px; cursor: pointer; transition: all .15s;
  font-size: 14px;
}
.choice-item:hover { border-color: var(--primary); background: var(--primary-light); }
.choice-item input { flex-shrink: 0; accent-color: var(--primary); }
.choice-item.selected { border-color: var(--primary); background: var(--primary-light); }
.choice-item.correct-choice { border-color: var(--success); background: var(--success-bg); }
.choice-item.incorrect-choice { border-color: var(--error); background: var(--error-bg); }

/* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
.text-input-area { display: flex; gap: 8px; align-items: stretch; }
.text-input-area input {
  flex: 1; padding: 10px 14px; border: 1.5px solid var(--border);
  border-radius: 8px; font-size: 15px; font-family: inherit;
  outline: none; transition: border-color .15s;
}
.text-input-area input:focus { border-color: var(--primary); }

/* ãƒœã‚¿ãƒ³ */
.btn {
  padding: 8px 20px; border-radius: 8px; border: none;
  font-size: 14px; font-family: inherit; font-weight: 500;
  cursor: pointer; transition: all .15s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { opacity: .9; }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; }

/* IMAGE_PROCESS */
.image-upload-area {
  border: 2px dashed var(--border); border-radius: 8px;
  padding: 24px; text-align: center; color: var(--text-muted);
}
.image-upload-area .icon { font-size: 36px; margin-bottom: 8px; }
.image-upload-area p { font-size: 13px; }
.cost-notice {
  margin-top: 12px; padding: 10px 14px;
  background: var(--warning-bg); border-radius: 8px;
  font-size: 13px; color: var(--warning); display: none;
}

/* çµæœ */
.result-area { margin-top: 12px; padding: 12px 14px; border-radius: 8px; font-size: 14px; }
.result-correct { background: var(--success-bg); color: var(--success); }
.result-incorrect { background: var(--error-bg); color: var(--error); }
.result-partial { background: var(--warning-bg); color: var(--warning); }

/* è§£èª¬ */
.explanation-toggle {
  margin-top: 12px; font-size: 13px; color: var(--primary);
  cursor: pointer; display: none; user-select: none;
}
.explanation-content {
  display: none; margin-top: 8px; padding: 12px 14px;
  background: #f8f8fc; border-radius: 8px; font-size: 14px;
  line-height: 1.8; border-left: 3px solid var(--primary);
}

/* ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ */
.rubric-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
.rubric-table th, .rubric-table td { padding: 6px 10px; text-align: left; border-bottom: 1px solid var(--border); }
.rubric-table th { background: #f8f8fc; font-weight: 500; }

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 480px) {
  .card-list { padding: 10px; gap: 12px; }
  .card-body { padding: 12px; }
  .question-text { font-size: 14px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>æ¼”ç¿’ãƒ‡ãƒ¢ â€” input_templateåˆ¥ UI</h1>
  <p>ä¸‰è§’æ¯”ãƒ¦ãƒ‹ãƒƒãƒˆã‹ã‚‰13å•ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—</p>
</div>

<div class="filters" id="filters">
  <button class="filter-btn active" data-filter="all">å…¨è¡¨ç¤º (13)</button>
  <button class="filter-btn" data-filter="SELECT">ğŸ”˜ SELECT (5)</button>
  <button class="filter-btn" data-filter="TEXT">âœï¸ TEXT (6)</button>
  <button class="filter-btn" data-filter="IMAGE">ğŸ“¸ IMAGE (2)</button>
</div>

<div class="score-bar" id="scoreBar">
  <span>æ­£è§£: <strong id="correctCount">0</strong> / <strong id="totalAnswered">0</strong></span>
  <span id="accuracyText">æ­£ç­”ç‡: â€”</span>
</div>

<div class="card-list" id="cardList"></div>

<script>
// ============================================================
// ãƒ‡ãƒ¼ã‚¿ï¼ˆ004_trigonometry_seed.sql ã‹ã‚‰ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
// ============================================================

const SKILLS = {
  trig_ratio_basic:   { display_name: 'ä¸‰è§’æ¯”ã®å®šç¾©',     unit: 'ä¸‰è§’æ¯”' },
  trig_ratio_special: { display_name: 'ç‰¹æ®Šè§’ã®ä¸‰è§’æ¯”',   unit: 'ä¸‰è§’æ¯”' },
  trig_identity:      { display_name: 'ä¸‰è§’æ¯”ã®ç›¸äº’é–¢ä¿‚', unit: 'ä¸‰è§’æ¯”' },
  trig_obtuse:        { display_name: 'éˆè§’ã®ä¸‰è§’æ¯”',     unit: 'ä¸‰è§’æ¯”' },
  trig_sine_rule:     { display_name: 'æ­£å¼¦å®šç†',         unit: 'ä¸‰è§’æ¯”' },
  trig_cosine_rule:   { display_name: 'ä½™å¼¦å®šç†',         unit: 'ä¸‰è§’æ¯”' },
  trig_area:          { display_name: 'ä¸‰è§’å½¢ã®é¢ç©',     unit: 'ä¸‰è§’æ¯”' }
};

const PATTERNS = {
  trb__definition:     { skill_id: 'trig_ratio_basic',   display_name: 'ç›´è§’ä¸‰è§’å½¢ã‹ã‚‰sin/cos/tanã‚’æ±‚ã‚ã‚‹' },
  trb__find_ratio:     { skill_id: 'trig_ratio_basic',   display_name: 'ä¸‰å¹³æ–¹ã®å®šç†ã¨ã®çµ„åˆã›' },
  trs__value:          { skill_id: 'trig_ratio_special', display_name: '30Â°/45Â°/60Â°ã®ä¸‰è§’æ¯”ã®å€¤' },
  tri__pythagorean:    { skill_id: 'trig_identity',      display_name: 'ãƒ”ã‚¿ã‚´ãƒ©ã‚¹æ’ç­‰å¼' },
  tri__transform:      { skill_id: 'trig_identity',      display_name: 'å¼ã®å€¤ã‚’æ±‚ã‚ã‚‹' },
  tro__unit_circle:    { skill_id: 'trig_obtuse',        display_name: 'å˜ä½å††ã¨sin/cos/tanã®ç¬¦å·' },
  tro__find_angle:     { skill_id: 'trig_obtuse',        display_name: 'sinÎ¸/cosÎ¸ã®å€¤ã‹ã‚‰è§’åº¦ã‚’æ±‚ã‚ã‚‹' },
  tsr__circumradius:   { skill_id: 'trig_sine_rule',     display_name: 'å¤–æ¥å††ã®åŠå¾„' },
  tcr__find_angle:     { skill_id: 'trig_cosine_rule',   display_name: 'è§’ã®å¤§ãã•ã‚’æ±‚ã‚ã‚‹' },
  tar__two_sides_angle:{ skill_id: 'trig_area',          display_name: '2è¾ºã¨æŒŸè§’ã‹ã‚‰é¢ç©' }
};

const TEMPLATE_INFO = {
  SELECT_BASIC:    { icon: 'ğŸ”˜', label: '4æŠå˜ä¸€',       category: 'SELECT' },
  SELECT_MULTI:    { icon: 'â˜‘ï¸', label: 'è¤‡æ•°é¸æŠ',      category: 'SELECT' },
  TEXT_NUMERIC:    { icon: 'ğŸ”¢', label: 'æ•°å€¤å…¥åŠ›',       category: 'TEXT' },
  TEXT_EXPRESSION: { icon: 'âœï¸', label: 'æ•°å¼å…¥åŠ›',      category: 'TEXT' },
  IMAGE_PROCESS:   { icon: 'ğŸ“¸', label: 'æ‰‹æ›¸ãé€”ä¸­å¼',   category: 'IMAGE' }
};

const EXERCISES = [
  // === SELECT_BASIC (3) ===
  {
    id: 'drill_trb_def_01', pattern_id: 'trb__definition',
    input_template: 'SELECT_BASIC', difficulty: 1,
    question_text: 'ç›´è§’ä¸‰è§’å½¢ABCã§ $\\angle C = 90Â°$ã€$AB = 13$ã€$BC = 5$ã€$CA = 12$ ã®ã¨ãã€$\\sin A$ ã¯ã©ã‚Œã‹ã€‚',
    explanation: '$\\angle A$ ã®å¯¾è¾ºã¯ $BC = 5$ã€æ–œè¾ºã¯ $AB = 13$ã€‚$\\sin A = \\frac{\\text{å¯¾è¾º}}{\\text{æ–œè¾º}} = \\frac{5}{13}$ã€‚',
    choices: [
      { label: 'A', expr: '\\frac{5}{13}',  is_correct: true,  note: null },
      { label: 'B', expr: '\\frac{12}{13}', is_correct: false, note: 'cosAã¨æ··åŒ: éš£è¾º/æ–œè¾ºã‚’è¨ˆç®—' },
      { label: 'C', expr: '\\frac{5}{12}',  is_correct: false, note: 'tanAã¨æ··åŒ: å¯¾è¾º/éš£è¾ºã‚’è¨ˆç®—' },
      { label: 'D', expr: '\\frac{13}{5}',  is_correct: false, note: 'é€†æ•°: æ–œè¾º/å¯¾è¾ºã‚’è¨ˆç®—' }
    ]
  },
  {
    id: 'drill_trs_val_01', pattern_id: 'trs__value',
    input_template: 'SELECT_BASIC', difficulty: 1,
    question_text: '$\\cos 60Â°$ ã®å€¤ã¯ã©ã‚Œã‹ã€‚',
    explanation: '30Â°-60Â°-90Â°ã®ç›´è§’ä¸‰è§’å½¢ã§ã€60Â°ã®éš£è¾ºã¯1ã€æ–œè¾ºã¯2ã€‚$\\cos 60Â° = \\frac{1}{2}$ã€‚',
    choices: [
      { label: 'A', expr: '\\frac{1}{2}',         is_correct: true,  note: null },
      { label: 'B', expr: '\\frac{\\sqrt{3}}{2}',  is_correct: false, note: 'sin60Â°ã¨æ··åŒ' },
      { label: 'C', expr: '1',                      is_correct: false, note: 'cos0Â°ã¨æ··åŒ' },
      { label: 'D', expr: '\\frac{\\sqrt{2}}{2}',  is_correct: false, note: 'cos45Â°ã¨æ··åŒ' }
    ]
  },
  {
    id: 'drill_tcr_fa_01', pattern_id: 'tcr__find_angle',
    input_template: 'SELECT_BASIC', difficulty: 2,
    question_text: 'â–³ABCã§ $a = 5$ã€$b = 6$ã€$c = 7$ ã®ã¨ãã€$\\cos C$ ã¯ã©ã‚Œã‹ã€‚',
    explanation: '$\\cos C = \\frac{a^2 + b^2 - c^2}{2ab} = \\frac{25 + 36 - 49}{2 \\cdot 5 \\cdot 6} = \\frac{12}{60} = \\frac{1}{5}$ã€‚',
    choices: [
      { label: 'A', expr: '\\frac{1}{5}',   is_correct: true,  note: null },
      { label: 'B', expr: '\\frac{1}{7}',   is_correct: false, note: 'åˆ†æ¯ã‚’2Â·5Â·7ã¨èª¤ã£ã¦è¨ˆç®—' },
      { label: 'C', expr: '\\frac{12}{70}',  is_correct: false, note: 'åˆ†æ¯2abã®aã‚’7ã¨å–ã‚Šé•ãˆ' },
      { label: 'D', expr: '-\\frac{1}{5}',   is_correct: false, note: 'åˆ†å­ã®ç¬¦å·ãƒŸã‚¹' }
    ]
  },

  // === SELECT_MULTI (2) ===
  {
    id: 'drill_trs_val_03', pattern_id: 'trs__value',
    input_template: 'SELECT_MULTI', difficulty: 2,
    question_text: 'æ¬¡ã®ã†ã¡ã€å€¤ãŒ $\\frac{\\sqrt{3}}{2}$ ã§ã‚ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã¹ã€‚',
    explanation: '$\\sin 60Â° = \\frac{\\sqrt{3}}{2}$ã€$\\cos 30Â° = \\frac{\\sqrt{3}}{2}$ã€‚$\\sin 30Â° = \\frac{1}{2}$ã€$\\cos 45Â° = \\frac{\\sqrt{2}}{2}$ã€‚',
    choices: [
      { label: 'A', expr: '\\sin 60Â°',  is_correct: true,  note: null },
      { label: 'B', expr: '\\cos 30Â°',  is_correct: true,  note: null },
      { label: 'C', expr: '\\sin 30Â°',  is_correct: false, note: 'å€¤ã¯1/2' },
      { label: 'D', expr: '\\cos 45Â°',  is_correct: false, note: 'å€¤ã¯âˆš2/2' }
    ]
  },
  {
    id: 'drill_tro_uc_02', pattern_id: 'tro__unit_circle',
    input_template: 'SELECT_MULTI', difficulty: 2,
    question_text: '$0Â° < \\theta < 180Â°$ ã«ãŠã„ã¦ã€$\\theta$ ãŒéˆè§’ã®ã¨ãè² ã®å€¤ã‚’ã¨ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã¹ã€‚',
    explanation: 'éˆè§’ï¼ˆ$90Â° < \\theta < 180Â°$ï¼‰ã®ã¨ã $\\cos\\theta < 0$ã€$\\tan\\theta < 0$ã€‚$\\sin\\theta > 0$ ã¯å¸¸ã«æ­£ã€‚$\\sin\\theta \\cos\\theta$ ã¯æ­£Ã—è² ï¼è² ã€‚',
    choices: [
      { label: 'A', expr: '\\cos\\theta',            is_correct: true,  note: null },
      { label: 'B', expr: '\\tan\\theta',            is_correct: true,  note: null },
      { label: 'C', expr: '\\sin\\theta',            is_correct: false, note: '0Â°ã€œ180Â°ã§ã¯sinÎ¸ã¯å¸¸ã«0ä»¥ä¸Š' },
      { label: 'D', expr: '\\sin\\theta \\cos\\theta', is_correct: true,  note: null }
    ]
  },

  // === TEXT_NUMERIC (3) ===
  {
    id: 'drill_trb_def_02', pattern_id: 'trb__definition',
    input_template: 'TEXT_NUMERIC', difficulty: 2,
    question_text: 'ç›´è§’ä¸‰è§’å½¢ABCã§ $\\angle C = 90Â°$ã€$AB = 10$ã€$BC = 6$ã€$CA = 8$ ã®ã¨ãã€$\\tan A$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\angle A$ ã®å¯¾è¾ºã¯ $BC = 6$ã€éš£è¾ºã¯ $CA = 8$ã€‚$\\tan A = \\frac{6}{8} = \\frac{3}{4}$ã€‚',
    answers: [
      { expr: '\\frac{3}{4}', normalized: '3/4', is_primary: true },
      { expr: '0.75',         normalized: '0.75', is_primary: false },
      { expr: '\\frac{6}{8}', normalized: '3/4',  is_primary: false }
    ]
  },
  {
    id: 'drill_tri_pyth_02', pattern_id: 'tri__pythagorean',
    input_template: 'TEXT_NUMERIC', difficulty: 2,
    question_text: '$0Â° < \\theta < 90Â°$ ã§ $\\sin \\theta = \\frac{1}{3}$ ã®ã¨ãã€$\\cos \\theta$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\cos^2\\theta = 1 - \\frac{1}{9} = \\frac{8}{9}$ã€‚$\\cos\\theta > 0$ ã‚ˆã‚Š $\\cos\\theta = \\frac{2\\sqrt{2}}{3}$ã€‚',
    answers: [
      { expr: '\\frac{2\\sqrt{2}}{3}', normalized: '2sqrt(2)/3', is_primary: true },
      { expr: '\\frac{\\sqrt{8}}{3}',  normalized: '2sqrt(2)/3', is_primary: false }
    ]
  },
  {
    id: 'drill_tsr_cr_02', pattern_id: 'tsr__circumradius',
    input_template: 'TEXT_NUMERIC', difficulty: 2,
    question_text: 'â–³ABCã§ $c = 5$ã€$C = 90Â°$ ã®ã¨ãã€å¤–æ¥å††ã®åŠå¾„ $R$ ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$2R = \\frac{5}{\\sin 90Â°} = \\frac{5}{1} = 5$ã€‚$R = \\frac{5}{2}$ã€‚',
    answers: [
      { expr: '\\frac{5}{2}', normalized: '5/2', is_primary: true },
      { expr: '2.5',          normalized: '2.5', is_primary: false }
    ]
  },

  // === TEXT_EXPRESSION (3) ===
  {
    id: 'drill_tro_fa_02', pattern_id: 'tro__find_angle',
    input_template: 'TEXT_EXPRESSION', difficulty: 3,
    question_text: '$0Â° \\leqq \\theta \\leqq 180Â°$ ã§ $\\sin \\theta = \\frac{\\sqrt{3}}{2}$ ã‚’æº€ãŸã™ $\\theta$ ã‚’ã™ã¹ã¦æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\sin 60Â° = \\frac{\\sqrt{3}}{2}$ ã‚ˆã‚Š $\\theta = 60Â°$ã€‚$\\sin(180Â°-60Â°) = \\sin 120Â° = \\frac{\\sqrt{3}}{2}$ ã‚ˆã‚Š $\\theta = 120Â°$ ã‚‚è§£ã€‚',
    answers: [
      { expr: '\\theta = 60Â°,\\; 120Â°', normalized: 'Î¸=60Â°,120Â°', is_primary: true },
      { expr: '60Â°, 120Â°',              normalized: 'Î¸=60Â°,120Â°', is_primary: false }
    ]
  },
  {
    id: 'drill_tcr_fa_02', pattern_id: 'tcr__find_angle',
    input_template: 'TEXT_EXPRESSION', difficulty: 3,
    question_text: 'â–³ABCã§ $a = 3$ã€$b = 4$ã€$c = 6$ ã®ã¨ãã€$C$ ã®å¤§ãã•ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$\\cos C = \\frac{9 + 16 - 36}{2 \\cdot 3 \\cdot 4} = \\frac{-11}{24}$ã€‚$\\cos C < 0$ ãªã®ã§ $C$ ã¯éˆè§’ã€‚$C = \\arccos\\left(-\\frac{11}{24}\\right)$ã€‚',
    answers: [
      { expr: '\\cos C = -\\frac{11}{24}', normalized: 'cosC=-11/24', is_primary: true }
    ]
  },
  {
    id: 'drill_tar_tsa_02', pattern_id: 'tar__two_sides_angle',
    input_template: 'TEXT_EXPRESSION', difficulty: 2,
    question_text: 'â–³ABCã§ $b = 10$ã€$c = 6$ã€$A = 90Â°$ ã®ã¨ãã€é¢ç© $S$ ã‚’æ±‚ã‚ã‚ˆã€‚',
    explanation: '$S = \\frac{1}{2} \\cdot 10 \\cdot 6 \\cdot \\sin 90Â° = \\frac{1}{2} \\cdot 60 \\cdot 1 = 30$ã€‚',
    answers: [
      { expr: '30', normalized: '30', is_primary: true }
    ]
  },

  // === IMAGE_PROCESS (2) ===
  {
    id: 'drill_trb_fr_03', pattern_id: 'trb__find_ratio',
    input_template: 'IMAGE_PROCESS', difficulty: 4,
    question_text: 'ç›´è§’ä¸‰è§’å½¢ABCã§ $\\angle C = 90Â°$ã€$AB = \\sqrt{13}$ã€$BC = 2$ ã®ã¨ãã€$\\sin A$ã€$\\cos A$ã€$\\tan A$ ã®å€¤ã‚’ã™ã¹ã¦æ±‚ã‚ã‚ˆã€‚é€”ä¸­å¼ã‚‚æ›¸ãã“ã¨ã€‚',
    explanation: '$CA^2 = AB^2 - BC^2 = 13 - 4 = 9$ ã‚ˆã‚Š $CA = 3$ã€‚$\\sin A = \\frac{2}{\\sqrt{13}} = \\frac{2\\sqrt{13}}{13}$ã€$\\cos A = \\frac{3}{\\sqrt{13}} = \\frac{3\\sqrt{13}}{13}$ã€$\\tan A = \\frac{2}{3}$ã€‚',
    grading_cost: 5,
    rubrics: [
      { criterion: 'ä¸‰å¹³æ–¹ã®å®šç†ã§CAã‚’æ±‚ã‚ã‚‹',  max_points: 2, description: 'CAÂ² = 13 - 4 = 9 â†’ CA = 3 ã®è¨ˆç®—ãŒæ­£ã—ã„' },
      { criterion: 'sinA, cosA, tanAã®ç«‹å¼',    max_points: 2, description: 'å¯¾è¾º/æ–œè¾º, éš£è¾º/æ–œè¾º, å¯¾è¾º/éš£è¾ºã®å„ç«‹å¼ãŒæ­£ã—ã„' },
      { criterion: 'åˆ†æ¯ã®æœ‰ç†åŒ–',              max_points: 1, description: 'âˆš13ã‚’å«ã‚€åˆ†æ•°ã‚’æœ‰ç†åŒ–ã—ã¦ã„ã‚‹ï¼ˆæœ‰ç†åŒ–ãªã—ã§ã‚‚éƒ¨åˆ†ç‚¹ï¼‰' }
    ]
  },
  {
    id: 'drill_tri_tf_03', pattern_id: 'tri__transform',
    input_template: 'IMAGE_PROCESS', difficulty: 4,
    question_text: '$\\cos \\theta = \\frac{1}{4}$ï¼ˆ$0Â° < \\theta < 90Â°$ï¼‰ã®ã¨ãã€$\\frac{\\sin^2\\theta}{1 + \\cos\\theta}$ ã®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚é€”ä¸­å¼ã‚‚æ›¸ãã“ã¨ã€‚',
    explanation: '$\\sin^2\\theta = 1 - \\cos^2\\theta = (1 - \\cos\\theta)(1 + \\cos\\theta)$ ã¨å› æ•°åˆ†è§£ã€‚$\\frac{(1-\\cos\\theta)(1+\\cos\\theta)}{1+\\cos\\theta} = 1 - \\cos\\theta = 1 - \\frac{1}{4} = \\frac{3}{4}$ã€‚',
    grading_cost: 5,
    rubrics: [
      { criterion: 'sinÂ²Î¸ã®å¤‰æ›',   max_points: 2, description: 'sinÂ²Î¸ = 1 - cosÂ²Î¸ ã¾ãŸã¯ (1-cosÎ¸)(1+cosÎ¸) ã¸ã®å¤‰æ›ãŒæ­£ã—ã„' },
      { criterion: 'ç´„åˆ†',          max_points: 2, description: '(1+cosÎ¸) ã§ç´„åˆ†ã™ã‚‹å‡¦ç†ãŒæ­£ã—ã„' },
      { criterion: 'æœ€çµ‚å€¤',        max_points: 1, description: '3/4 ãŒæ­£ã—ã„' }
    ]
  }
];


// ============================================================
// æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯
// ============================================================

/** å…¨è§’â†’åŠè§’ã€ç©ºç™½é™¤å» */
function normalizeBase(s) {
  return s
    .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
    .replace(/\s+/g, '')
    .replace(/ã€€/g, '');
}

/** TEXT_NUMERIC æ­£è¦åŒ– */
function normalizeNumeric(input) {
  let s = normalizeBase(input);
  // âˆš â†’ sqrt
  s = s.replace(/âˆš/g, 'sqrt');
  // åˆ†æ•° a/b â†’ å°æ•°ã«å¤‰æ›ã—ã¦æ¯”è¼ƒã‚‚ã™ã‚‹ãŒã€æ–‡å­—åˆ—ã‚‚ã‚­ãƒ¼ãƒ—
  return s;
}

/** åˆ†æ•°ã‚’è©•ä¾¡ï¼ˆa/b â†’ æ•°å€¤ï¼‰ */
function evalFraction(s) {
  // "3/4" ã®ã‚ˆã†ãªå˜ç´”åˆ†æ•°
  const m = s.match(/^(-?\d+)\/(\d+)$/);
  if (m) return parseInt(m[1]) / parseInt(m[2]);
  const n = parseFloat(s);
  if (!isNaN(n)) return n;
  return null;
}

/** TEXT_NUMERIC æ¯”è¼ƒ */
function checkNumeric(input, answers) {
  const norm = normalizeNumeric(input);
  // ã¾ãšæ­£è¦åŒ–æ–‡å­—åˆ—ã§æ¯”è¼ƒ
  for (const ans of answers) {
    if (norm === ans.normalized) return true;
    if (normalizeNumeric(ans.normalized) === norm) return true;
  }
  // æ•°å€¤æ¯”è¼ƒï¼ˆåˆ†æ•°ãƒ»å°æ•°ï¼‰
  const inputVal = evalFraction(norm);
  if (inputVal !== null) {
    for (const ans of answers) {
      const ansVal = evalFraction(ans.normalized);
      if (ansVal !== null && Math.abs(inputVal - ansVal) < 0.0001) return true;
    }
  }
  return false;
}

/** TEXT_EXPRESSION æ­£è¦åŒ– */
function normalizeExpression(input) {
  let s = normalizeBase(input);
  // Î¸ ã®å„ç¨®è¡¨è¨˜çµ±ä¸€
  s = s.replace(/theta/gi, 'Î¸');
  // Â°è¡¨è¨˜
  s = s.replace(/åº¦/g, 'Â°');
  s = s.replace(/deg/gi, 'Â°');
  // = ã®å‰å¾Œã‚¹ãƒšãƒ¼ã‚¹ã¯æ—¢ã«é™¤å»æ¸ˆã¿
  // cos, sin ç­‰ã®å¤§æ–‡å­—å°æ–‡å­—çµ±ä¸€
  s = s.toLowerCase();
  // ã‚«ãƒ³ãƒå¾Œã®ã‚¹ãƒšãƒ¼ã‚¹æ—¢ã«é™¤å»
  return s;
}

/** TEXT_EXPRESSION æ¯”è¼ƒ */
function checkExpression(input, answers) {
  const norm = normalizeExpression(input);
  for (const ans of answers) {
    const ansNorm = normalizeExpression(ans.normalized);
    if (norm === ansNorm) return true;
    // Î¸= ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—æ¯”è¼ƒ
    const withoutPrefix = norm.replace(/^[a-zÎ¸]+=/, '');
    const ansWithout = ansNorm.replace(/^[a-zÎ¸]+=/, '');
    if (withoutPrefix === ansWithout) return true;
    // é †åºç„¡è¦–ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã‚’ã‚½ãƒ¼ãƒˆæ¯”è¼ƒï¼‰
    const sortParts = str => str.replace(/^[a-zÎ¸]+=/, '').split(',').sort().join(',');
    if (sortParts(norm) === sortParts(ansNorm)) return true;
  }
  return false;
}


// ============================================================
// ã‚¹ã‚³ã‚¢ç®¡ç†
// ============================================================
let scoreCorrect = 0;
let scoreTotal = 0;

function updateScore(isCorrect) {
  scoreTotal++;
  if (isCorrect) scoreCorrect++;
  document.getElementById('correctCount').textContent = scoreCorrect;
  document.getElementById('totalAnswered').textContent = scoreTotal;
  const pct = scoreTotal > 0 ? Math.round(scoreCorrect / scoreTotal * 100) : 0;
  document.getElementById('accuracyText').textContent = `æ­£ç­”ç‡: ${pct}%`;
}


// ============================================================
// UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// ============================================================

function getSkillName(patternId) {
  const pat = PATTERNS[patternId];
  if (!pat) return '';
  return SKILLS[pat.skill_id]?.display_name || '';
}

function starsHtml(difficulty) {
  return 'â˜…'.repeat(difficulty) + 'â˜†'.repeat(5 - difficulty);
}

function renderKaTeX(el) {
  if (typeof renderMathInElement === 'function') {
    renderMathInElement(el, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false }
      ],
      throwOnError: false
    });
  }
}

function buildCard(ex) {
  const tmpl = TEMPLATE_INFO[ex.input_template];
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.template = ex.input_template;
  card.dataset.category = tmpl.category;
  card.dataset.id = ex.id;

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  const head = document.createElement('div');
  head.className = 'card-head';
  head.innerHTML = `
    <span class="badge badge-skill">${getSkillName(ex.pattern_id)}</span>
    <span class="badge badge-template">${tmpl.icon} ${tmpl.label}</span>
    <span class="stars">${starsHtml(ex.difficulty)}</span>
  `;
  card.appendChild(head);

  // ãƒœãƒ‡ã‚£
  const body = document.createElement('div');
  body.className = 'card-body';

  // å•é¡Œæ–‡
  const q = document.createElement('div');
  q.className = 'question-text';
  q.textContent = ex.question_text;
  body.appendChild(q);

  // input_template åˆ¥ UI
  let answered = false;
  if (ex.input_template === 'SELECT_BASIC') {
    body.appendChild(buildSelectBasic(ex, card, () => answered, v => answered = v));
  } else if (ex.input_template === 'SELECT_MULTI') {
    body.appendChild(buildSelectMulti(ex, card, () => answered, v => answered = v));
  } else if (ex.input_template === 'TEXT_NUMERIC') {
    body.appendChild(buildTextNumeric(ex, card, () => answered, v => answered = v));
  } else if (ex.input_template === 'TEXT_EXPRESSION') {
    body.appendChild(buildTextExpression(ex, card, () => answered, v => answered = v));
  } else if (ex.input_template === 'IMAGE_PROCESS') {
    body.appendChild(buildImageProcess(ex, card));
  }

  // è§£èª¬ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
  const toggleEl = document.createElement('div');
  toggleEl.className = 'explanation-toggle';
  toggleEl.textContent = 'â–¶ è§£èª¬ã‚’è¡¨ç¤º';
  toggleEl.addEventListener('click', () => {
    const content = toggleEl.nextElementSibling;
    const open = content.style.display === 'block';
    content.style.display = open ? 'none' : 'block';
    toggleEl.textContent = open ? 'â–¶ è§£èª¬ã‚’è¡¨ç¤º' : 'â–¼ è§£èª¬ã‚’éè¡¨ç¤º';
  });
  body.appendChild(toggleEl);

  const explEl = document.createElement('div');
  explEl.className = 'explanation-content';
  explEl.textContent = ex.explanation;
  body.appendChild(explEl);

  card.appendChild(body);
  return card;
}

// --- SELECT_BASIC ---
function buildSelectBasic(ex, card, getAnswered, setAnswered) {
  const wrap = document.createElement('div');
  wrap.className = 'choices';
  ex.choices.forEach((ch, i) => {
    const item = document.createElement('label');
    item.className = 'choice-item';
    item.innerHTML = `<input type="radio" name="radio_${ex.id}" value="${i}">
      <span class="choice-label"><strong>${ch.label}.</strong></span>
      <span class="choice-expr">$${ch.expr}$</span>`;
    item.addEventListener('click', () => {
      if (getAnswered()) return;
      setAnswered(true);
      const isCorrect = ch.is_correct;
      // å…¨é¸æŠè‚¢ã®çŠ¶æ…‹è¡¨ç¤º
      wrap.querySelectorAll('.choice-item').forEach((el, j) => {
        el.style.cursor = 'default';
        if (ex.choices[j].is_correct) el.classList.add('correct-choice');
        if (j === i && !isCorrect) el.classList.add('incorrect-choice');
      });
      showResult(card, isCorrect);
      updateScore(isCorrect);
    });
    wrap.appendChild(item);
  });
  return wrap;
}

// --- SELECT_MULTI ---
function buildSelectMulti(ex, card, getAnswered, setAnswered) {
  const wrap = document.createElement('div');
  const choicesDiv = document.createElement('div');
  choicesDiv.className = 'choices';
  ex.choices.forEach((ch, i) => {
    const item = document.createElement('label');
    item.className = 'choice-item';
    item.innerHTML = `<input type="checkbox" value="${i}">
      <span class="choice-label"><strong>${ch.label}.</strong></span>
      <span class="choice-expr">$${ch.expr}$</span>`;
    item.querySelector('input').addEventListener('change', () => {
      if (getAnswered()) return;
      item.classList.toggle('selected', item.querySelector('input').checked);
    });
    choicesDiv.appendChild(item);
  });
  wrap.appendChild(choicesDiv);

  const btn = document.createElement('button');
  btn.className = 'btn btn-primary';
  btn.textContent = 'è§£ç­”ã™ã‚‹';
  btn.style.marginTop = '10px';
  btn.addEventListener('click', () => {
    if (getAnswered()) return;
    setAnswered(true);
    btn.disabled = true;
    const selected = new Set();
    choicesDiv.querySelectorAll('input:checked').forEach(inp => selected.add(parseInt(inp.value)));
    const correctSet = new Set();
    ex.choices.forEach((ch, i) => { if (ch.is_correct) correctSet.add(i); });

    let allCorrect = true;
    let anyCorrect = false;
    choicesDiv.querySelectorAll('.choice-item').forEach((el, j) => {
      el.style.cursor = 'default';
      el.querySelector('input').disabled = true;
      if (ex.choices[j].is_correct) {
        el.classList.add('correct-choice');
        if (selected.has(j)) anyCorrect = true;
        else allCorrect = false;
      }
      if (selected.has(j) && !ex.choices[j].is_correct) {
        el.classList.add('incorrect-choice');
        allCorrect = false;
      }
    });

    if (allCorrect && selected.size === correctSet.size) {
      showResult(card, true);
      updateScore(true);
    } else if (anyCorrect) {
      showResult(card, 'partial');
      updateScore(false);
    } else {
      showResult(card, false);
      updateScore(false);
    }
  });
  wrap.appendChild(btn);
  return wrap;
}

// --- TEXT_NUMERIC ---
function buildTextNumeric(ex, card, getAnswered, setAnswered) {
  const wrap = document.createElement('div');
  const row = document.createElement('div');
  row.className = 'text-input-area';
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'ä¾‹: 3/4, 0.75, 2sqrt(2)/3';
  input.setAttribute('inputmode', 'text');
  const btn = document.createElement('button');
  btn.className = 'btn btn-primary';
  btn.textContent = 'æ¡ç‚¹';
  row.appendChild(input);
  row.appendChild(btn);
  wrap.appendChild(row);

  // æ¨¡ç¯„è§£ç­”è¡¨ç¤ºç”¨
  const modelAnswer = ex.answers.find(a => a.is_primary);

  function submit() {
    if (getAnswered() || !input.value.trim()) return;
    setAnswered(true);
    btn.disabled = true;
    input.readOnly = true;
    const correct = checkNumeric(input.value.trim(), ex.answers);
    input.style.borderColor = correct ? 'var(--success)' : 'var(--error)';
    if (!correct && modelAnswer) {
      showResult(card, false, `æ­£è§£: $${modelAnswer.expr}$`);
    } else {
      showResult(card, correct);
    }
    updateScore(correct);
  }
  btn.addEventListener('click', submit);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') submit(); });
  return wrap;
}

// --- TEXT_EXPRESSION ---
function buildTextExpression(ex, card, getAnswered, setAnswered) {
  const wrap = document.createElement('div');
  const row = document.createElement('div');
  row.className = 'text-input-area';
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'ä¾‹: Î¸=60Â°,120Â° / cosC=-11/24 / 30';
  const btn = document.createElement('button');
  btn.className = 'btn btn-primary';
  btn.textContent = 'æ¡ç‚¹';
  row.appendChild(input);
  row.appendChild(btn);
  wrap.appendChild(row);

  const modelAnswer = ex.answers.find(a => a.is_primary);

  function submit() {
    if (getAnswered() || !input.value.trim()) return;
    setAnswered(true);
    btn.disabled = true;
    input.readOnly = true;
    const correct = checkExpression(input.value.trim(), ex.answers);
    input.style.borderColor = correct ? 'var(--success)' : 'var(--error)';
    if (!correct && modelAnswer) {
      showResult(card, false, `æ­£è§£: $${modelAnswer.expr}$`);
    } else {
      showResult(card, correct);
    }
    updateScore(correct);
  }
  btn.addEventListener('click', submit);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') submit(); });
  return wrap;
}

// --- IMAGE_PROCESS ---
function buildImageProcess(ex, card) {
  const wrap = document.createElement('div');

  const upload = document.createElement('div');
  upload.className = 'image-upload-area';
  upload.innerHTML = `
    <div class="icon">ğŸ“¸</div>
    <p>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ or ã‚«ãƒ¡ãƒ©ã§æ’®å½±</p>
    <input type="file" accept="image/*" capture="environment" style="display:none" id="file_${ex.id}">
    <button class="btn btn-primary" style="margin-top:10px" onclick="document.getElementById('file_${ex.id}').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
  `;
  wrap.appendChild(upload);

  const cost = document.createElement('div');
  cost.className = 'cost-notice';
  cost.innerHTML = `ğŸ“¸ ã“ã®å•é¡Œã¯AIæ¡ç‚¹ãŒå¿…è¦ã§ã™ï¼ˆã‚³ã‚¹ãƒˆ: Â¥${ex.grading_cost || 5}/å›ï¼‰<br>ç¾åœ¨ã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€æ¨¡ç¯„è§£ç­”ã¨ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`;
  wrap.appendChild(cost);

  // ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯è¡¨ç¤º
  const rubricWrap = document.createElement('div');
  rubricWrap.style.display = 'none';
  rubricWrap.style.marginTop = '12px';

  if (ex.rubrics && ex.rubrics.length > 0) {
    const label = document.createElement('div');
    label.style.fontSize = '13px';
    label.style.fontWeight = '500';
    label.style.marginBottom = '6px';
    label.textContent = 'æ¡ç‚¹ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯:';
    rubricWrap.appendChild(label);

    const table = document.createElement('table');
    table.className = 'rubric-table';
    table.innerHTML = `<thead><tr><th>è©•ä¾¡åŸºæº–</th><th>é…ç‚¹</th><th>è©³ç´°</th></tr></thead>`;
    const tbody = document.createElement('tbody');
    let totalPoints = 0;
    ex.rubrics.forEach(r => {
      totalPoints += r.max_points;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.criterion}</td><td>${r.max_points}ç‚¹</td><td>${r.description}</td>`;
      tbody.appendChild(tr);
    });
    const tfootTr = document.createElement('tr');
    tfootTr.innerHTML = `<td><strong>åˆè¨ˆ</strong></td><td><strong>${totalPoints}ç‚¹</strong></td><td></td>`;
    tbody.appendChild(tfootTr);
    table.appendChild(tbody);
    rubricWrap.appendChild(table);
  }
  wrap.appendChild(rubricWrap);

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œ
  const fileInput = upload.querySelector('input[type=file]');
  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      upload.innerHTML = `<div class="icon">âœ…</div><p>ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ</p><p style="font-size:12px;color:var(--text-muted)">${fileInput.files[0].name}</p>`;
      cost.style.display = 'block';
      rubricWrap.style.display = 'block';
      // è§£èª¬ã‚‚è¡¨ç¤º
      const toggle = card.querySelector('.explanation-toggle');
      if (toggle) {
        toggle.style.display = 'block';
        toggle.textContent = 'â–¼ è§£èª¬ã‚’éè¡¨ç¤º';
        toggle.nextElementSibling.style.display = 'block';
        renderKaTeX(toggle.nextElementSibling);
      }
    }
  });

  return wrap;
}

// --- çµæœè¡¨ç¤º ---
function showResult(card, result, extra) {
  const body = card.querySelector('.card-body');
  const div = document.createElement('div');
  div.className = 'result-area';
  if (result === true) {
    div.className += ' result-correct';
    div.innerHTML = 'â­• æ­£è§£ï¼';
    card.classList.add('correct');
  } else if (result === 'partial') {
    div.className += ' result-partial';
    div.innerHTML = 'â–³ éƒ¨åˆ†æ­£è§£ï¼ˆä¸€éƒ¨åˆã£ã¦ã„ã¾ã™ãŒã€éä¸è¶³ãŒã‚ã‚Šã¾ã™ï¼‰';
    card.classList.add('incorrect');
  } else {
    div.className += ' result-incorrect';
    div.innerHTML = 'âŒ ä¸æ­£è§£' + (extra ? `ã€€${extra}` : '');
    card.classList.add('incorrect');
  }
  body.appendChild(div);
  renderKaTeX(div);

  // è§£èª¬ã‚’è¡¨ç¤ºå¯èƒ½ã«ã™ã‚‹
  const toggle = card.querySelector('.explanation-toggle');
  if (toggle) {
    toggle.style.display = 'block';
  }
}


// ============================================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// ============================================================
function applyFilter(category) {
  document.querySelectorAll('.card').forEach(card => {
    if (category === 'all') {
      card.style.display = '';
    } else {
      card.style.display = card.dataset.category === category ? '' : 'none';
    }
  });
}


// ============================================================
// åˆæœŸåŒ–
// ============================================================
function init() {
  const list = document.getElementById('cardList');
  EXERCISES.forEach(ex => {
    const card = buildCard(ex);
    list.appendChild(card);
  });

  // KaTeX ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (typeof renderMathInElement === 'function') {
    renderKaTeX(list);
  } else {
    // auto-render ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆ
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => renderKaTeX(list), 200);
    });
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilter(btn.dataset.filter);
    });
  });
}

// auto-render ã®ãƒ­ãƒ¼ãƒ‰å¾…ã¡
function waitForKaTeX(cb) {
  if (typeof renderMathInElement === 'function') { cb(); return; }
  let attempts = 0;
  const iv = setInterval(() => {
    attempts++;
    if (typeof renderMathInElement === 'function' || attempts > 50) {
      clearInterval(iv);
      cb();
    }
  }, 100);
}

waitForKaTeX(init);
</script>
</body>
</html>
